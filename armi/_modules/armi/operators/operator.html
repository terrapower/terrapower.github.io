<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>armi.operators.operator &mdash; ARMI 0.2.9 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme_fixes.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/armiicon_16x16.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #233C5B" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ARMI
              <img src="../../../_static/armiicon_24x24.ico" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.2.9
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index.html">User Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../.apidocs/modules.html">API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #233C5B" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ARMI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../armi.html">armi</a></li>
          <li class="breadcrumb-item"><a href="../operators.html">armi.operators</a></li>
      <li class="breadcrumb-item active">armi.operators.operator</li>
  <li class="wy-breadcrumbs-aside">
    
  </li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for armi.operators.operator</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2019 TerraPower, LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The standard ARMI operator.</span>

<span class="sd">This builds and maintains the interface stack and loops through it for a</span>
<span class="sd">certain number of cycles with a certain number of timenodes per cycle.</span>

<span class="sd">This is analogous to a real reactor operating over some period of time,</span>
<span class="sd">often from initial startup, through the various cycles, and out to</span>
<span class="sd">the end of plant life.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">interfaces</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">runLog</span>
<span class="kn">from</span> <span class="nn">armi.bookkeeping</span> <span class="kn">import</span> <span class="n">memoryProfiler</span>
<span class="kn">from</span> <span class="nn">armi.bookkeeping.report</span> <span class="kn">import</span> <span class="n">reportingUtils</span>
<span class="kn">from</span> <span class="nn">armi.operators</span> <span class="kn">import</span> <span class="n">settingsValidation</span>
<span class="kn">from</span> <span class="nn">armi.operators.runTypes</span> <span class="kn">import</span> <span class="n">RunTypes</span>
<span class="kn">from</span> <span class="nn">armi.physics.fuelCycle.settings</span> <span class="kn">import</span> <span class="n">CONF_SHUFFLE_LOGIC</span>
<span class="kn">from</span> <span class="nn">armi.physics.neutronics.globalFlux.globalFluxInterface</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GlobalFluxInterfaceUsingExecuters</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">armi.settings.fwSettings.globalSettings</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONF_TIGHT_COUPLING</span><span class="p">,</span>
    <span class="n">CONF_TIGHT_COUPLING_MAX_ITERS</span><span class="p">,</span>
    <span class="n">CONF_CYCLES_SKIP_TIGHT_COUPLING_INTERACTION</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">armi.utils</span> <span class="kn">import</span> <span class="n">codeTiming</span>
<span class="kn">from</span> <span class="nn">armi.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">pathTools</span><span class="p">,</span>
    <span class="n">getPowerFractions</span><span class="p">,</span>
    <span class="n">getAvailabilityFactors</span><span class="p">,</span>
    <span class="n">getStepLengths</span><span class="p">,</span>
    <span class="n">getCycleLengths</span><span class="p">,</span>
    <span class="n">getBurnSteps</span><span class="p">,</span>
    <span class="n">getMaxBurnSteps</span><span class="p">,</span>
    <span class="n">getCycleNames</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="Operator"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator">[docs]</a><span class="k">class</span> <span class="nc">Operator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orchestrates an ARMI run, building all the pieces, looping through the interfaces, and manipulating the reactor.</span>

<span class="sd">    This Standard Operator loops over a user-input number of cycles, each with a</span>
<span class="sd">    user-input number of subcycles (called time nodes). It calls a series of</span>
<span class="sd">    interaction hooks on each of the</span>
<span class="sd">    :py:class:`~armi.interfaces.Interface` in the Interface Stack.</span>

<span class="sd">    .. figure:: /.static/armi_general_flowchart.png</span>
<span class="sd">        :align: center</span>

<span class="sd">    **Figure 1.** The computational flow of the interface hooks in a Standard Operator</span>

<span class="sd">    .. note:: The :doc:`/developer/guide` has some additional narrative on this topic.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    cs : CaseSettings object</span>
<span class="sd">            Global settings that define the run.</span>

<span class="sd">    cycleNames : list of str</span>
<span class="sd">        The name of each cycle. Cycles without a name are `None`.</span>

<span class="sd">    stepLengths : list of list of float</span>
<span class="sd">        A two-tiered list, where primary indices correspond to cycle and</span>
<span class="sd">        secondary indices correspond to the length of each intra-cycle step (in days).</span>

<span class="sd">    cycleLengths : list of float</span>
<span class="sd">        The duration of each individual cycle in a run (in days). This is the entire cycle,</span>
<span class="sd">        from startup to startup and includes outage time.</span>

<span class="sd">    burnSteps : list of int</span>
<span class="sd">        The number of sub-cycles in each cycle.</span>

<span class="sd">    availabilityFactors : list of float</span>
<span class="sd">        The fraction of time in a cycle that the plant is producing power. Note that capacity factor</span>
<span class="sd">        is always less than or equal to this, depending on the power fraction achieved during each cycle.</span>
<span class="sd">        Note that this is not a two-tiered list like stepLengths or powerFractions,</span>
<span class="sd">        because each cycle can have only one availabilityFactor.</span>

<span class="sd">    powerFractions : list of list of float</span>
<span class="sd">        A two-tiered list, where primary indices correspond to cycles and secondary</span>
<span class="sd">        indices correspond to the fraction of full rated capacity that the plant achieves</span>
<span class="sd">        during that step of the cycle.</span>
<span class="sd">        Zero power fraction can indicate decay-only cycles.</span>

<span class="sd">    interfaces : list</span>
<span class="sd">        The Interface objects that will operate upon the reactor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">inspector</span> <span class="o">=</span> <span class="n">settingsValidation</span><span class="o">.</span><span class="n">Inspector</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for operator.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cs : CaseSettings object</span>
<span class="sd">            Global settings that define the run.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        OSError</span>
<span class="sd">            If unable to create the FAST_PATH directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">startLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">codeTiming</span><span class="o">.</span><span class="n">getMasterTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restartData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadedRestartData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cycleNames</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepLengths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cycleLengths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_burnSteps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxBurnSteps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_powerFractions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_availabilityFactors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convergenceSummary</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create the welcome headers for the case (case, input, machine, and some basic reactor information)</span>
        <span class="n">reportingUtils</span><span class="o">.</span><span class="n">writeWelcomeHeaders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initFastPath</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">burnSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burnSteps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_burnSteps</span> <span class="o">=</span> <span class="n">getBurnSteps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burnSteps</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;nCycles&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># it is possible for there to be one cycle with zero burn up,</span>
                <span class="c1"># in which case burnSteps is an empty list</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_checkReactorCycleAttrs</span><span class="p">({</span><span class="s2">&quot;burnSteps&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burnSteps</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burnSteps</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxBurnSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxBurnSteps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maxBurnSteps</span> <span class="o">=</span> <span class="n">getMaxBurnSteps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxBurnSteps</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stepLengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepLengths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stepLengths</span> <span class="o">=</span> <span class="n">getStepLengths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepLengths</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;nCycles&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># it is possible for there to be one cycle with zero burn up,</span>
                <span class="c1"># in which case stepLengths is an empty list</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_checkReactorCycleAttrs</span><span class="p">({</span><span class="s2">&quot;Step lengths&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepLengths</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_consistentPowerFractionsAndStepLengths</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepLengths</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cycleLengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycleLengths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycleLengths</span> <span class="o">=</span> <span class="n">getCycleLengths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkReactorCycleAttrs</span><span class="p">({</span><span class="s2">&quot;cycleLengths&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycleLengths</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycleLengths</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">powerFractions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powerFractions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_powerFractions</span> <span class="o">=</span> <span class="n">getPowerFractions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkReactorCycleAttrs</span><span class="p">({</span><span class="s2">&quot;powerFractions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powerFractions</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_consistentPowerFractionsAndStepLengths</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powerFractions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">availabilityFactors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_availabilityFactors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_availabilityFactors</span> <span class="o">=</span> <span class="n">getAvailabilityFactors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkReactorCycleAttrs</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;availabilityFactors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_availabilityFactors</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_availabilityFactors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cycleNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycleNames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycleNames</span> <span class="o">=</span> <span class="n">getCycleNames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkReactorCycleAttrs</span><span class="p">({</span><span class="s2">&quot;Cycle names&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycleNames</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycleNames</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_initFastPath</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the FAST_PATH directory for fast local operations.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The FAST_PATH was once created at import-time in order to support modules</span>
<span class="sd">        that use FAST_PATH without operators (e.g. Database). However, we decided</span>
<span class="sd">        to leave FAST_PATH as the CWD in INTERACTIVE mode, so this should not</span>
<span class="sd">        be a problem anymore, and we can safely move FAST_PATH creation</span>
<span class="sd">        back into the Operator.</span>

<span class="sd">        If the operator is being used interactively (e.g. at a prompt) we will still</span>
<span class="sd">        use a temporary local fast path (in case the user is working on a slow network path).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">activateLocalFastPath</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">getFastPath</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># If FAST_PATH exists already that generally should be an error because</span>
            <span class="c1"># different processes will be stepping on each other.</span>
            <span class="c1"># The exception to this rule is in cases that instantiate multiple operators in one</span>
            <span class="c1"># process (e.g. unit tests that loadTestReactor). Since the FAST_PATH is set at</span>
            <span class="c1"># import, these will use the same path multiple times. We pass here for that reason.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">getFastPath</span><span class="p">()):</span>
                <span class="c1"># if it actually doesn&#39;t exist, that&#39;s an actual error. Raise</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_checkReactorCycleAttrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrsDict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check that the list has nCycles number of elements.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">attrsDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;nCycles&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The `</span><span class="si">{}</span><span class="s2">` setting did not have a length consistent with the number of cycles.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Expected </span><span class="si">{}</span><span class="s2"> value(s), but only had </span><span class="si">{}</span><span class="s2"> defined.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Current input: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;nCycles&quot;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="n">param</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_consistentPowerFractionsAndStepLengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the internally-resolved _powerFractions and _stepLengths have</span>
<span class="sd">        consistent shapes, if they both exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powerFractions</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepLengths</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cycleIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_powerFractions</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_powerFractions</span><span class="p">[</span><span class="n">cycleIdx</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stepLengths</span><span class="p">[</span><span class="n">cycleIdx</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;The number of entries in lists for subcycle power &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;fractions and sub-steps are inconsistent in cycle </span><span class="si">{</span><span class="n">cycleIdx</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">atEOL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether we are approaching EOL.</span>

<span class="sd">        For the standard operator, this will return true when the current cycle</span>
<span class="sd">        is the last cycle (cs[&quot;nCycles&quot;] - 1). Other operators may need to</span>
<span class="sd">        impose different logic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;nCycles&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

<div class="viewcode-block" id="Operator.initializeInterfaces"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.initializeInterfaces">[docs]</a>    <span class="k">def</span> <span class="nf">initializeInterfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach the reactor to the operator and initialize all interfaces.</span>

<span class="sd">        This does not occur in `__init__` so that the ARMI operator can be initialized before a</span>
<span class="sd">        reactor is created, which is useful for summarizing the case information quickly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : Reactor</span>
<span class="sd">            The Reactor object to attach to this Operator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">r</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># TODO: this is only necessary for fuel-handler hacking</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">getTimer</span><span class="p">(</span><span class="s2">&quot;Interface Creation&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createInterfaces</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_processInterfaceDependencies</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_RANK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;=========== Interface Stack Summary  ===========&quot;</span><span class="p">)</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">reportingUtils</span><span class="o">.</span><span class="n">getInterfaceStackSummary</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interactAllInit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attachInterfaces</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loadRestartData</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;runType&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager to enable interface-level error handling hooks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception_type</span><span class="p">,</span> <span class="n">exception_value</span><span class="p">,</span> <span class="n">stacktrace</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">exception_type</span><span class="p">,</span> <span class="n">exception_value</span><span class="p">,</span> <span class="n">stacktrace</span><span class="p">]):</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">\n</span><span class="si">{}</span><span class="s2">\</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception_type</span><span class="p">,</span> <span class="n">exception_value</span><span class="p">,</span> <span class="n">stacktrace</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactAllError</span><span class="p">()</span>

<div class="viewcode-block" id="Operator.operate"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.operate">[docs]</a>    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the operation loop.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        mainOperator : run the operator loop on the primary MPI node (for parallel runs)</span>
<span class="sd">        workerOperate : run the operator loop for the worker MPI nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mainOperate</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_mainOperate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main loop for a standard ARMI run. Steps through time interacting with the interfaces.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactAllBOL</span><span class="p">()</span>
        <span class="n">startingCycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span>  <span class="c1"># may be starting at t != 0 in restarts</span>
        <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startingCycle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;nCycles&quot;</span><span class="p">]):</span>
            <span class="n">keepGoing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycleLoop</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">startingCycle</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keepGoing</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactAllEOL</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cycleLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">startingCycle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the portion of the main loop that happens each cycle.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycleLength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycleLengths</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">availabilityFactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">availabilityFactors</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">coupledIteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">cycle</span> <span class="o">==</span> <span class="n">startingCycle</span><span class="p">:</span>
            <span class="n">startingNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">startingNode</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span> <span class="o">=</span> <span class="n">startingNode</span>
        <span class="n">halt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactAllBOC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">halt</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># read total core power from settings (power or powerDensity)</span>
        <span class="n">basicPower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;power&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;powerDensity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">getHMMass</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">timeNode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startingNode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">burnSteps</span><span class="p">[</span><span class="n">cycle</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">powerFractions</span><span class="p">[</span><span class="n">cycle</span><span class="p">][</span><span class="n">timeNode</span><span class="p">]</span> <span class="o">*</span> <span class="n">basicPower</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">capacityFactor</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">availabilityFactor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">powerFractions</span><span class="p">[</span><span class="n">cycle</span><span class="p">][</span><span class="n">timeNode</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">stepLength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepLengths</span><span class="p">[</span><span class="n">cycle</span><span class="p">][</span><span class="n">timeNode</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_timeNodeLoop</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># do one last node at the end using the same power as the previous node</span>
            <span class="n">timeNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnSteps</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnSteps</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># this is a zero-burnup case</span>
                <span class="n">powFrac</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">powFrac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">powerFractions</span><span class="p">[</span><span class="n">cycle</span><span class="p">][</span><span class="n">timeNode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">powFrac</span> <span class="o">*</span> <span class="n">basicPower</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeNodeLoop</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interactAllEOC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_timeNodeLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the portion of the main loop that happens each subcycle.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span> <span class="o">=</span> <span class="n">timeNode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactAllEveryNode</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_performTightCoupling</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_performTightCoupling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">writeDB</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If requested, perform tight coupling and write out database.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        writeDB is False for OperatorSnapshots as the DB gets written at EOL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplingIsActive</span><span class="p">():</span>
            <span class="c1"># no coupling was requested</span>
            <span class="k">return</span>
        <span class="n">skipCycles</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_CYCLES_SKIP_TIGHT_COUPLING_INTERACTION</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">skipCycles</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;interactAllCoupled disabled this cycle (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="si">}</span><span class="s2">) due to &quot;</span>
                <span class="s2">&quot;`cyclesSkipTightCouplingInteraction` setting.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_convergenceSummary</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">coupledIteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_TIGHT_COUPLING_MAX_ITERS</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">coupledIteration</span> <span class="o">=</span> <span class="n">coupledIteration</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactAllCoupled</span><span class="p">(</span><span class="n">coupledIteration</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
                    <span class="n">runLog</span><span class="o">.</span><span class="n">important</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Tight coupling iterations for c</span><span class="si">{</span><span class="n">cycle</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">n</span><span class="si">{</span><span class="n">timeNode</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> have converged!&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Tight coupling iterations for c</span><span class="si">{</span><span class="n">cycle</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">n</span><span class="si">{</span><span class="n">timeNode</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> have not converged!&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; The maximum number of iterations, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_TIGHT_COUPLING_MAX_ITERS</span><span class="p">]</span><span class="si">}</span><span class="s2">, was reached.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">writeDB</span><span class="p">:</span>
            <span class="c1"># database has not yet been written, so we need to write it.</span>
            <span class="n">dbi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInterface</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">)</span>
            <span class="n">dbi</span><span class="o">.</span><span class="n">writeDBEveryNode</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_interactAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interactionName</span><span class="p">,</span> <span class="n">activeInterfaces</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop over the supplied activeInterfaces and perform the supplied interaction on each.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is the base method for the other ``interactAll`` methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interactMethodName</span> <span class="o">=</span> <span class="s2">&quot;interact</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interactionName</span><span class="p">)</span>

        <span class="n">printMemUsage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;verbosity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;debugMem&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;debugDB&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debugDB</span><span class="p">(</span><span class="n">interactionName</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">halt</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">cycleNodeTag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expandCycleAndTimeNodeArgs</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">interactionName</span><span class="o">=</span><span class="n">interactionName</span>
        <span class="p">)</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">header</span><span class="p">(</span>
            <span class="s2">&quot;===========  Triggering </span><span class="si">{}</span><span class="s2"> Event ===========&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">interactionName</span> <span class="o">+</span> <span class="n">cycleNodeTag</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">statePointIndex</span><span class="p">,</span> <span class="n">interface</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">activeInterfaces</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printInterfaceSummary</span><span class="p">(</span>
                <span class="n">interface</span><span class="p">,</span> <span class="n">interactionName</span><span class="p">,</span> <span class="n">statePointIndex</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span>
            <span class="p">)</span>

            <span class="c1"># maybe make this a context manager</span>
            <span class="k">if</span> <span class="n">printMemUsage</span><span class="p">:</span>
                <span class="n">memBefore</span> <span class="o">=</span> <span class="n">memoryProfiler</span><span class="o">.</span><span class="n">PrintSystemMemoryUsageAction</span><span class="p">()</span>
                <span class="n">memBefore</span><span class="o">.</span><span class="n">broadcast</span><span class="p">()</span>
                <span class="n">memBefore</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>

            <span class="n">interactionMessage</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2"> interacting with </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">interactionName</span><span class="p">,</span> <span class="n">interface</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">getTimer</span><span class="p">(</span><span class="n">interactionMessage</span><span class="p">):</span>
                <span class="n">interactMethod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">interactMethodName</span><span class="p">)</span>
                <span class="n">halt</span> <span class="o">=</span> <span class="n">halt</span> <span class="ow">or</span> <span class="n">interactMethod</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;debugDB&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_debugDB</span><span class="p">(</span><span class="n">interactionName</span><span class="p">,</span> <span class="n">interface</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">statePointIndex</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">printMemUsage</span><span class="p">:</span>
                <span class="n">memAfter</span> <span class="o">=</span> <span class="n">memoryProfiler</span><span class="o">.</span><span class="n">PrintSystemMemoryUsageAction</span><span class="p">()</span>
                <span class="n">memAfter</span><span class="o">.</span><span class="n">broadcast</span><span class="p">()</span>
                <span class="n">memAfter</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
                <span class="n">memAfter</span> <span class="o">-=</span> <span class="n">memBefore</span>
                <span class="n">memAfter</span><span class="o">.</span><span class="n">printUsage</span><span class="p">(</span>
                    <span class="s2">&quot;after </span><span class="si">{:25s}</span><span class="s2"> </span><span class="si">{:15s}</span><span class="s2"> interaction&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">interface</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">interactionName</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">runLog</span><span class="o">.</span><span class="n">header</span><span class="p">(</span>
            <span class="s2">&quot;===========  Completed </span><span class="si">{}</span><span class="s2"> Event ===========</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">interactionName</span> <span class="o">+</span> <span class="n">cycleNodeTag</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">halt</span>

<div class="viewcode-block" id="Operator.printInterfaceSummary"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.printInterfaceSummary">[docs]</a>    <span class="k">def</span> <span class="nf">printInterfaceSummary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">,</span> <span class="n">interactionName</span><span class="p">,</span> <span class="n">statePointIndex</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log which interaction point is about to be executed.</span>

<span class="sd">        This looks better as multiple lines but it&#39;s a lot easier to grep as one line.</span>
<span class="sd">        We leverage newlines instead of long banners to save disk space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodeInfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expandCycleAndTimeNodeArgs</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">interactionName</span><span class="o">=</span><span class="n">interactionName</span>
        <span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;=========== </span><span class="si">{:02d}</span><span class="s2"> - </span><span class="si">{:30s}</span><span class="s2"> </span><span class="si">{:15s}</span><span class="s2"> ===========&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">statePointIndex</span><span class="p">,</span> <span class="n">interface</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">interactionName</span> <span class="o">+</span> <span class="n">nodeInfo</span>
        <span class="p">)</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_expandCycleAndTimeNodeArgs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">interactionName</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return text annotating information for current run event.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Init, BOL, EOL: empty</span>
<span class="sd">        - Everynode: (cycle, time node)</span>
<span class="sd">        - BOC: cycle number</span>
<span class="sd">        - Coupling: iteration number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cycleNodeInfo</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">interactionName</span> <span class="o">==</span> <span class="s2">&quot;Coupled&quot;</span><span class="p">:</span>
                    <span class="n">cycleNodeInfo</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; - iteration </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">elif</span> <span class="n">interactionName</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BOC&quot;</span><span class="p">,</span> <span class="s2">&quot;EOC&quot;</span><span class="p">):</span>
                    <span class="n">cycleNodeInfo</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; - cycle </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cycleNodeInfo</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; - cycle </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, node </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">cycleNodeInfo</span>

    <span class="k">def</span> <span class="nf">_debugDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interactionName</span><span class="p">,</span> <span class="n">interfaceName</span><span class="p">,</span> <span class="n">statePointIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write state to DB with a unique &quot;statePointName&quot;, or label.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Used within _interactAll to write details between each physics interaction when cs[&#39;debugDB&#39;] is enabled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        interactionName : str</span>
<span class="sd">            name of the interaction (e.g. BOL, BOC, EveryNode)</span>
<span class="sd">        interfaceName : str</span>
<span class="sd">            name of the interface that is interacting (e.g. globalflux, lattice, th)</span>
<span class="sd">        statePointIndex : int (optional)</span>
<span class="sd">            used as a counter to make labels that increment throughout an _interactAll call. The result should be fed</span>
<span class="sd">            into the next call to ensure labels increment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbiForDetailedWrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInterface</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">dbiForDetailedWrite</span><span class="o">.</span><span class="n">database</span> <span class="k">if</span> <span class="n">dbiForDetailedWrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">db</span><span class="o">.</span><span class="n">isOpen</span><span class="p">():</span>
            <span class="c1"># looks something like &quot;c00t00-BOL-01-main&quot;</span>
            <span class="n">statePointName</span> <span class="o">=</span> <span class="s2">&quot;c</span><span class="si">{:2&lt;0}</span><span class="s2">t</span><span class="si">{:2&lt;0}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">-</span><span class="si">{:2&lt;0}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span><span class="p">,</span>
                <span class="n">interactionName</span><span class="p">,</span>
                <span class="n">statePointIndex</span><span class="p">,</span>
                <span class="n">interfaceName</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">writeToDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="n">statePointName</span><span class="p">)</span>

<div class="viewcode-block" id="Operator.interactAllInit"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.interactAllInit">[docs]</a>    <span class="k">def</span> <span class="nf">interactAllInit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call interactInit on all interfaces in the stack after they are initialized.&quot;&quot;&quot;</span>
        <span class="n">allInterfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">[:]</span>  <span class="c1"># copy just in case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interactAll</span><span class="p">(</span><span class="s2">&quot;Init&quot;</span><span class="p">,</span> <span class="n">allInterfaces</span><span class="p">)</span></div>

<div class="viewcode-block" id="Operator.interactAllBOL"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.interactAllBOL">[docs]</a>    <span class="k">def</span> <span class="nf">interactAllBOL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excludedInterfaceNames</span><span class="o">=</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call interactBOL for all interfaces in the interface stack at beginning-of-life.</span>

<span class="sd">        All enabled or bolForce interfaces will be called excluding interfaces with excludedInterfaceNames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">activeInterfaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ii</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ii</span><span class="o">.</span><span class="n">enabled</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ii</span><span class="o">.</span><span class="n">bolForce</span><span class="p">())</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludedInterfaceNames</span>
        <span class="p">]</span>
        <span class="n">activeInterfaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ii</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">activeInterfaces</span>
            <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;deferredInterfaceNames&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interactAll</span><span class="p">(</span><span class="s2">&quot;BOL&quot;</span><span class="p">,</span> <span class="n">activeInterfaces</span><span class="p">)</span></div>

<div class="viewcode-block" id="Operator.interactAllBOC"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.interactAllBOC">[docs]</a>    <span class="k">def</span> <span class="nf">interactAllBOC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interact at beginning of cycle of all enabled interfaces.&quot;&quot;&quot;</span>
        <span class="n">activeInterfaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span> <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">enabled</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">cycle</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;deferredInterfacesCycle&quot;</span><span class="p">]:</span>
            <span class="n">activeInterfaces</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ii</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">activeInterfaces</span>
                <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;deferredInterfaceNames&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interactAll</span><span class="p">(</span><span class="s2">&quot;BOC&quot;</span><span class="p">,</span> <span class="n">activeInterfaces</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span></div>

<div class="viewcode-block" id="Operator.interactAllEveryNode"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.interactAllEveryNode">[docs]</a>    <span class="k">def</span> <span class="nf">interactAllEveryNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">excludedInterfaceNames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call the interactEveryNode hook for all enabled interfaces.</span>

<span class="sd">        All enabled interfaces will be called excluding interfaces with excludedInterfaceNames.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cycle : int</span>
<span class="sd">            The cycle that is currently being run. Starts at 0</span>
<span class="sd">        tn : int</span>
<span class="sd">            The time node that is currently being run (0 for BOC, etc.)</span>
<span class="sd">        excludedInterfaceNames : list, optional</span>
<span class="sd">            Names of interface names that will not be interacted with.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">excludedInterfaceNames</span> <span class="o">=</span> <span class="n">excludedInterfaceNames</span> <span class="ow">or</span> <span class="p">()</span>
        <span class="n">activeInterfaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ii</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span>
            <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">enabled</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludedInterfaceNames</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interactAll</span><span class="p">(</span><span class="s2">&quot;EveryNode&quot;</span><span class="p">,</span> <span class="n">activeInterfaces</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">tn</span><span class="p">)</span></div>

<div class="viewcode-block" id="Operator.interactAllEOC"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.interactAllEOC">[docs]</a>    <span class="k">def</span> <span class="nf">interactAllEOC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">excludedInterfaceNames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interact end of cycle for all enabled interfaces.&quot;&quot;&quot;</span>
        <span class="n">excludedInterfaceNames</span> <span class="o">=</span> <span class="n">excludedInterfaceNames</span> <span class="ow">or</span> <span class="p">()</span>
        <span class="n">activeInterfaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ii</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span>
            <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">enabled</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludedInterfaceNames</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interactAll</span><span class="p">(</span><span class="s2">&quot;EOC&quot;</span><span class="p">,</span> <span class="n">activeInterfaces</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span></div>

<div class="viewcode-block" id="Operator.interactAllEOL"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.interactAllEOL">[docs]</a>    <span class="k">def</span> <span class="nf">interactAllEOL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run interactEOL for all enabled interfaces.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the interfaces are flagged to be reversed at EOL, they are separated from the main stack and appended</span>
<span class="sd">        at the end in reverse order. This allows, for example, an interface that must run first to also run last.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">activeInterfaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span> <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">enabled</span><span class="p">()]</span>
        <span class="n">interfacesAtEOL</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">activeInterfaces</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ii</span><span class="o">.</span><span class="n">reverseAtEOL</span><span class="p">]</span>
        <span class="n">activeReverseInterfaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">activeInterfaces</span> <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">reverseAtEOL</span><span class="p">]</span>
        <span class="n">interfacesAtEOL</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">activeReverseInterfaces</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interactAll</span><span class="p">(</span><span class="s2">&quot;EOL&quot;</span><span class="p">,</span> <span class="n">interfacesAtEOL</span><span class="p">)</span></div>

<div class="viewcode-block" id="Operator.interactAllCoupled"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.interactAllCoupled">[docs]</a>    <span class="k">def</span> <span class="nf">interactAllCoupled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coupledIteration</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interact for tight physics coupling over all enabled interfaces.</span>

<span class="sd">        Tight coupling implies operator-split iterations between two or more physics solvers at the same solution</span>
<span class="sd">        point in time. For example, a flux solution might be computed, then a temperature solution, and then</span>
<span class="sd">        another flux solution based on updated temperatures (which updated densities, dimensions, and Doppler).</span>

<span class="sd">        This is distinct from loose coupling, which would simply uses the temperature values from the previous timestep</span>
<span class="sd">        in the current flux solution. It&#39;s also distinct from full coupling where all fields are solved simultaneously.</span>
<span class="sd">        ARMI supports tight and loose coupling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">activeInterfaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span> <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">enabled</span><span class="p">()]</span>

        <span class="c1"># Store the previous iteration values before calling interactAllCoupled</span>
        <span class="c1"># for each interface.</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">activeInterfaces</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interface</span><span class="o">.</span><span class="n">coupler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">interface</span><span class="o">.</span><span class="n">coupler</span><span class="o">.</span><span class="n">storePreviousIterationValue</span><span class="p">(</span>
                    <span class="n">interface</span><span class="o">.</span><span class="n">getTightCouplingValue</span><span class="p">()</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_interactAll</span><span class="p">(</span><span class="s2">&quot;Coupled&quot;</span><span class="p">,</span> <span class="n">activeInterfaces</span><span class="p">,</span> <span class="n">coupledIteration</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkTightCouplingConvergence</span><span class="p">(</span><span class="n">activeInterfaces</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_checkTightCouplingConvergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activeInterfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if interfaces are converged.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        activeInterfaces : list</span>
<span class="sd">            the list of active interfaces on the operator</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is split off from self.interactAllCoupled to accomodate testing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Summarize the coupled results and the convergence status.</span>
        <span class="n">converged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">activeInterfaces</span><span class="p">:</span>
            <span class="n">coupler</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">coupler</span>
            <span class="k">if</span> <span class="n">coupler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interface</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">coupler</span><span class="o">.</span><span class="n">parameter</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">converged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coupler</span><span class="o">.</span><span class="n">isConverged</span><span class="p">(</span><span class="n">interface</span><span class="o">.</span><span class="n">getTightCouplingValue</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convergenceSummary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coupler</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

        <span class="n">reportingUtils</span><span class="o">.</span><span class="n">writeTightCouplingConvergenceSummary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convergenceSummary</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">converged</span><span class="p">)</span>

<div class="viewcode-block" id="Operator.interactAllError"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.interactAllError">[docs]</a>    <span class="k">def</span> <span class="nf">interactAllError</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interact when an error is raised by any other interface. Provides a wrap-up option on the way to a crash.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="s2">&quot;Error-interacting with </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">i</span><span class="o">.</span><span class="n">interactError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Operator.createInterfaces"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.createInterfaces">[docs]</a>    <span class="k">def</span> <span class="nf">createInterfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamically discover all available interfaces and call their factories, potentially adding</span>
<span class="sd">        them to the stack.</span>

<span class="sd">        An operator contains an ordered list of interfaces. These communicate between</span>
<span class="sd">        the core ARMI structure and auxiliary computational modules and/or external codes.</span>
<span class="sd">        At specified interaction points in a run, the list of interfaces is executed.</span>

<span class="sd">        Each interface optionally defines interaction &quot;hooks&quot; for each of the interaction points.</span>
<span class="sd">        The normal interaction points are BOL, BOC, every node, EOC, and EOL. If an interface defines</span>
<span class="sd">        an interactBOL method, that will run at BOL, and so on.</span>

<span class="sd">        The majority of ARMI capabilities lie within interfaces, and this architecture provides</span>
<span class="sd">        much of the flexibility of ARMI.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        addInterface : Adds a particular interface to the interface stack.</span>
<span class="sd">        armi.interfaces.STACK_ORDER : A system to determine the required order of interfaces.</span>
<span class="sd">        armi.interfaces.getActiveInterfaceInfo : Collects the interface classes from relevant</span>
<span class="sd">            packages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;=========== Creating Interfaces ===========&quot;</span><span class="p">)</span>
        <span class="n">interfaceList</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">getActiveInterfaceInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">klass</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">interfaceList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addInterface</span><span class="p">(</span><span class="n">klass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Operator.addInterface"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.addInterface">[docs]</a>    <span class="k">def</span> <span class="nf">addInterface</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">interface</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">reverseAtEOL</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">bolForce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach an interface to this operator.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Order matters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        interface : Interface</span>
<span class="sd">            the interface to add</span>
<span class="sd">        index : int, optional. Will insert the interface at this index rather than appending it to the end of</span>
<span class="sd">            the list</span>
<span class="sd">        reverseAtEOL : bool, optional.</span>
<span class="sd">            The interactEOL hooks will run in reverse order if True. All interfaces with this flag will be run</span>
<span class="sd">            as a group after all other interfaces.</span>
<span class="sd">            This allows something to run first at BOL and last at EOL, etc.</span>
<span class="sd">        enabled : bool, optional</span>
<span class="sd">            If enabled, will run at all hooks. If not, won&#39;t run any (with possible exception at BOL, see bolForce).</span>
<span class="sd">            Whenever possible, Interfaces that are needed during runtime for some peripheral</span>
<span class="sd">            operation but not during the main loop should be instantiated by the</span>
<span class="sd">            part of the code that actually needs the interface.</span>
<span class="sd">        bolForce: bool, optional</span>
<span class="sd">            If true, will run at BOL hook even if disabled. This is often a sign</span>
<span class="sd">            that the interface in question should be ephemerally instantiated on demand</span>
<span class="sd">            rather than added to the interface stack at all.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If an interface of the same name or function is already attached to the</span>
<span class="sd">            Operator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInterface</span><span class="p">(</span><span class="n">interface</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;An interface with name </span><span class="si">{0}</span><span class="s2"> is already attached.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interface</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">iFunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInterface</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">interface</span><span class="o">.</span><span class="n">function</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iFunc</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">iFunc</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">interface</span><span class="p">)):</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Ignoring Interface </span><span class="si">{newFunc}</span><span class="s2"> because existing interface </span><span class="si">{old}</span><span class="s2"> already &quot;</span>
                    <span class="s2">&quot; more specific&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newFunc</span><span class="o">=</span><span class="n">interface</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">iFunc</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">interface</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">iFunc</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removeInterface</span><span class="p">(</span><span class="n">iFunc</span><span class="p">)</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Will Insert Interface </span><span class="si">{newFunc}</span><span class="s2"> because it is a subclass of </span><span class="si">{old}</span><span class="s2"> interface and &quot;</span>
                    <span class="s2">&quot; more derived&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newFunc</span><span class="o">=</span><span class="n">interface</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">iFunc</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot add </span><span class="si">{0}</span><span class="s2">; the </span><span class="si">{1}</span><span class="s2"> already is designated &quot;</span>
                    <span class="s2">&quot;as the </span><span class="si">{2}</span><span class="s2"> interface. Multiple interfaces of the same &quot;</span>
                    <span class="s2">&quot;function is not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">interface</span><span class="p">,</span> <span class="n">iFunc</span><span class="p">,</span> <span class="n">interface</span><span class="o">.</span><span class="n">function</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">runLog</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interface</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">interface</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reverseAtEOL</span><span class="p">:</span>
            <span class="n">interface</span><span class="o">.</span><span class="n">reverseAtEOL</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled</span><span class="p">:</span>
            <span class="n">interface</span><span class="o">.</span><span class="n">enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">interface</span><span class="o">.</span><span class="n">bolForce</span><span class="p">(</span><span class="n">bolForce</span><span class="p">)</span>
        <span class="n">interface</span><span class="o">.</span><span class="n">attachReactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_processInterfaceDependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check all interfaces&#39; dependencies and adds missing ones.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Order does not matter here because the interfaces added here are disabled and playing supporting</span>
<span class="sd">        role so it is not intended to run on the interface stack. They will be called by other interfaces.</span>

<span class="sd">        As mentioned in :py:meth:`addInterface`, it may be better to just insantiate utility code</span>
<span class="sd">        when its needed rather than rely on this system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make multiple passes in case there&#39;s one added that depends on another.</span>
        <span class="k">for</span> <span class="n">_dependencyPass</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">numInterfaces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">)</span>
            <span class="c1"># manipulation friendly, so it&#39;s ok to add additional things to the stack</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInterfaces</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">dependency</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">function</span> <span class="o">=</span> <span class="n">dependency</span><span class="o">.</span><span class="n">function</span>
                    <span class="n">klass</span> <span class="o">=</span> <span class="n">dependency</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInterface</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">):</span>
                        <span class="n">runLog</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
                            <span class="s2">&quot;Attaching </span><span class="si">{}</span><span class="s2"> interface (disabled, BOL forced) due to dependency in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">klass</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">addInterface</span><span class="p">(</span>
                            <span class="n">klass</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">),</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bolForce</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">)</span> <span class="o">==</span> <span class="n">numInterfaces</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Interface dependency resolution did not converge.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Operator.removeAllInterfaces"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.removeAllInterfaces">[docs]</a>    <span class="k">def</span> <span class="nf">removeAllInterfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes all of the interfaces.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
            <span class="n">interface</span><span class="o">.</span><span class="n">detachReactor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Operator.removeInterface"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.removeInterface">[docs]</a>    <span class="k">def</span> <span class="nf">removeInterface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interfaceName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a single interface from the interface stack.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        interface : Interface, optional</span>
<span class="sd">            An actual interface object to remove.</span>
<span class="sd">        interfaceName : str, optional</span>
<span class="sd">            The name of the interface to remove.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        success : boolean</span>
<span class="sd">            True if the interface was removed</span>
<span class="sd">            False if it was not (because it wasn&#39;t there to be removed)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">interfaceName</span><span class="p">:</span>
            <span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInterface</span><span class="p">(</span><span class="n">interfaceName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">interface</span> <span class="ow">and</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
            <span class="n">interface</span><span class="o">.</span><span class="n">detachReactor</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Cannot remove interface </span><span class="si">{0}</span><span class="s2"> because it is not in the interface stack.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">interface</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Operator.getInterface"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.getInterface">[docs]</a>    <span class="k">def</span> <span class="nf">getInterface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a specific interface from the stack by its name or more generic function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            Interface name</span>
<span class="sd">        function : str</span>
<span class="sd">            Interface function (general, like &#39;globalFlux&#39;,&#39;th&#39;,etc.). This is useful when you need</span>
<span class="sd">            the ___ solver (e.g. globalFlux) but don&#39;t care which particular one is active (e.g. SERPENT vs. DIF3D)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If there are more than one interfaces of the given name or function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">candidateI</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">function</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="n">function</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">candidateI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">candidateI</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot retrieve a single interface as there are multiple &quot;</span>
                        <span class="s2">&quot;interfaces with name </span><span class="si">{}</span><span class="s2"> or function </span><span class="si">{}</span><span class="s2"> attached. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">function</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">candidateI</span></div>

<div class="viewcode-block" id="Operator.interfaceIsActive"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.interfaceIsActive">[docs]</a>    <span class="k">def</span> <span class="nf">interfaceIsActive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if named interface exists and is active.&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInterface</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">enabled</span><span class="p">()</span></div>

<div class="viewcode-block" id="Operator.getInterfaces"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.getInterfaces">[docs]</a>    <span class="k">def</span> <span class="nf">getInterfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get list of interfaces in interface stack.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Returns a copy so you can manipulate the list in an interface, like dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">[:]</span></div>

<div class="viewcode-block" id="Operator.reattach"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.reattach">[docs]</a>    <span class="k">def</span> <span class="nf">reattach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add links to globally-shared objects to this operator and all interfaces.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Could be a good opportunity for weakrefs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">cs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">i</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="n">cs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">i</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span></div>

<div class="viewcode-block" id="Operator.detach"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.detach">[docs]</a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Break links to globally-shared objects to this operator and all interfaces.</span>

<span class="sd">        May be required prior to copying these objects over the network.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Could be a good opportunity for weakrefs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">i</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">i</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_attachInterfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Links all the interfaces in the interface stack to the operator, reactor, and cs.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        createInterfaces : creates all interfaces</span>
<span class="sd">        addInterface : adds a single interface to the stack</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">attachReactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loadRestartData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a restart.dat file which contains all the fuel management factorLists and cycle lengths.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This allows the ARMI to do the same shuffles that it did last time, assuming fuel management logic</span>
<span class="sd">        has not changed. Note, it would be better if the moves were just read from a table in the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">restartName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span> <span class="o">+</span> <span class="s2">&quot;.restart.dat&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">restartName</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading restart data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restartName</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">restartName</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">restart</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">restart</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;cycle=(\d+)\s+time=(\d+\.\d+[Ee+-]+\d+)\s+factorList=[\[\{](.+?)[\]\}]&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">newStyle</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;(\w+)&#39;:\s*(\d*\.?\d*)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">newStyle</span><span class="p">:</span>
                        <span class="c1"># key-based factorList. load a dictionary.</span>
                        <span class="n">factorList</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">newStyle</span><span class="p">:</span>
                            <span class="n">factorList</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># list based factorList. Load a list. (old style, backward compat)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">factorList</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                            <span class="p">]</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">factorList</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">runLog</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;loaded restart data for cycle </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">restartData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="n">factorList</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;loaded restart data for </span><span class="si">{0}</span><span class="s2"> cycles&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restartData</span><span class="p">)))</span>

<div class="viewcode-block" id="Operator.loadState"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.loadState">[docs]</a>    <span class="k">def</span> <span class="nf">loadState</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">timeStepName</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">updateMassFractions</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method reroute to the database interface state reload method.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        armi.bookeeping.db.loadOperator:</span>
<span class="sd">            A method for loading an operator given a database. loadOperator does not</span>
<span class="sd">            require an operator prior to loading the state of the reactor. loadState</span>
<span class="sd">            does, and therefore armi.init must be called which requires access to the</span>
<span class="sd">            blueprints, settings, and geometry files. These files are stored implicitly</span>
<span class="sd">            on the database, so loadOperator creates the reactor first, and then attaches</span>
<span class="sd">            it to the operator. loadState should be used if you are in the middle</span>
<span class="sd">            of an ARMI calculation and need load a different time step. If you are</span>
<span class="sd">            loading from a fresh ARMI session, either method is sufficient if you have</span>
<span class="sd">            access to all the input files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInterface</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbi</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot load from snapshot without a database interface&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">updateMassFractions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;deprecated: updateMassFractions is no longer a valid option for loadState&quot;</span>
            <span class="p">)</span>

        <span class="n">dbi</span><span class="o">.</span><span class="n">loadState</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">timeStepName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Operator.snapshotRequest"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.snapshotRequest">[docs]</a>    <span class="k">def</span> <span class="nf">snapshotRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a snapshot request at this time.</span>

<span class="sd">        This copies various physics input and output files to a special folder that</span>
<span class="sd">        follow-on analysis be executed upon later.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This was originally used to produce MC2/DIF3D inputs for external</span>
<span class="sd">        parties (who didn&#39;t have ARMI) to review. Since then, the concept</span>
<span class="sd">        of snapshots has evolved with respect to the</span>
<span class="sd">        :py:class:`~armi.operators.snapshots.OperatorSnapshots`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">armi.physics.neutronics.settings</span> <span class="kn">import</span> <span class="n">CONF_LOADING_FILE</span>

        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Producing snapshot for cycle </span><span class="si">{0}</span><span class="s2"> node </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">zones</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

        <span class="n">newFolder</span> <span class="o">=</span> <span class="s2">&quot;snapShot</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newFolder</span><span class="p">):</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="s2">&quot;Deleting existing snapshot data in </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newFolder</span><span class="p">))</span>
            <span class="n">pathTools</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">newFolder</span><span class="p">)</span>  <span class="c1"># careful with cleanPath!</span>
            <span class="c1"># give it a minute.</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newFolder</span><span class="p">):</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Deleting existing snapshot data in </span><span class="si">{0}</span><span class="s2"> failed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newFolder</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">newFolder</span><span class="p">)</span>

        <span class="c1"># Moving the cross section files is to a snapshot directory is a reasonable</span>
        <span class="c1"># requirement, but these hard-coded names are not desirable. This is legacy</span>
        <span class="c1"># and should be updated to be more robust for users.</span>
        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;mcc&quot;</span> <span class="ow">in</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[A-Z]AF?\d?.inp&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
                <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">iteration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">newFile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1:03d}</span><span class="s2">_</span><span class="si">{2:d}</span><span class="s2">_</span><span class="si">{4}{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">base</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">iteration</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newFile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1:03d}</span><span class="s2">_</span><span class="si">{2:d}{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
                <span class="c1"># add the cycle and timenode to the XS input file names so that a rx-coeff case that runs</span>
                <span class="c1"># in here won&#39;t overwrite them.</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newFolder</span><span class="p">,</span> <span class="n">newFile</span><span class="p">))</span>
            <span class="k">if</span> <span class="s2">&quot;rzmflx&quot;</span> <span class="ow">in</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span><span class="s2">&quot;rzmflx for snapshot&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">newFolder</span><span class="p">)</span>

        <span class="n">fileNamePossibilities</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;ISOTXS-c</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">n</span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;ISOTXS-c</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileNamePossibilities</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;ISOTXS-c</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">n</span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">i</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">]</span> <span class="o">+</span> <span class="n">fileNamePossibilities</span>

        <span class="k">for</span> <span class="n">isoFName</span> <span class="ow">in</span> <span class="n">fileNamePossibilities</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">isoFName</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span>
            <span class="s2">&quot;ISOTXS for snapshot&quot;</span><span class="p">,</span> <span class="n">isoFName</span><span class="p">,</span> <span class="n">pathTools</span><span class="o">.</span><span class="n">armiAbsPath</span><span class="p">(</span><span class="n">newFolder</span><span class="p">,</span> <span class="s2">&quot;ISOTXS&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">globalFluxLabel</span> <span class="o">=</span> <span class="n">GlobalFluxInterfaceUsingExecuters</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">iteration</span>
        <span class="p">)</span>
        <span class="n">globalFluxInput</span> <span class="o">=</span> <span class="n">globalFluxLabel</span> <span class="o">+</span> <span class="s2">&quot;.inp&quot;</span>
        <span class="n">globalFluxOutput</span> <span class="o">=</span> <span class="n">globalFluxLabel</span> <span class="o">+</span> <span class="s2">&quot;.out&quot;</span>
        <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span><span class="s2">&quot;DIF3D input for snapshot&quot;</span><span class="p">,</span> <span class="n">globalFluxInput</span><span class="p">,</span> <span class="n">newFolder</span><span class="p">)</span>
        <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span><span class="s2">&quot;DIF3D output for snapshot&quot;</span><span class="p">,</span> <span class="n">globalFluxOutput</span><span class="p">,</span> <span class="n">newFolder</span><span class="p">)</span>
        <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span>
            <span class="s2">&quot;Shuffle logic for snapshot&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_SHUFFLE_LOGIC</span><span class="p">],</span> <span class="n">newFolder</span>
        <span class="p">)</span>
        <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span>
            <span class="s2">&quot;Geometry file for snapshot&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;geomFile&quot;</span><span class="p">],</span> <span class="n">newFolder</span>
        <span class="p">)</span>
        <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span>
            <span class="s2">&quot;Loading definition for snapshot&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_LOADING_FILE</span><span class="p">],</span> <span class="n">newFolder</span>
        <span class="p">)</span>
        <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span>
            <span class="s2">&quot;Flow history for snapshot&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span> <span class="o">+</span> <span class="s2">&quot;.flow_history.txt&quot;</span><span class="p">,</span>
            <span class="n">newFolder</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span>
            <span class="s2">&quot;Pressure history for snapshot&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span> <span class="o">+</span> <span class="s2">&quot;.pressure_history.txt&quot;</span><span class="p">,</span>
            <span class="n">newFolder</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Operator.setStateToDefault"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.setStateToDefault">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">setStateToDefault</span><span class="p">(</span><span class="n">cs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the state of ARMI to fit the kind of run this operator manages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cs</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">newSettings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;runType&quot;</span><span class="p">:</span> <span class="n">RunTypes</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">})</span></div>

<div class="viewcode-block" id="Operator.couplingIsActive"><a class="viewcode-back" href="../../../.apidocs/armi.operators.operator.html#armi.operators.operator.Operator.couplingIsActive">[docs]</a>    <span class="k">def</span> <span class="nf">couplingIsActive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if any kind of physics coupling is active.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_TIGHT_COUPLING</span><span class="p">]</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2009-2023, TerraPower, LLC.
      <span class="lastupdated">Last updated on 2023-10-31.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>