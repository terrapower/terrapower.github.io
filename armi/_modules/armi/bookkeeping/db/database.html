

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>armi.bookkeeping.db.database &mdash; ARMI 0.5.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme_fixes.css?v=2b77b304" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-dataframe.css?v=e5fbc548" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-data-viewer/jsonview.bundle.css?v=f6ef2277" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-needs/libs/html/datatables.min.css?v=4b4fd840" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-needs/common_css/need_core.css?v=f5b60a78" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-needs/common_css/need_style.css?v=678fb11e" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-needs/common_css/need_links.css?v=2150a916" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-needs/common_css/need_toggle.css?v=5c6620df" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-needs/common_css/needstable.css?v=5e1b6797" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-needs/modern.css?v=803738c0" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-test-results/common.css?v=9ec2c1d5" />

  
    <link rel="shortcut icon" href="../../../../_static/armiicon_16x16.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=b9afe91b"></script>
      <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="../../../../_static/sphinx-data-viewer/jsonview.bundle.js?v=18cd53c5"></script>
      <script src="../../../../_static/sphinx-data-viewer/jsonview_loader.js?v=f7ff7e7d"></script>
      <script src="../../../../_static/sphinx-needs/libs/html/datatables.min.js?v=8a4aee21"></script>
      <script src="../../../../_static/sphinx-needs/libs/html/datatables_loader.js?v=a2cae175"></script>
      <script src="../../../../_static/sphinx-needs/libs/html/sphinx_needs_collapse.js?v=dca66431"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #233C5B" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            ARMI
              <img src="../../../../_static/armiicon_24x24.ico" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/index.html">User Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer/index.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../release/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../qa_docs/index.html">QA Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../.apidocs/modules.html">API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #233C5B" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ARMI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../armi.html">armi</a></li>
          <li class="breadcrumb-item"><a href="../../bookkeeping.html">armi.bookkeeping</a></li>
          <li class="breadcrumb-item"><a href="../db.html">armi.bookkeeping.db</a></li>
      <li class="breadcrumb-item active">armi.bookkeeping.db.database</li>
  <li class="wy-breadcrumbs-aside">
    
  </li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for armi.bookkeeping.db.database</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2019 TerraPower, LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ARMI Database implementation, version 3.4.</span>

<span class="sd">A reactor model should be fully recoverable from the database; all the way down to the component</span>
<span class="sd">level. As a result, the structure of the underlying data is bound to the hierarchical Composite</span>
<span class="sd">Reactor Model. Furthermore, this database format is intended to be more dynamic, permitting as-yet</span>
<span class="sd">undeveloped levels and classes in the Composite Reactor Model to be supported as they are added.</span>
<span class="sd">More high-level discussion is contained in :ref:`database-file`.</span>

<span class="sd">The :py:class:`Database` class contains most of the functionality for interacting with the</span>
<span class="sd">underlying data. This includes things like dumping a Reactor state to the database and loading it</span>
<span class="sd">back again, as well as extracting historical data for a given object or collection of object from</span>
<span class="sd">the database file. However, for the nitty-gritty details of how the hierarchical Composite Reactor</span>
<span class="sd">Model is translated to the flat file database, please refer to :py:mod:`armi.bookkeeping.db.layout`.</span>

<span class="sd">Refer to :py:mod:`armi.bookkeeping.db` for information about versioning.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">platform</span><span class="w"> </span><span class="kn">import</span> <span class="n">uname</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">armi</span><span class="w"> </span><span class="kn">import</span> <span class="n">context</span><span class="p">,</span> <span class="n">getApp</span><span class="p">,</span> <span class="n">getPluginManagerOrFail</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">runLog</span><span class="p">,</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.bookkeeping.db.jaggedArray</span><span class="w"> </span><span class="kn">import</span> <span class="n">JaggedArray</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.bookkeeping.db.layout</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DB_VERSION</span><span class="p">,</span>
    <span class="n">Layout</span><span class="p">,</span>
    <span class="n">replaceNonesWithNonsense</span><span class="p">,</span>
    <span class="n">replaceNonsenseWithNones</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.bookkeeping.db.typedefs</span><span class="w"> </span><span class="kn">import</span> <span class="n">Histories</span><span class="p">,</span> <span class="n">History</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.nucDirectory</span><span class="w"> </span><span class="kn">import</span> <span class="n">nuclideBases</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.physics.neutronics.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">CONF_LOADING_FILE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.reactor</span><span class="w"> </span><span class="kn">import</span> <span class="n">grids</span><span class="p">,</span> <span class="n">parameters</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.reactor.assemblies</span><span class="w"> </span><span class="kn">import</span> <span class="n">Assembly</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.reactor.blocks</span><span class="w"> </span><span class="kn">import</span> <span class="n">Block</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.reactor.components</span><span class="w"> </span><span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.reactor.composites</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArmiObject</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.reactor.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">parameterCollections</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.reactor.reactorParameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">makeParametersReadOnly</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.reactor.reactors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Core</span><span class="p">,</span> <span class="n">Reactor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.settings.fwSettings.globalSettings</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONF_GROW_TO_FULL_CORE_AFTER_LOAD</span><span class="p">,</span>
    <span class="n">CONF_SORT_REACTOR</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">getNodesPerCycle</span><span class="p">,</span> <span class="n">safeCopy</span><span class="p">,</span> <span class="n">safeMove</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">armi.utils.textProcessors</span><span class="w"> </span><span class="kn">import</span> <span class="n">resolveMarkupInclusions</span>

<span class="c1"># CONSTANTS</span>
<span class="n">_SERIALIZER_NAME</span> <span class="o">=</span> <span class="s2">&quot;serializerName&quot;</span>
<span class="n">_SERIALIZER_VERSION</span> <span class="o">=</span> <span class="s2">&quot;serializerVersion&quot;</span>


<div class="viewcode-block" id="getH5GroupName">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.getH5GroupName">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Naming convention specifier.</span>

<span class="sd">    ARMI defines the naming convention cXXnYY for groups of simulation data.</span>
<span class="sd">    That is, data is grouped by cycle and time node information during a</span>
<span class="sd">    simulated run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;c</span><span class="si">{:0&gt;2}</span><span class="s2">n</span><span class="si">{:0&gt;2}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Database">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Database</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ARMI Database, handling serialization and loading of Reactor states.</span>

<span class="sd">    This implementation of the database pushes all objects in the Composite Reactor Model into the</span>
<span class="sd">    database. This process is aided by the ``Layout`` class, which handles the packing and unpacking</span>
<span class="sd">    of the structure of the objects, their relationships, and their non-parameter attributes.</span>

<span class="sd">    .. impl:: The database files are H5, and thus language agnostic.</span>
<span class="sd">        :id: I_ARMI_DB_H51</span>
<span class="sd">        :implements: R_ARMI_DB_H5</span>

<span class="sd">        This class implements a light wrapper around H5 files, so they can be used to store ARMI</span>
<span class="sd">        outputs. H5 files are commonly used in scientific applications in Fortran and C++. As such,</span>
<span class="sd">        they are entirely language agnostic binary files. The implementation here is that ARMI wraps</span>
<span class="sd">        the ``h5py`` library, and uses its extensive tooling, instead of re-inventing the wheel.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    `doc/user/outputs/database` for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Allows matching for, e.g., c01n02EOL</span>
    <span class="n">timeNodeGroupPattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^c(\d\d)n(\d\d).*$&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new Database object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileName:</span>
<span class="sd">            name of the file</span>
<span class="sd">        permission:</span>
<span class="sd">            file permissions, write (&quot;w&quot;) or read (&quot;r&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span> <span class="o">=</span> <span class="n">fileName</span>
        <span class="c1"># No full path yet; we will determine this based on FAST_PATH and permissions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="o">=</span> <span class="n">permission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Allows context management on open files. If context management is used on a file that is</span>
        <span class="c1"># already open, it will not reopen and it will also not close after leaving that context.</span>
        <span class="c1"># This allows the treatment of all databases the same whether they are open or closed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">permission</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">DB_VERSION</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># will be set upon read</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_versionMajor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_versionMinor</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

    <span class="nd">@version</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versionMinor</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">versionMajor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versionMajor</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">versionMinor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versionMinor</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="Database.open">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.open">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This database is already open; make sure to close it before trying to open it again.&quot;</span><span class="p">)</span>
        <span class="n">filePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;databaseVersion&quot;</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
            <span class="c1"># assume fast path!</span>
            <span class="n">filePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">getFastPath</span><span class="p">(),</span> <span class="n">filePath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unrecognized file permissions `</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot open database with permission `</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">))</span>

        <span class="c1"># open the database, and write a bunch of metadata to it</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Opening database file at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filePath</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;successfulCompletion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">__version__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;databaseVersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeSystemAttributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">)</span>

        <span class="c1"># store app and plugin data</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">getApp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;appName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">name</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">pluginManager</span><span class="o">.</span><span class="n">list_name_plugin</span><span class="p">()</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">]</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;pluginPaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;localCommitHash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">grabLocalCommitHash</span><span class="p">()</span></div>


<div class="viewcode-block" id="Database.isOpen">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.isOpen">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">isOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Database.writeSystemAttributes">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.writeSystemAttributes">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">writeSystemAttributes</span><span class="p">(</span><span class="n">h5db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write system attributes to the database.</span>

<span class="sd">        .. impl:: Add system attributes to the database.</span>
<span class="sd">            :id: I_ARMI_DB_QA</span>
<span class="sd">            :implements: R_ARMI_DB_QA</span>

<span class="sd">            This method writes some basic system information to the H5 file. This is designed as a</span>
<span class="sd">            starting point, so users can see information about the system their simulations were run</span>
<span class="sd">            on. As ARMI is used on Windows and Linux, the tooling here has to be platform</span>
<span class="sd">            independent. The two major sources of information are the ARMI</span>
<span class="sd">            :py:mod:`context &lt;armi.context&gt;` module and the Python standard library ``platform``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">USER</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;armiLocation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">ROOT</span><span class="p">)</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;startTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">START_TIME</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;machines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">MPI_NODENAMES</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>

        <span class="c1"># store platform data</span>
        <span class="n">platform_data</span> <span class="o">=</span> <span class="n">uname</span><span class="p">()</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">system</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">node</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;platformRelease&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">release</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;platformVersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">version</span>
        <span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;platformArch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">processor</span></div>


<div class="viewcode-block" id="Database.grabLocalCommitHash">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.grabLocalCommitHash">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">grabLocalCommitHash</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to determine the local Git commit.</span>

<span class="sd">        We have to be sure to handle the errors where the code is run on a system that doesn&#39;t have</span>
<span class="sd">        Git installed. Or if the code is simply not run from inside a repo.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The commit hash if it exists, otherwise &quot;unknown&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">):</span>
            <span class="c1"># no git available. cannot check git info</span>
            <span class="k">return</span> <span class="n">unknown</span>
        <span class="n">repo_exists</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="s2">&quot;git rev-parse --git-dir&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">returncode</span>
            <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;describe&quot;</span><span class="p">],</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">returncode</span>
            <span class="o">==</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">repo_exists</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">commit_hash</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;describe&quot;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">commit_hash</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">unknown</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unknown</span></div>


<div class="viewcode-block" id="Database.close">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completedSuccessfully</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the DB and perform cleanups and auto-conversions.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;successfulCompletion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">completedSuccessfully</span>
            <span class="c1"># a bit redundant to call flush, but with unreliable IO issues, why not?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
            <span class="c1"># move out of the FAST_PATH and into the working directory</span>
            <span class="n">newPath</span> <span class="o">=</span> <span class="n">safeMove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">newPath</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.splitDatabase">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.splitDatabase">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">splitDatabase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keepTimeSteps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discard all data except for specific time steps, retaining old data in a separate file.</span>

<span class="sd">        This is useful when performing more exotic analyses, where each &quot;time step&quot; may not</span>
<span class="sd">        represent a specific point in time, but something more nuanced. For example, equilibrium</span>
<span class="sd">        cases store a new &quot;cycle&quot; for each iteration as it attempts to converge the equilibrium</span>
<span class="sd">        cycle. At the end of the run, the last &quot;cycle&quot; is the converged equilibrium cycle, whereas</span>
<span class="sd">        the previous cycles constitute the path to convergence, which we typically wish to discard</span>
<span class="sd">        before further analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keepTimeSteps</span>
<span class="sd">            A collection of the time steps to retain</span>
<span class="sd">        label</span>
<span class="sd">            An informative label for the backed-up database. Usually something like</span>
<span class="sd">            &quot;-all-iterations&quot;. Will be interposed between the source name and the &quot;.h5&quot; extension.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The name of the new, backed-up database file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is no open database to split.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">backupDBPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span><span class="p">)))</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retaining full database history in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backupDBPath</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">safeMove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">,</span> <span class="n">backupDBPath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">)</span>
        <span class="n">dbOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">backupDBPath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dbIn</span><span class="p">:</span>
            <span class="n">dbOut</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dbIn</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>

            <span class="c1"># Copy everything except time node data</span>
            <span class="n">timeSteps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">groupName</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dbIn</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeNodeGroupPattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">groupName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">timeSteps</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dbIn</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">groupName</span><span class="p">,</span> <span class="n">dbOut</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">keepTimeSteps</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">timeSteps</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Not all desired time steps (</span><span class="si">{}</span><span class="s2">) are even present in the database&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keepTimeSteps</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">minCycle</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">keepTimeSteps</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">keepTimeSteps</span><span class="p">:</span>
                <span class="n">offsetCycle</span> <span class="o">=</span> <span class="n">cycle</span> <span class="o">-</span> <span class="n">minCycle</span>
                <span class="n">offsetGroupName</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">offsetCycle</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="n">dbIn</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">),</span> <span class="n">dbOut</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">offsetGroupName</span><span class="p">)</span>
                <span class="n">dbOut</span><span class="p">[</span><span class="n">offsetGroupName</span> <span class="o">+</span> <span class="s2">&quot;/Reactor/cycle&quot;</span><span class="p">][()]</span> <span class="o">=</span> <span class="n">offsetCycle</span>

        <span class="k">return</span> <span class="n">backupDBPath</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fileName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span>

    <span class="nd">@fileName</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fName</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot change Database file name while it&#39;s opened!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span> <span class="o">=</span> <span class="n">fName</span>

<div class="viewcode-block" id="Database.loadCS">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.loadCS">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">loadCS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handleInvalids</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt to load settings from the database file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        handleInvalids : bool</span>
<span class="sd">            Whether to check for invalid settings. Default True.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        There are no guarantees here. If the database was written from a different version of ARMI</span>
<span class="sd">        than you are using, these results may not be usable. Or if the database was written using a</span>
<span class="sd">        custom Application you do not have access to, the DB may not be usable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">loadFromString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/settings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()],</span> <span class="n">handleInvalids</span><span class="o">=</span><span class="n">handleInvalids</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cs</span></div>


<div class="viewcode-block" id="Database.loadBlueprints">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.loadBlueprints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">loadBlueprints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt to load reactor blueprints from the database file.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        There are no guarantees here. If the database was written from a different version of ARMI</span>
<span class="sd">        than you are using, these results may not be usable. Or if the database was written using a</span>
<span class="sd">        custom Application you do not have access to, the DB may not be usable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Blueprints use the yamlize package, which uses class attributes to define much of the</span>
        <span class="c1"># class&#39;s behavior through metaclassing. Therefore, we need to be able to import all plugins</span>
        <span class="c1"># before importing blueprints.</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">armi.reactor.blueprints</span><span class="w"> </span><span class="kn">import</span> <span class="n">Blueprints</span>

        <span class="n">bpString</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bpString</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/blueprints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># not all reactors need to be created from blueprints, so they may not exist</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bpString</span><span class="p">:</span>
            <span class="c1"># looks like no blueprints contents</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">bpString</span><span class="p">)</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">Blueprints</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Blueprints</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.writeInputsToDB">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.writeInputsToDB">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">writeInputsToDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">csString</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bpString</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write inputs into the database based the Settings.</span>

<span class="sd">        This is not DRY on purpose. The goal is that any particular Database implementation should</span>
<span class="sd">        be very stable, so we dont want it to be easy to change one Database implementation&#39;s</span>
<span class="sd">        behavior when trying to change another&#39;s.</span>

<span class="sd">        .. impl:: The run settings are saved the settings file.</span>
<span class="sd">            :id: I_ARMI_DB_CS</span>
<span class="sd">            :implements: R_ARMI_DB_CS</span>

<span class="sd">            A ``Settings`` object is passed into this method, and then the settings are converted</span>
<span class="sd">            into a YAML string stream. That stream is then written to the H5 file. Optionally, this</span>
<span class="sd">            method can take a pre-build settings string to be written directly to the file.</span>

<span class="sd">        .. impl:: The reactor blueprints are saved the settings file.</span>
<span class="sd">            :id: I_ARMI_DB_BP</span>
<span class="sd">            :implements: R_ARMI_DB_BP</span>

<span class="sd">            A ``Blueprints`` string is optionally passed into this method, and then written to the</span>
<span class="sd">            H5 file. If it is not passed in, this method will attempt to find the blueprints input</span>
<span class="sd">            file in the settings, and read the contents of that file into a stream to be written to</span>
<span class="sd">            the H5 file.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is hard-coded to read the entire file contents into memory and write that directly into</span>
<span class="sd">        the database. We could have the cs/blueprints/geom write to a string, however the ARMI log</span>
<span class="sd">        file contains a hash of each files&#39; contents. In the future, we should be able to reproduce</span>
<span class="sd">        a calculation with confidence that the inputs are identical.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caseTitle</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span> <span class="k">if</span> <span class="n">cs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;caseTitle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseTitle</span>
        <span class="k">if</span> <span class="n">csString</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># don&#39;t read file; use what&#39;s in the cs now.</span>
            <span class="c1"># Sometimes settings are modified in tests.</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">writeToYamlStream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">csString</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bpString</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bpPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">)</span> <span class="o">/</span> <span class="n">cs</span><span class="p">[</span><span class="n">CONF_LOADING_FILE</span><span class="p">]</span>
            <span class="c1"># only store blueprints if we actually loaded from them</span>
            <span class="k">if</span> <span class="n">bpPath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">bpPath</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="c1"># Ensure that the input as stored in the DB is complete</span>
                <span class="n">bpString</span> <span class="o">=</span> <span class="n">resolveMarkupInclusions</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">)</span> <span class="o">/</span> <span class="n">cs</span><span class="p">[</span><span class="n">CONF_LOADING_FILE</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bpString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csString</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/blueprints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpString</span></div>


<div class="viewcode-block" id="Database.readInputsFromDB">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.readInputsFromDB">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">readInputsFromDB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/settings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/blueprints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()],</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Database.mergeHistory">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.mergeHistory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mergeHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputDB</span><span class="p">,</span> <span class="n">startCycle</span><span class="p">,</span> <span class="n">startNode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy time step data up to, but not including the passed cycle and node.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is used for restart runs with the standard operator for example. The current time step</span>
<span class="sd">        (being loaded from) should not be copied, as that time steps data will be written at the end</span>
<span class="sd">        of the time step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># iterate over the top level H5Groups and copy</span>
        <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">h5ts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inputDB</span><span class="o">.</span><span class="n">genTimeSteps</span><span class="p">(),</span> <span class="n">inputDB</span><span class="o">.</span><span class="n">genTimeStepGroups</span><span class="p">()):</span>
            <span class="n">cyc</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">time</span>
            <span class="k">if</span> <span class="n">cyc</span> <span class="o">==</span> <span class="n">startCycle</span> <span class="ow">and</span> <span class="n">tn</span> <span class="o">==</span> <span class="n">startNode</span><span class="p">:</span>
                <span class="c1"># all data up to current state are merged</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">h5ts</span><span class="p">,</span> <span class="n">h5ts</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inputDB</span><span class="o">.</span><span class="n">versionMinor</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># The source database may have object references in some attributes.</span>
                <span class="c1"># make sure to link those up using our manual path strategy.</span>
                <span class="n">references</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">findReferences</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5r</span><span class="o">.</span><span class="n">Reference</span><span class="p">):</span>
                            <span class="n">references</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">inputDB</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

                <span class="n">h5ts</span><span class="o">.</span><span class="n">visititems</span><span class="p">(</span><span class="n">findReferences</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">references</span><span class="p">:</span>
                    <span class="n">destTs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">h5ts</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">destTs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context management support.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># open also increments _openCount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Typically we don&#39;t care why it broke but we want the DB to close.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="c1"># always close if there is a traceback.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">traceback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
        <span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span> <span class="o">=</span> <span class="n">tn</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<div class="viewcode-block" id="Database.genTimeStepGroups">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.genTimeStepGroups">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">genTimeStepGroups</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">_hl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a generator of HDF5 Groups for all time nodes, or for the passed selection.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must open the database before calling genTimeStepGroups&quot;</span>
        <span class="k">if</span> <span class="n">timeSteps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">groupName</span><span class="p">,</span> <span class="n">h5TimeNodeGroup</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeNodeGroupPattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">groupName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">h5TimeNodeGroup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">timeSteps</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">getH5GroupName</span><span class="p">(</span><span class="o">*</span><span class="n">step</span><span class="p">)]</span></div>


<div class="viewcode-block" id="Database.getLayout">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.getLayout">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a Layout object representing the requested cycle and time node.&quot;&quot;&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versionMinor</span><span class="p">)</span>
        <span class="n">timeGroupName</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Layout</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">timeGroupName</span><span class="p">])</span></div>


<div class="viewcode-block" id="Database.genTimeSteps">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.genTimeSteps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">genTimeSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a generator of (cycle, node) tuples that are present in the DB.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must open the database before calling genTimeSteps&quot;</span>
        <span class="k">for</span> <span class="n">groupName</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeNodeGroupPattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">groupName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">cycle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">node</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.genAuxiliaryData">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.genAuxiliaryData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">genAuxiliaryData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a generator of names of auxiliary data on the requested time point.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must open the database before calling genAuxiliaryData&quot;</span>
        <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="n">groupName</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">timeGroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">groupName</span><span class="p">]</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ArmiObject</span><span class="o">.</span><span class="n">TYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">exclude</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;layout&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">groupName</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">timeGroup</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.getAuxiliaryDataPath">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.getAuxiliaryDataPath">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">getAuxiliaryDataPath</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span></div>


<div class="viewcode-block" id="Database.keys">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.keys">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genTimeStepGroups</span><span class="p">())</span></div>


<div class="viewcode-block" id="Database.getH5Group">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.getH5Group">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getH5Group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the H5Group for the current ARMI timestep.</span>

<span class="sd">        This method can be used to allow other interfaces to place data into the database at the</span>
<span class="sd">        correct timestep.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">groupName</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">groupName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">groupName</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">groupName</span><span class="p">,</span> <span class="n">track_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cycle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span>
            <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;timeNode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span>
            <span class="k">return</span> <span class="n">group</span></div>


<div class="viewcode-block" id="Database.hasTimeStep">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.hasTimeStep">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hasTimeStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if (cycle, timeNode, statePointName) is contained in the database.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span></div>


<div class="viewcode-block" id="Database.writeToDB">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.writeToDB">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">writeToDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Database must be open before writing.&quot;</span>
        <span class="c1"># _createLayout is recursive</span>
        <span class="n">h5group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getH5Group</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing to database for statepoint: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h5group</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span><span class="p">),</span> <span class="n">comp</span><span class="o">=</span><span class="n">reactor</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">writeToDB</span><span class="p">(</span><span class="n">h5group</span><span class="p">)</span>
        <span class="n">groupedComps</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">groupedComps</span>

        <span class="k">for</span> <span class="n">comps</span> <span class="ow">in</span> <span class="n">groupedComps</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_writeParams</span><span class="p">(</span><span class="n">h5group</span><span class="p">,</span> <span class="n">comps</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.syncToSharedFolder">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.syncToSharedFolder">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">syncToSharedFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy DB to run working directory.</span>

<span class="sd">        Needed when multiple MPI processes need to read the same db, for example when a history is</span>
<span class="sd">        needed from independent runs (e.g. for fuel performance on a variety of assemblies).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        At some future point, we may implement a client-server like DB system which would render</span>
<span class="sd">        this kind of operation unnecessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="s2">&quot;Copying DB to shared working directory.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Close the h5 file so it can be copied</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">safeCopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span><span class="p">)</span>

        <span class="c1"># Garbage collect so we don&#39;t have multiple databases hanging around in memory</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Reload the file in append mode and continue on our merry way</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.load">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cycle</span><span class="p">,</span>
        <span class="n">node</span><span class="p">,</span>
        <span class="n">cs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">statePointName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">allowMissing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">handleInvalids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">callReactorConstructionHook</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a new reactor from a DB at (cycle, node).</span>

<span class="sd">        Case settings and blueprints can be provided, or read from the database. Providing these</span>
<span class="sd">        can be useful for snapshot runs or when you want to change settings mid-simulation. Geometry</span>
<span class="sd">        is read from the database.</span>

<span class="sd">        .. impl:: Users can load a reactor from a DB.</span>
<span class="sd">            :id: I_ARMI_DB_TIME1</span>
<span class="sd">            :implements: R_ARMI_DB_TIME</span>

<span class="sd">            This method creates a ``Reactor`` object by reading the reactor state out of an ARMI</span>
<span class="sd">            database file. This is done by passing in mandatory arguments that specify the exact</span>
<span class="sd">            place in time you want to load the reactor from. (That is, the cycle and node numbers.)</span>
<span class="sd">            Users can either pass the settings and blueprints directly into this method, or it will</span>
<span class="sd">            attempt to read them from the database file. The primary work done here is to read the</span>
<span class="sd">            hierarchy of reactor objects from the data file, then reconstruct them in the correct</span>
<span class="sd">            order.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cycle : int</span>
<span class="sd">            Cycle number</span>
<span class="sd">        node : int</span>
<span class="sd">            Time node. If value is negative, will be indexed from EOC backwards like a list.</span>
<span class="sd">        cs : armi.settings.Settings, optional</span>
<span class="sd">            If not provided one is read from the database</span>
<span class="sd">        bp : armi.reactor.Blueprints, optional</span>
<span class="sd">            If not provided one is read from the database</span>
<span class="sd">        statePointName : str, optional</span>
<span class="sd">            Statepoint name (e.g., &quot;special&quot; for &quot;c00n00-special/&quot;)</span>
<span class="sd">        allowMissing : bool, optional</span>
<span class="sd">            Whether to emit a warning, rather than crash if reading a database</span>
<span class="sd">            with undefined parameters. Default False.</span>
<span class="sd">        handleInvalids : bool</span>
<span class="sd">            Whether to check for invalid settings. Default True.</span>
<span class="sd">        callReactorConstructionHook : bool</span>
<span class="sd">            Flag for whether the beforeReactorConstruction plugin hook should be executed. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        root : Reactor</span>
<span class="sd">            The top-level object stored in the database; a Reactor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading reactor state for time node (</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadCS</span><span class="p">(</span><span class="n">handleInvalids</span><span class="o">=</span><span class="n">handleInvalids</span><span class="p">)</span>
        <span class="n">bp</span> <span class="o">=</span> <span class="n">bp</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadBlueprints</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">callReactorConstructionHook</span><span class="p">:</span>
            <span class="n">getPluginManagerOrFail</span><span class="p">()</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">beforeReactorConstruction</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="n">cs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">numNodes</span> <span class="o">=</span> <span class="n">getNodesPerCycle</span><span class="p">(</span><span class="n">cs</span><span class="p">)[</span><span class="n">cycle</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">+</span> <span class="n">numNodes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2"> specified does not exist for cycle </span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">numNodes</span> <span class="o">+</span> <span class="n">node</span>

        <span class="n">h5group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)]</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span><span class="p">),</span> <span class="n">h5group</span><span class="o">=</span><span class="n">h5group</span><span class="p">)</span>
        <span class="n">comps</span><span class="p">,</span> <span class="n">groupedComps</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">_initComps</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span><span class="p">,</span> <span class="n">bp</span><span class="p">)</span>

        <span class="c1"># populate data onto initialized components</span>
        <span class="k">for</span> <span class="n">compType</span><span class="p">,</span> <span class="n">compTypeList</span> <span class="ow">in</span> <span class="n">groupedComps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_readParams</span><span class="p">(</span><span class="n">h5group</span><span class="p">,</span> <span class="n">compType</span><span class="p">,</span> <span class="n">compTypeList</span><span class="p">,</span> <span class="n">allowMissing</span><span class="o">=</span><span class="n">allowMissing</span><span class="p">)</span>

        <span class="c1"># assign params from blueprints</span>
        <span class="k">if</span> <span class="n">bp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assignBlueprintsParams</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">groupedComps</span><span class="p">)</span>

        <span class="c1"># stitch together</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compose</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">comps</span><span class="p">),</span> <span class="n">cs</span><span class="p">)</span>

        <span class="c1"># also, make sure to update the global serial number so we don&#39;t reuse a number</span>
        <span class="n">parameterCollections</span><span class="o">.</span><span class="n">GLOBAL_SERIAL_NUM</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parameterCollections</span><span class="o">.</span><span class="n">GLOBAL_SERIAL_NUM</span><span class="p">,</span> <span class="n">layout</span><span class="o">.</span><span class="n">serialNum</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># return a Reactor object</span>
        <span class="k">if</span> <span class="n">cs</span><span class="p">[</span><span class="n">CONF_SORT_REACTOR</span><span class="p">]:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;DeprecationWarning: This Reactor is not being sorted on DB load. Due to the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;setting </span><span class="si">{</span><span class="n">CONF_SORT_REACTOR</span><span class="si">}</span><span class="s2">, this Reactor is unsorted. But this feature is &quot;</span>
                <span class="s2">&quot;temporary and will be removed by 2024.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">cs</span><span class="p">[</span><span class="n">CONF_GROW_TO_FULL_CORE_AFTER_LOAD</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">isFullCore</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">growToFullCore</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">root</span></div>


<div class="viewcode-block" id="Database.loadReadOnly">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.loadReadOnly">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">loadReadOnly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a new reactor, in read-only mode from a DB at (cycle, node).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cycle : int</span>
<span class="sd">            Cycle number</span>
<span class="sd">        node : int</span>
<span class="sd">            Time node. If value is negative, will be indexed from EOC backwards like a list.</span>
<span class="sd">        statePointName : str, optional</span>
<span class="sd">            Statepoint name (e.g., &quot;special&quot; for &quot;c00n00-special/&quot;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Reactor</span>
<span class="sd">            The top-level object stored in the database; a Reactor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="n">statePointName</span><span class="p">,</span> <span class="n">allowMissing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setParamsBeforeFreezing</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">makeParametersReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_setParamsBeforeFreezing</span><span class="p">(</span><span class="n">r</span><span class="p">:</span> <span class="n">Reactor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set some special case parameters before they are made read-only.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iterChildren</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Component</span><span class="p">)):</span>
            <span class="c1"># calling Component.getVolume() sets the volume parameter</span>
            <span class="n">child</span><span class="o">.</span><span class="n">getVolume</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_assignBlueprintsParams</span><span class="p">(</span><span class="n">blueprints</span><span class="p">,</span> <span class="n">groupedComps</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">compType</span><span class="p">,</span> <span class="n">designs</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">Block</span><span class="p">,</span> <span class="n">blueprints</span><span class="o">.</span><span class="n">blockDesigns</span><span class="p">),</span>
            <span class="p">(</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">blueprints</span><span class="o">.</span><span class="n">assemDesigns</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">paramsToSet</span> <span class="o">=</span> <span class="p">{</span><span class="n">pDef</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pDef</span> <span class="ow">in</span> <span class="n">compType</span><span class="o">.</span><span class="n">pDefs</span><span class="o">.</span><span class="n">inCategory</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">Category</span><span class="o">.</span><span class="n">assignInBlueprints</span><span class="p">)}</span>

            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">groupedComps</span><span class="p">[</span><span class="n">compType</span><span class="p">]:</span>
                <span class="n">design</span> <span class="o">=</span> <span class="n">designs</span><span class="p">[</span><span class="n">comp</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pName</span> <span class="ow">in</span> <span class="n">paramsToSet</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="n">pName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">comp</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">pName</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comps</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a flat collection of all of the ArmiObjects in the model, reconstitute the hierarchy.&quot;&quot;&quot;</span>
        <span class="n">comp</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">numChildren</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span>

        <span class="c1"># attach the parent early, if provided; some cases need the parent attached for the rest of</span>
        <span class="c1"># _compose to work properly.</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c1"># The Reactor adds a Core child by default, this is not ideal</span>
        <span class="k">for</span> <span class="n">spontaneousChild</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">comp</span><span class="p">):</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">spontaneousChild</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Core</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Assembly</span><span class="p">):</span>
            <span class="c1"># Assemblies force their name to be something based on assemNum. When the assembly is</span>
            <span class="c1"># created it gets a new assemNum, and throws out the correct name read from the DB.</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">makeNameFromAssemNum</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">assemNum</span><span class="p">)</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">lastLocationLabel</span> <span class="o">=</span> <span class="n">Assembly</span><span class="o">.</span><span class="n">DATABASE</span>

        <span class="c1"># set the spatialLocators on each component</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">spatialGrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">spatialLocator</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">spatialGrid</span><span class="p">[</span><span class="n">location</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">spatialLocator</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">CoordinateLocation</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">location</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Need to keep a collection of Component instances for linked dimension resolution, before</span>
        <span class="c1"># they can be add()ed to their parents. Not just filtering out of `children`, since</span>
        <span class="c1"># resolveLinkedDims() needs a dict</span>
        <span class="n">childComponents</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numChildren</span><span class="p">):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compose</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span>
            <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Component</span><span class="p">):</span>
                <span class="n">childComponents</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>

        <span class="k">for</span> <span class="n">_childName</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">childComponents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">child</span><span class="o">.</span><span class="n">resolveLinkedDims</span><span class="p">(</span><span class="n">childComponents</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Core</span><span class="p">):</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">processLoading</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">dbLoad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Assembly</span><span class="p">):</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">calculateZCoords</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Component</span><span class="p">):</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">finalizeLoadingFromDB</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">comp</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_getArrayShape</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the shape of a np.ndarray, list, or tuple.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">),)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not a list, tuple, or array (likely int, float, or None)</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_writeParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5group</span><span class="p">,</span> <span class="n">comps</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">groupName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">groupName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5group</span><span class="p">:</span>
            <span class="c1"># Only create the group if it doesn&#39;t already exist. This happens when</span>
            <span class="c1"># re-writing params in the same time node (e.g. something changed between</span>
            <span class="c1"># EveryNode and EOC)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">h5group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">groupName</span><span class="p">,</span> <span class="n">track_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="n">groupName</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">paramDef</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">paramDefs</span><span class="o">.</span><span class="n">toWriteToDB</span><span class="p">():</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;DIMENSION_NAMES&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">DIMENSION_NAMES</span><span class="p">:</span>
                <span class="n">linkedDims</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comps</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">linkedDims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getDimension</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">linkedDims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">linkedDims</span><span class="p">):</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;linkedDims&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">linkedDims</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># NOTE: after loading, the previously unset values will be defaulted</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">default</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">sAttrs</span> <span class="o">=</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> failed to convert </span><span class="si">{}</span><span class="s2"> to a numpy-supported type.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                    <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sAttrs</span><span class="p">)</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="n">_SERIALIZER_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="n">_SERIALIZER_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">version</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># check if temp is a jagged array</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">):</span>
                        <span class="n">jagged</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_getArrayShape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">jagged</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">JaggedArray</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">jagged</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">temp</span>

            <span class="c1"># - Check to see if the array is jagged. If so, flatten, store the data offsets and</span>
            <span class="c1">#   array shapes, and None locations as attrs.</span>
            <span class="c1"># - If not jagged, all top-level ndarrays are the same shape, so it is easier to replace</span>
            <span class="c1">#   Nones with ndarrays filled with special values.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">JaggedArray</span><span class="p">):</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">specialAttrs</span> <span class="o">=</span> <span class="n">packSpecialData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">specialAttrs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># np.ndarray</span>
                <span class="c1"># Convert Unicode to byte-string</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
                    <span class="c1"># Something was added to the data array that caused np to want to</span>
                    <span class="c1"># treat it as a general-purpose Object array. This usually happens</span>
                    <span class="c1"># because:</span>
                    <span class="c1"># - the data contain NoDefaults</span>
                    <span class="c1"># - the data contain one or more Nones,</span>
                    <span class="c1"># - the data contain special types like tuples, dicts, etc</span>
                    <span class="c1"># - there is some sort of honest-to-goodness weird object</span>
                    <span class="c1"># We want to support the first two cases with minimal intrusion, since</span>
                    <span class="c1"># these should be pretty easy to faithfully represent in the db.</span>
                    <span class="c1"># The last case isn&#39;t really worth supporting.</span>

                    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">NoDefault</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">specialAttrs</span> <span class="o">=</span> <span class="n">packSpecialData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">specialAttrs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;`</span><span class="si">{}</span><span class="s2">` was already in `</span><span class="si">{}</span><span class="s2">`. This time node should have been empty&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">dataset</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="n">track_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                    <span class="n">Database</span><span class="o">.</span><span class="n">_writeAttrs</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">h5group</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to write </span><span class="si">{}</span><span class="s2"> to database. Data: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
                <span class="k">raise</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Block</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addHomogenizedNumberDensityParams</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_addHomogenizedNumberDensityParams</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="n">h5group</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create on-the-fly block homog. number density params for XTVIEW viewing.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        collectBlockNumberDensities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nDens</span> <span class="o">=</span> <span class="n">collectBlockNumberDensities</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nucName</span><span class="p">,</span> <span class="n">numDens</span> <span class="ow">in</span> <span class="n">nDens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">nucName</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">numDens</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="n">track_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_readParams</span><span class="p">(</span><span class="n">h5group</span><span class="p">,</span> <span class="n">compTypeName</span><span class="p">,</span> <span class="n">comps</span><span class="p">,</span> <span class="n">allowMissing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="n">compTypeName</span><span class="p">]</span>

        <span class="n">renames</span> <span class="o">=</span> <span class="n">getApp</span><span class="p">()</span><span class="o">.</span><span class="n">getParamRenames</span><span class="p">()</span>

        <span class="n">pDefs</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pDefs</span>

        <span class="c1"># this can also be made faster by specializing the method by type</span>
        <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">dataSet</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Honor historical databases where the parameters may have changed names since.</span>
            <span class="k">while</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">renames</span><span class="p">:</span>
                <span class="n">paramName</span> <span class="o">=</span> <span class="n">renames</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">pDef</span> <span class="o">=</span> <span class="n">pDefs</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^n[A-Z][a-z]?\d*&quot;</span><span class="p">,</span> <span class="n">paramName</span><span class="p">):</span>
                    <span class="c1"># This is a temporary viz param (number density) made by</span>
                    <span class="c1"># _addHomogenizedNumberDensityParams ignore it safely</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If a parameter exists in the database but not in the application</span>
                    <span class="c1"># reading it, we can technically keep going. Since this may lead to</span>
                    <span class="c1"># potential correctness issues, raise a warning</span>
                    <span class="k">if</span> <span class="n">allowMissing</span><span class="p">:</span>
                        <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Found `</span><span class="si">{}</span><span class="s2">` parameter `</span><span class="si">{}</span><span class="s2">` in the database, which is not defined. Ignoring it.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">compTypeName</span><span class="p">,</span> <span class="n">paramName</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">dataSet</span><span class="p">[:]</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">_resolveAttrs</span><span class="p">(</span><span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">h5group</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pDef</span><span class="o">.</span><span class="n">serializer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">_SERIALIZER_NAME</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span>
                <span class="k">assert</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_SERIALIZER_NAME</span><span class="p">]</span> <span class="o">==</span> <span class="n">pDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">assert</span> <span class="n">_SERIALIZER_VERSION</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_SERIALIZER_VERSION</span><span class="p">],</span> <span class="n">attrs</span><span class="p">))</span>

            <span class="c1"># nuclides are a special case where we want to keep in np.bytes_ format</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span> <span class="ow">and</span> <span class="n">paramName</span> <span class="o">!=</span> <span class="s2">&quot;nuclides&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">unpackSpecialData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>

            <span class="n">linkedDims</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s2">&quot;linkedDims&quot;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">linkedDims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;linkedDims&quot;</span><span class="p">])</span>

            <span class="n">unpackedData</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unpackedData</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;While unpacking special data for </span><span class="si">{}</span><span class="s2">, encountered composites and parameter &quot;</span>
                    <span class="s2">&quot;data with unmatched sizes.</span><span class="se">\n</span><span class="s2">Length of composites list = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Length of data &quot;</span>
                    <span class="s2">&quot;list = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">This could indicate an error in data unpacking, which could &quot;</span>
                    <span class="s2">&quot;result in faulty data on the resulting reactor model.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">paramName</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unpackedData</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">paramName</span> <span class="o">==</span> <span class="s2">&quot;numberDensities&quot;</span> <span class="ow">and</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">Database</span><span class="o">.</span><span class="n">_applyComponentNumberDensitiesMigration</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">unpackedData</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># iterating of np is not fast...</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">linkedDim</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">unpackedData</span><span class="p">,</span> <span class="n">linkedDims</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">linkedDim</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span> <span class="o">=</span> <span class="n">linkedDim</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
                        <span class="c1"># happens when a param was deprecated but being loaded from old DB</span>
                        <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ae</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Skipping load of invalid param `</span><span class="si">{</span><span class="n">paramName</span><span class="si">}</span><span class="s2">` (possibly loading from old DB)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

<div class="viewcode-block" id="Database.getHistoryByLocation">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.getHistoryByLocation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getHistoryByLocation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comp</span><span class="p">:</span> <span class="n">ArmiObject</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the parameter histories at a specific location.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHistoriesByLocation</span><span class="p">([</span><span class="n">comp</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeSteps</span><span class="o">=</span><span class="n">timeSteps</span><span class="p">)[</span><span class="n">comp</span><span class="p">]</span></div>


<div class="viewcode-block" id="Database.getHistoriesByLocation">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.getHistoriesByLocation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getHistoriesByLocation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ArmiObject</span><span class="p">],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Histories</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the parameter histories at specific locations.</span>

<span class="sd">        This has a number of limitations, which should in practice not be too limiting:</span>
<span class="sd">         - The passed objects must have IndexLocations. This type of operation doesn&#39;t make much</span>
<span class="sd">           sense otherwise.</span>
<span class="sd">         - The passed objects must exist in a hierarchy that leads to a Core object, which serves as</span>
<span class="sd">           an anchor that can fully define all index locations. This could possibly be made more</span>
<span class="sd">           general by extending grids, but that gets a little more complicated.</span>
<span class="sd">         - All requested objects must exist under the **same** anchor object, and at the same depth</span>
<span class="sd">           below it.</span>
<span class="sd">         - All requested objects must have the same type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comps : list of ArmiObject</span>
<span class="sd">            The components/composites that currently occupy the location that you want histories at.</span>
<span class="sd">            ArmiObjects are passed, rather than locations, because this makes it easier to figure</span>
<span class="sd">            out things related to layout.</span>
<span class="sd">        params : List of str, optional</span>
<span class="sd">            The parameter names for the parameters that we want the history of. If None, all</span>
<span class="sd">            parameter history is given</span>
<span class="sd">        timeSteps : List of (cycle, node) tuples, optional</span>
<span class="sd">            The time nodes that you want history for. If None, all available time nodes will be</span>
<span class="sd">            returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Location-based histories are only supported for db version 3.4 and greater. This &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;database is version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMajor</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">spatialLocator</span><span class="o">.</span><span class="n">getCompleteIndices</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">]</span>

        <span class="n">histData</span><span class="p">:</span> <span class="n">Histories</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">}</span>

        <span class="c1"># Check our assumptions about the passed locations: All locations must have the same parent</span>
        <span class="c1"># and bear the same relationship to the anchor object.</span>
        <span class="n">anchors</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj</span><span class="o">.</span><span class="n">getAncestorAndDistance</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Core</span><span class="p">))</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The passed objects do not have the same anchor or distance to that anchor; &quot;</span>
                <span class="s2">&quot;encountered the following: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">anchorInfo</span> <span class="o">=</span> <span class="n">anchors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">anchorInfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">anchor</span><span class="p">,</span> <span class="n">anchorDistance</span> <span class="o">=</span> <span class="n">anchorInfo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not determine an anchor object for the passed components&quot;</span><span class="p">)</span>

        <span class="n">anchorSerialNum</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">serialNum</span>

        <span class="c1"># All objects of the same type</span>
        <span class="n">objectTypes</span> <span class="o">=</span> <span class="p">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objectTypes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The passed objects must be the same type; got objects of types `</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objectTypes</span><span class="p">))</span>

        <span class="n">compType</span> <span class="o">=</span> <span class="n">objectTypes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">objClassName</span> <span class="o">=</span> <span class="n">compType</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">locToComp</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">spatialLocator</span><span class="o">.</span><span class="n">getCompleteIndices</span><span class="p">():</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">h5TimeNodeGroup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genTimeStepGroups</span><span class="p">(</span><span class="n">timeSteps</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;layout&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5TimeNodeGroup</span><span class="p">:</span>
                <span class="c1"># layout hasn&#39;t been written for this time step, so we can&#39;t get anything useful</span>
                <span class="c1"># here. Perhaps the current value is of use, in which case the DatabaseInterface</span>
                <span class="c1"># should be used.</span>
                <span class="k">continue</span>

            <span class="n">cycle</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cycle&quot;</span><span class="p">]</span>
            <span class="n">timeNode</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;timeNode&quot;</span><span class="p">]</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span><span class="p">),</span> <span class="n">h5group</span><span class="o">=</span><span class="n">h5TimeNodeGroup</span><span class="p">)</span>

            <span class="n">ancestors</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">computeAncestors</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">serialNum</span><span class="p">,</span> <span class="n">layout</span><span class="o">.</span><span class="n">numChildren</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">anchorDistance</span><span class="p">)</span>

            <span class="n">lLocation</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">location</span>
            <span class="c1"># filter for objects that live under the desired ancestor and at a desired location</span>
            <span class="n">objectIndicesInLayout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ancestors</span><span class="p">,</span> <span class="n">lLocation</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">ancestor</span> <span class="o">==</span> <span class="n">anchorSerialNum</span> <span class="ow">and</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locations</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># This could also be way more efficient if lLocation were a numpy array</span>
            <span class="n">objectLocationsInLayout</span> <span class="o">=</span> <span class="p">[</span><span class="n">lLocation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">objectIndicesInLayout</span><span class="p">]</span>

            <span class="n">objectIndicesInData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">indexInData</span><span class="p">)[</span><span class="n">objectIndicesInLayout</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">h5GroupForType</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="p">[</span><span class="n">objClassName</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not found in </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objClassName</span><span class="p">,</span> <span class="n">h5TimeNodeGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">ee</span>

            <span class="k">for</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">or</span> <span class="n">h5GroupForType</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">paramName</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                    <span class="c1"># location is special, since it is stored in layout/</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">location</span><span class="p">)[</span><span class="n">objectIndicesInLayout</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">h5GroupForType</span><span class="p">:</span>
                    <span class="n">dataSet</span> <span class="o">=</span> <span class="n">h5GroupForType</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">dataSet</span><span class="p">[</span><span class="n">objectIndicesInData</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Failed to load index </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objectIndicesInData</span><span class="p">,</span> <span class="n">dataSet</span><span class="p">,</span> <span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">))</span>
                        <span class="p">)</span>
                        <span class="k">raise</span>

                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nones&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonsenseWithNones</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;History tracking for non-None, &quot;</span>
                                <span class="s2">&quot;special-formatted parameters is not supported: &quot;</span>
                                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Nothing in the database for this param, so use the default value</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                        <span class="n">parameters</span><span class="o">.</span><span class="n">byNameAndType</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="n">compType</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># store data to the appropriate comps. This is where taking components</span>
                <span class="c1"># as the argument (rather than locations) is a little bit peculiar.</span>
                <span class="c1">#</span>
                <span class="c1"># At this point, `data` are arranged by the order of elements in</span>
                <span class="c1"># `objectIndicesInData`, which corresponds to the order of</span>
                <span class="c1"># `objectIndicesInLayout`</span>
                <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">objectLocationsInLayout</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
                    <span class="n">comp</span> <span class="o">=</span> <span class="n">locToComp</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span>
                    <span class="n">histData</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">paramName</span><span class="p">][</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">histData</span></div>


<div class="viewcode-block" id="Database.getHistory">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.getHistory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getHistory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comp</span><span class="p">:</span> <span class="n">ArmiObject</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get parameter history for a single ARMI Object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comps</span>
<span class="sd">            An individual ArmiObject</span>
<span class="sd">        params</span>
<span class="sd">            parameters to gather</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary of str/list pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHistories</span><span class="p">([</span><span class="n">comp</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">timeSteps</span><span class="p">)[</span><span class="n">comp</span><span class="p">]</span></div>


<div class="viewcode-block" id="Database.getHistories">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.Database.getHistories">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getHistories</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ArmiObject</span><span class="p">],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Histories</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the parameter histories for a sequence of ARMI Objects.</span>

<span class="sd">        This implementation is unaware of the state of the reactor outside of the database itself,</span>
<span class="sd">        and is therefore not usually what client code should be calling directly during normal ARMI</span>
<span class="sd">        operation. It only knows about historical data that have actually been written to the</span>
<span class="sd">        database. Usually one wants to be able to get historical, plus current data, for which the</span>
<span class="sd">        similar method on the DatabaseInterface may be more useful.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comps</span>
<span class="sd">            Something that is iterable multiple times</span>
<span class="sd">        params</span>
<span class="sd">            parameters to gather.</span>
<span class="sd">        timeSteps</span>
<span class="sd">            Selection of time nodes to get data for. If omitted, return full history</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary ArmiObject (input): dict of str/list pairs containing ((cycle, node), value).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">histData</span><span class="p">:</span> <span class="n">Histories</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">}</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="vm">__class__</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">}</span>
        <span class="n">compsByTypeThenSerialNum</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">ArmiObject</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ArmiObject</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
            <span class="n">compsByTypeThenSerialNum</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="vm">__class__</span><span class="p">][</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">serialNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

        <span class="k">for</span> <span class="n">h5TimeNodeGroup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genTimeStepGroups</span><span class="p">(</span><span class="n">timeSteps</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;layout&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5TimeNodeGroup</span><span class="p">:</span>
                <span class="c1"># Layout hasn&#39;t been written for this time step, so whatever is in there didn&#39;t come</span>
                <span class="c1"># from the DatabaseInterface. Probably because it&#39;s the current time step and</span>
                <span class="c1"># something has created the group to store aux data</span>
                <span class="k">continue</span>

            <span class="c1"># might save as int or np.int64, so forcing int keeps things predictable</span>
            <span class="n">cycle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h5TimeNodeGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cycle&quot;</span><span class="p">])</span>
            <span class="n">timeNode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h5TimeNodeGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;timeNode&quot;</span><span class="p">])</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span><span class="p">),</span> <span class="n">h5group</span><span class="o">=</span><span class="n">h5TimeNodeGroup</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">compType</span><span class="p">,</span> <span class="n">compsBySerialNum</span> <span class="ow">in</span> <span class="n">compsByTypeThenSerialNum</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">compTypeName</span> <span class="o">=</span> <span class="n">compType</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">h5GroupForType</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="p">[</span><span class="n">compTypeName</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
                    <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not found in </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compTypeName</span><span class="p">,</span> <span class="n">h5TimeNodeGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">ee</span>
                <span class="n">layoutIndicesForType</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">compTypeName</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">serialNumsForType</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">serialNum</span><span class="p">[</span><span class="n">layoutIndicesForType</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">layoutIndexInData</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">indexInData</span><span class="p">[</span><span class="n">layoutIndicesForType</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                <span class="n">indexInData</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">reorderedComps</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">sn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layoutIndexInData</span><span class="p">,</span> <span class="n">serialNumsForType</span><span class="p">):</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">compsBySerialNum</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">indexInData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                        <span class="n">reorderedComps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">indexInData</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># note this is very similar to _readParams but there are some important differences.</span>
                <span class="c1"># 1) we are not assigning to p[paramName]</span>
                <span class="c1"># 2) not using linkedDims at all</span>
                <span class="c1"># 3) not performing parameter renaming. This may become necessary</span>
                <span class="k">for</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">or</span> <span class="n">h5GroupForType</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">paramName</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                        <span class="n">locs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">indexInData</span><span class="p">:</span>
                            <span class="n">locs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">layout</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="n">layoutIndicesForType</span><span class="p">[</span><span class="nb">id</span><span class="p">]]))</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">h5GroupForType</span><span class="p">:</span>
                        <span class="n">dataSet</span> <span class="o">=</span> <span class="n">h5GroupForType</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">dataSet</span><span class="p">[</span><span class="n">indexInData</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s2">&quot;Failed to load index </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexInData</span><span class="p">,</span> <span class="n">dataSet</span><span class="p">,</span> <span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">))</span>
                            <span class="p">)</span>
                            <span class="k">raise</span>

                        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nones&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonsenseWithNones</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="s2">&quot;History tracking for non-none special formatting not supported: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">paramName</span><span class="p">,</span>
                                        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Nothing in the database, so use the default value</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                            <span class="n">parameters</span><span class="o">.</span><span class="n">byNameAndType</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="n">compType</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">reorderedComps</span><span class="p">),</span>
                        <span class="p">)</span>

                    <span class="c1"># iterating of np is not fast..</span>
                    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reorderedComps</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">paramName</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                        <span class="n">histData</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">paramName</span><span class="p">][</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getAncestor</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Reactor</span><span class="p">))</span>
        <span class="n">cycleNode</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">paramHistories</span> <span class="ow">in</span> <span class="n">histData</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">paramHistories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">cycleNode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hist</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">hist</span><span class="p">[</span><span class="n">cycleNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">paramName</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                            <span class="n">hist</span><span class="p">[</span><span class="n">cycleNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">spatialLocator</span><span class="o">.</span><span class="n">indices</span>

        <span class="k">return</span> <span class="n">histData</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_writeAttrs</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle safely writing attributes to a dataset, handling large data if necessary.</span>

<span class="sd">        This will attempt to store attributes directly onto an HDF5 object if possible,</span>
<span class="sd">        falling back to proper datasets and reference attributes if necessary. This is</span>
<span class="sd">        needed because HDF5 tries to fit attributes into the object header, which has</span>
<span class="sd">        limited space. If an attribute is too large, h5py raises a RuntimeError.</span>
<span class="sd">        In such cases, this will store the attribute data in a proper dataset and</span>
<span class="sd">        place a reference to that dataset in the attribute instead.</span>

<span class="sd">        In practice, this takes ``linkedDims`` attrs from a particular component type (like</span>
<span class="sd">        ``c00n00/Circle/id``) and stores them in new datasets (like</span>
<span class="sd">        ``c00n00/attrs/1_linkedDims``, ``c00n00/attrs/2_linkedDims``) and then sets the</span>
<span class="sd">        object&#39;s attrs to links to those datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;object header message is too large&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">raise</span>

                <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Storing attribute `</span><span class="si">{}</span><span class="s2">` for `</span><span class="si">{}</span><span class="s2">` into it&#39;s own dataset within `</span><span class="si">{}</span><span class="s2">/attrs`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;attrs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                    <span class="n">attrGroup</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrGroup</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span>
                <span class="n">dataName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">attrGroup</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">key</span>
                <span class="n">attrGroup</span><span class="p">[</span><span class="n">dataName</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                <span class="c1"># using a soft link here allows us to cheaply copy time nodes without needing to</span>
                <span class="c1"># crawl through and update object references.</span>
                <span class="n">linkName</span> <span class="o">=</span> <span class="n">attrGroup</span><span class="p">[</span><span class="n">dataName</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">linkName</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_resolveAttrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverse the action of _writeAttrs.</span>

<span class="sd">        This reads actual attrs and looks for the real data in the datasets that the attrs were</span>
<span class="sd">        pointing to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attr_link</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^@(.*)$&quot;</span><span class="p">)</span>

        <span class="n">resolved</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5r</span><span class="o">.</span><span class="n">Reference</span><span class="p">):</span>
                    <span class="c1"># Old style object reference. If this cannot be dereferenced, it is likely</span>
                    <span class="c1"># because mergeHistory was used to get the current database, which does not</span>
                    <span class="c1"># preserve references.</span>
                    <span class="n">resolved</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">attr_link</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="c1"># dereference the path to get the data out of the dataset.</span>
                        <span class="n">resolved</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)][()]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resolved</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resolved</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HDF error loading </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="se">\n</span><span class="s2">Group: </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="k">return</span> <span class="n">resolved</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_applyComponentNumberDensitiesMigration</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">unpackedData</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Special migration from &lt;= v0.5.1 component numberDensities parameter data type.</span>

<span class="sd">        old format: dict[str: float]</span>
<span class="sd">        new format: two numpy arrays</span>
<span class="sd">        - nuclides = np.array(dtype=&quot;S6&quot;)</span>
<span class="sd">        - numberDensities = np.array(dtype=np.float64)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">ndensDict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">unpackedData</span><span class="p">):</span>
            <span class="n">nuclides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ndensDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;S6&quot;</span><span class="p">)</span>
            <span class="n">numberDensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ndensDict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;nuclides&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nuclides</span>
            <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;numberDensities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numberDensities</span></div>



<div class="viewcode-block" id="packSpecialData">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.packSpecialData">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">packSpecialData</span><span class="p">(</span>
    <span class="n">arrayData</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">JaggedArray</span><span class="p">],</span> <span class="n">paramName</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduce data that wouldn&#39;t otherwise play nicely with HDF5/numpy arrays to a format that will.</span>

<span class="sd">    This is the main entry point for conforming &quot;strange&quot; data into something that will both fit</span>
<span class="sd">    into a numpy array/HDF5 dataset, and be recoverable to its original-ish state when reading it</span>
<span class="sd">    back in. This is accomplished by detecting a handful of known offenders and using various HDF5</span>
<span class="sd">    attributes to store necessary auxiliary data. It is important to keep in mind that the data that</span>
<span class="sd">    is passed in has already been converted to a numpy array, so the top dimension is always</span>
<span class="sd">    representing the collection of composites that are storing the parameters. For instance, if we</span>
<span class="sd">    are dealing with a Block parameter, the first index in the numpy array of data is the block</span>
<span class="sd">    index; so if each block has a parameter that is a dictionary, ``data`` would be a ndarray,</span>
<span class="sd">    where each element is a dictionary. This routine supports a number of different things:</span>

<span class="sd">    * Dict[str, float]: These are stored by finding the set of all keys for all instances, and</span>
<span class="sd">      storing those keys as a list in an attribute. The data themselves are stored as arrays indexed</span>
<span class="sd">      by object, then key index. Dictionaries lacking data for a key store a nan in it&#39;s place. This</span>
<span class="sd">      will work well in instances where most objects have data for most keys.</span>
<span class="sd">    * Jagged arrays: These are stored by concatenating all of the data into a single, one-</span>
<span class="sd">      dimensional array, and storing attributes to describe the shapes of each object&#39;s data, and an</span>
<span class="sd">      offset into the beginning of each object&#39;s data.</span>
<span class="sd">    * Arrays with ``None`` in them: These are stored by replacing each instance of ``None`` with a</span>
<span class="sd">      magical value that shouldn&#39;t be encountered in realistic scenarios.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arrayData</span>
<span class="sd">        An ndarray or JaggedArray object storing the data that we want to stuff into the database.</span>
<span class="sd">        If the data is jagged, a special JaggedArray instance is passed in, which contains a 1D</span>
<span class="sd">        array with offsets and shapes.</span>
<span class="sd">    paramName</span>
<span class="sd">        The parameter name that we are trying to store. This is mostly used for diagnostics.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    unpackSpecialData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arrayData</span><span class="p">,</span> <span class="n">JaggedArray</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">arrayData</span><span class="o">.</span><span class="n">flattenedArray</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check to make sure that we even need to do this. If the numpy data type is not &quot;O&quot;,</span>
        <span class="c1"># chances are we have nice, clean data.</span>
        <span class="k">if</span> <span class="n">arrayData</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arrayData</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">arrayData</span>

    <span class="n">attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="c1"># make a copy of the data, so that the original is unchanged</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Find locations of Nones.</span>
    <span class="n">nones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nones</span><span class="p">)</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># Everything is None, so why bother?</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attrs</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;nones&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Pack different types of data</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># We&#39;re assuming that a dict is {str: float}.</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">k</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">})</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to coerce dictionary data into usable numpy array for </span><span class="si">{</span><span class="n">paramName</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># We store the union of all of the keys for all of the objects as a special &quot;keys&quot;</span>
        <span class="c1"># attribute, and store a value for all of those keys for all objects, whether or not there</span>
        <span class="c1"># is actually data associated with that key</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">attrs</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arrayData</span><span class="p">,</span> <span class="n">JaggedArray</span><span class="p">):</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;jagged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;offsets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arrayData</span><span class="o">.</span><span class="n">offsets</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;shapes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arrayData</span><span class="o">.</span><span class="n">shapes</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;noneLocations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arrayData</span><span class="o">.</span><span class="n">nones</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">attrs</span>

    <span class="c1"># conform non-numpy arrays to numpy</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># looks like 1-D plain-old-data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonesWithNonsense</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">nones</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">attrs</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonesWithNonsense</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">nones</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">attrs</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nones</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot write </span><span class="si">{</span><span class="n">paramName</span><span class="si">}</span><span class="s2"> to the database, it did not resolve to a numpy/HDF5 type.&quot;</span><span class="p">)</span>

    <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data unable to find special none value: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process special data for </span><span class="si">{</span><span class="n">paramName</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="unpackSpecialData">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.unpackSpecialData">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unpackSpecialData</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">paramName</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract data from a specially-formatted HDF5 dataset into a numpy array.</span>

<span class="sd">    This should invert the operations performed by :py:func:`packSpecialData`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        Specially-formatted data array straight from the database.</span>

<span class="sd">    attrs</span>
<span class="sd">        The attributes associated with the dataset that contained the data.</span>

<span class="sd">    paramName</span>
<span class="sd">        The name of the parameter that is being unpacked. Only used for diagnostics.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        An ndarray containing the closest possible representation of the data that was</span>
<span class="sd">        originally written to the database.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    packSpecialData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># The data were not subjected to any special formatting; short circuit.</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;O&quot;</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="n">unpackedData</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nones&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jagged&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonsenseWithNones</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jagged&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;offsets&quot;</span><span class="p">]</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;shapes&quot;</span><span class="p">]</span>
        <span class="n">nones</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;noneLocations&quot;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">JaggedArray</span><span class="o">.</span><span class="n">fromH5</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">nones</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">])</span>
        <span class="n">unpackedData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">unpackedData</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unpackedData</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;Do not recognize the type of special formatting that was applied to </span><span class="si">{}</span><span class="s2">. Attrs: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">paramName</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="collectBlockNumberDensities">
<a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database.html#armi.bookkeeping.db.database.collectBlockNumberDensities">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">collectBlockNumberDensities</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect block-by-block homogenized number densities for each nuclide.</span>

<span class="sd">    Long ago, composition was stored on block params. No longer; they are on the</span>
<span class="sd">    component numberDensity params. These block-level params, are still useful to see</span>
<span class="sd">    compositions in some visualization tools. Rather than keep them on the reactor</span>
<span class="sd">    model, we dynamically compute them here and slap them in the database. These are</span>
<span class="sd">    ignored upon reading and will not affect the results.</span>

<span class="sd">    Remove this once a better viz tool can view composition distributions. Also remove</span>
<span class="sd">    the try/except in ``_readParams``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nucNames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nucName</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span> <span class="k">for</span> <span class="n">nucName</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">getNuclides</span><span class="p">())))</span>
    <span class="n">nucBases</span> <span class="o">=</span> <span class="p">[</span><span class="n">nuclideBases</span><span class="o">.</span><span class="n">byName</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span> <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">nucNames</span><span class="p">]</span>
    <span class="c1"># it&#39;s faster to loop over blocks first and get all number densities from each</span>
    <span class="c1"># than it is to get one nuclide at a time from each block because of area fraction</span>
    <span class="c1"># calculations. So we use some RAM here instead.</span>
    <span class="n">nucDensityMatrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
        <span class="n">nucDensityMatrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">getNuclideNumberDensities</span><span class="p">(</span><span class="n">nucNames</span><span class="p">))</span>
    <span class="n">nucDensityMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nucDensityMatrix</span><span class="p">)</span>

    <span class="n">dataDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ni</span><span class="p">,</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nucBases</span><span class="p">):</span>
        <span class="c1"># the nth column is a vector of nuclide densities for this nuclide across all blocks</span>
        <span class="n">dataDict</span><span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">getDatabaseName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">nucDensityMatrix</span><span class="p">[:,</span> <span class="n">ni</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dataDict</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2009-2025, TerraPower, LLC.
      <span class="lastupdated">Last updated on 2025-07-23.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>