

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>armi.bookkeeping.db.database3 &mdash; ARMI 0.2.3 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/theme_fixes.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery-dataframe.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/armiicon_16x16.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="../../../../_static/assets/jsonview.bundle.js"></script>
        <script src="../../../../_static/assets/jsonview_loader.js"></script>
        <script src="../../../../_static/sphinx-needs/libs/html/datatables.min.js"></script>
        <script src="../../../../_static/sphinx-needs/libs/html/datatables_loader.js"></script>
        <script src="../../../../_static/sphinx-needs/libs/html/sphinx_needs_collapse.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #233C5B" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> ARMI
          

          
            
            <img src="../../../../_static/armiicon_24x24.ico" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.2.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/index.html">User Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer/index.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../release/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../requirements/index.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../.apidocs/modules.html">API Docs</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ARMI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../armi.html">armi</a> &raquo;</li>
        
          <li><a href="../../bookkeeping.html">armi.bookkeeping</a> &raquo;</li>
        
          <li><a href="../db.html">armi.bookkeeping.db</a> &raquo;</li>
        
      <li>armi.bookkeeping.db.database3</li>
    
    
  <li class="wy-breadcrumbs-aside">
    
  </li>

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for armi.bookkeeping.db.database3</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2019 TerraPower, LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ARMI Database implementation, version 3.</span>

<span class="sd">This Implementation of the database is a significant departure from the previous. One of</span>
<span class="sd">the foundational concepts in this version is that a reactor model should be fully</span>
<span class="sd">recoverable from the database itself; all the way down to the component level. As a</span>
<span class="sd">result, the structure of the underlying data is bound to the hierarchical Composite</span>
<span class="sd">Reactor Model, rather than an ad hoc collection of Block parameter fields and other</span>
<span class="sd">parameters. Furthermore, this format is intended to be more dynamic, permitting as-yet</span>
<span class="sd">undeveloped levels and classes in the Composite Reactor Model to be supported as they</span>
<span class="sd">are added. More high-level discussion is contained in :doc:`/user/outputs/database`.</span>

<span class="sd">The most important contents of this module are the :py:class:`DatabaseInterface`, the</span>
<span class="sd">:py:class:`Database3` class, the :py:class:`Layout` class, and the special data</span>
<span class="sd">packing/unpacking functions. The ``Database3`` class contains most of the functionality</span>
<span class="sd">for interacting with the underlying data. This includes things like dumping a Reactor</span>
<span class="sd">state to the database and loading it back again, as well as extracting historical data</span>
<span class="sd">for a given object or collection of object from the database file. When interacting with</span>
<span class="sd">the database file, the ``Layout`` class is used to help map the hierarchical Composite</span>
<span class="sd">Reactor Model to the flat representation in the database.</span>

<span class="sd">Refer to :py:mod:`armi.bookkeeping.db` for notes about versioning.</span>

<span class="sd">Minor revision changelog</span>
<span class="sd">------------------------</span>
<span class="sd"> - 3.1: Improve the handling of reading/writing grids.</span>

<span class="sd"> - 3.2: Change the strategy for storing large attributes from using an Object Reference</span>
<span class="sd">   to an external dataset to using a special string starting with an &quot;@&quot; symbol (e.g.,</span>
<span class="sd">   &quot;@/c00n00/attrs/5_linkedDims&quot;). This was done to support copying time node datasets</span>
<span class="sd">   from one file to another without invalidating the references. Support is maintained</span>
<span class="sd">   for reading previous versions, and for performing a ``mergeHistory()`` and converting</span>
<span class="sd">   to the new reference strategy, but the old version cannot be written.</span>

<span class="sd"> - 3.3: Compress the way locations are stored in the database and allow MultiIndex</span>
<span class="sd">   locations to be read and written.</span>

<span class="sd"> - 3.4: Modified the way that locations are stored in the database to include complete</span>
<span class="sd">   indices for indices that can be composed from multiple grids. This was done since the</span>
<span class="sd">   space is already being used to be able to store them, and because having complete</span>
<span class="sd">   indices allows for more efficient means of extracting information based on location</span>
<span class="sd">   without having to compose the full model.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">platform</span> <span class="kn">import</span> <span class="n">uname</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">MutableSequence</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">import</span> <span class="nn">armi</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">interfaces</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">runLog</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">armi.reactor</span> <span class="kn">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">armi.reactor.parameters</span> <span class="kn">import</span> <span class="n">parameterCollections</span>
<span class="kn">from</span> <span class="nn">armi.reactor.parameters</span> <span class="kn">import</span> <span class="n">parameterDefinitions</span>
<span class="kn">from</span> <span class="nn">armi.reactor.flags</span> <span class="kn">import</span> <span class="n">Flags</span>
<span class="kn">from</span> <span class="nn">armi.reactor.reactors</span> <span class="kn">import</span> <span class="n">Reactor</span><span class="p">,</span> <span class="n">Core</span>
<span class="kn">from</span> <span class="nn">armi.reactor</span> <span class="kn">import</span> <span class="n">assemblies</span>
<span class="kn">from</span> <span class="nn">armi.reactor.assemblies</span> <span class="kn">import</span> <span class="n">Assembly</span>
<span class="kn">from</span> <span class="nn">armi.reactor.blocks</span> <span class="kn">import</span> <span class="n">Block</span>
<span class="kn">from</span> <span class="nn">armi.reactor.components</span> <span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">armi.reactor.composites</span> <span class="kn">import</span> <span class="n">ArmiObject</span>
<span class="kn">from</span> <span class="nn">armi.reactor</span> <span class="kn">import</span> <span class="n">grids</span>
<span class="kn">from</span> <span class="nn">armi.bookkeeping.db.typedefs</span> <span class="kn">import</span> <span class="n">History</span><span class="p">,</span> <span class="n">Histories</span>
<span class="kn">from</span> <span class="nn">armi.bookkeeping.db</span> <span class="kn">import</span> <span class="n">database</span>
<span class="kn">from</span> <span class="nn">armi.reactor</span> <span class="kn">import</span> <span class="n">systemLayoutInput</span>
<span class="kn">from</span> <span class="nn">armi.utils.textProcessors</span> <span class="kn">import</span> <span class="n">resolveMarkupInclusions</span>
<span class="kn">from</span> <span class="nn">armi.nucDirectory</span> <span class="kn">import</span> <span class="n">nuclideBases</span>
<span class="kn">from</span> <span class="nn">armi.settings.fwSettings.databaseSettings</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONF_SYNC_AFTER_WRITE</span><span class="p">,</span>
    <span class="n">CONF_FORCE_DB_PARAMS</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ORDER</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">STACK_ORDER</span><span class="o">.</span><span class="n">BOOKKEEPING</span>
<span class="n">DB_MAJOR</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">DB_MINOR</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">DB_VERSION</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DB_MAJOR</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">DB_MINOR</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">ATTR_LINK</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^@(.*)$&quot;</span><span class="p">)</span>

<span class="n">_SERIALIZER_NAME</span> <span class="o">=</span> <span class="s2">&quot;serializerName&quot;</span>
<span class="n">_SERIALIZER_VERSION</span> <span class="o">=</span> <span class="s2">&quot;serializerVersion&quot;</span>

<span class="n">LOC_NONE</span> <span class="o">=</span> <span class="s2">&quot;N&quot;</span>
<span class="n">LOC_COORD</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
<span class="n">LOC_INDEX</span> <span class="o">=</span> <span class="s2">&quot;I&quot;</span>
<span class="n">LOC_MULTI</span> <span class="o">=</span> <span class="s2">&quot;M:&quot;</span>

<span class="n">LOCATION_TYPE_LABELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> <span class="n">LOC_NONE</span><span class="p">,</span>
    <span class="n">grids</span><span class="o">.</span><span class="n">CoordinateLocation</span><span class="p">:</span> <span class="n">LOC_COORD</span><span class="p">,</span>
    <span class="n">grids</span><span class="o">.</span><span class="n">IndexLocation</span><span class="p">:</span> <span class="n">LOC_INDEX</span><span class="p">,</span>
    <span class="n">grids</span><span class="o">.</span><span class="n">MultiIndexLocation</span><span class="p">:</span> <span class="n">LOC_MULTI</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="getH5GroupName"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.getH5GroupName">[docs]</a><span class="k">def</span> <span class="nf">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;c</span><span class="si">{:0&gt;2}</span><span class="s2">n</span><span class="si">{:0&gt;2}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="describeInterfaces"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.describeInterfaces">[docs]</a><span class="k">def</span> <span class="nf">describeInterfaces</span><span class="p">(</span><span class="n">cs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function for exposing interface(s) to other code&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">DatabaseInterface</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">cs</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]})</span></div>


<div class="viewcode-block" id="updateGlobalAssemblyNum"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.updateGlobalAssemblyNum">[docs]</a><span class="k">def</span> <span class="nf">updateGlobalAssemblyNum</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">assemNum</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">maxAssemNum</span>
    <span class="k">if</span> <span class="n">assemNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">assemblies</span><span class="o">.</span><span class="n">setAssemNumCounter</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">assemNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not load maxAssemNum from the database&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseInterface"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface">[docs]</a><span class="k">class</span> <span class="nc">DatabaseInterface</span><span class="p">(</span><span class="n">interfaces</span><span class="o">.</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles interactions between the ARMI data model and the persistent data storage</span>
<span class="sd">    system.</span>

<span class="sd">    This reads/writes the ARMI state to/from the database and helps derive state</span>
<span class="sd">    information that can be derived.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;database&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">cs</span><span class="p">):</span>
        <span class="n">interfaces</span><span class="o">.</span><span class="n">Interface</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">cs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">cs</span><span class="p">[</span><span class="n">CONF_FORCE_DB_PARAMS</span><span class="p">]:</span>
            <span class="n">toSet</span> <span class="o">=</span> <span class="p">{</span><span class="n">paramName</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">[</span><span class="n">CONF_FORCE_DB_PARAMS</span><span class="p">]}</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">pDef</span> <span class="ow">in</span> <span class="n">parameterDefinitions</span><span class="o">.</span><span class="n">ALL_DEFINITIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">toSet</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">toSet</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pDef</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">pDefs</span> <span class="ow">in</span> <span class="n">toSet</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Forcing parameter </span><span class="si">{}</span><span class="s2"> to be written to the database, per user &quot;</span>
                    <span class="s2">&quot;input&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">pDef</span> <span class="ow">in</span> <span class="n">pDefs</span><span class="p">:</span>
                    <span class="n">pDef</span><span class="o">.</span><span class="n">saveToDB</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2"> &#39;</span><span class="si">{}</span><span class="s2">&#39; </span><span class="si">{}</span><span class="s2"> &gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Presents the internal database object, if it exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;The Database interface has not yet created a database &quot;</span>
                <span class="s2">&quot;object. InteractBOL or loadState must be called first.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="DatabaseInterface.interactBOL"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.interactBOL">[docs]</a>    <span class="k">def</span> <span class="nf">interactBOL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the database if the main interface was not available. (Begining of Life)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initDB</span><span class="p">()</span></div>

<div class="viewcode-block" id="DatabaseInterface.initDB"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.initDB">[docs]</a>    <span class="k">def</span> <span class="nf">initDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fName</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the underlying database to be written to, and write input files to DB.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Main Interface calls this so that the database is available as early as</span>
<span class="sd">        possible in the run. The database interface interacts near the end of the</span>
<span class="sd">        interface stack (so that all the parameters have been updated) while the Main</span>
<span class="sd">        Interface interacts first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span> <span class="o">+</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">fName</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;reloadDBName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbPath</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;It appears that reloadDBName is the same as the case &quot;</span>
                <span class="s2">&quot;title. This could lead to data loss! Rename the reload DB or the &quot;</span>
                <span class="s2">&quot;case.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">Database3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbPath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="c1"># Grab geomString here because the DB-level has no access to the reactor or</span>
        <span class="c1"># blueprints or anything.</span>
        <span class="c1"># There&#39;s not always a geomFile; we are moving towards the core grid definition</span>
        <span class="c1"># living in the blueprints themselves. In this case, the db doesnt need to store</span>
        <span class="c1"># a geomFile at all.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;geomFile&quot;</span><span class="p">]:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;geomFile&quot;</span><span class="p">]))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">geomString</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geomString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">writeInputsToDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="n">geomString</span><span class="o">=</span><span class="n">geomString</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseInterface.interactEveryNode"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.interactEveryNode">[docs]</a>    <span class="k">def</span> <span class="nf">interactEveryNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write to database.</span>

<span class="sd">        DBs should receive the state information of the run at each node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># skip writing for last burn step since it will be written at interact EOC</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;burnSteps&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">minutesSinceStart</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">timeOfStart</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">writeToDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_SYNC_AFTER_WRITE</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">syncToSharedFolder</span><span class="p">()</span></div>

<div class="viewcode-block" id="DatabaseInterface.interactEOC"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.interactEOC">[docs]</a>    <span class="k">def</span> <span class="nf">interactEOC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;In case anything changed since last cycle (e.g. rxSwing), update DB. (End of Cycle)&quot;&quot;&quot;</span>
        <span class="c1"># We cannot presume whether we are at EOL based on cycle and cs[&quot;nCycles&quot;],</span>
        <span class="c1"># since cs[&quot;nCycles&quot;] is not a difinitive indicator of EOL; ultimately the</span>
        <span class="c1"># Operator has the final say.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">atEOL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">minutesSinceStart</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">timeOfStart</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">writeToDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseInterface.interactEOL"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.interactEOL">[docs]</a>    <span class="k">def</span> <span class="nf">interactEOL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DB&#39;s should be closed at run&#39;s end. (End of Life)&quot;&quot;&quot;</span>
        <span class="c1"># minutesSinceStarts should include as much of the ARMI run as possible so EOL</span>
        <span class="c1"># is necessary, too.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">minutesSinceStart</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">timeOfStart</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">writeToDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseInterface.interactError"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.interactError">[docs]</a>    <span class="k">def</span> <span class="nf">interactError</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get shutdown state information even if the run encounters an error&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">minutesSinceStart</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">timeOfStart</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span>

            <span class="c1"># this can result in a double-error if the error occurred in the database</span>
            <span class="c1"># writing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">writeToDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except; we&#39;re already responding to an error</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="DatabaseInterface.interactDistributeState"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.interactDistributeState">[docs]</a>    <span class="k">def</span> <span class="nf">interactDistributeState</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconnect to pre-existing database.</span>

<span class="sd">        DB is created and managed by the master node only but we can still connect to it</span>
<span class="sd">        from workers to enable things like history tracking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">armi</span><span class="o">.</span><span class="n">MPI_RANK</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># DB may not exist if distribute state is called early.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbPath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbPath</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">Database3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbPath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span></div>

<div class="viewcode-block" id="DatabaseInterface.distributable"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.distributable">[docs]</a>    <span class="k">def</span> <span class="nf">distributable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Distribute</span><span class="o">.</span><span class="n">SKIP</span></div>

<div class="viewcode-block" id="DatabaseInterface.prepRestartRun"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.prepRestartRun">[docs]</a>    <span class="k">def</span> <span class="nf">prepRestartRun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbCycle</span><span class="p">,</span> <span class="n">dbNode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the data history from the database being restarted from.&quot;&quot;&quot;</span>
        <span class="n">reloadDBName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;reloadDBName&quot;</span><span class="p">]</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Merging database history from </span><span class="si">{</span><span class="n">reloadDBName</span><span class="si">}</span><span class="s2"> for restart analysis.&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">Database3</span><span class="p">(</span><span class="n">reloadDBName</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputDB</span><span class="p">:</span>
            <span class="n">loadDbCs</span> <span class="o">=</span> <span class="n">inputDB</span><span class="o">.</span><span class="n">loadCS</span><span class="p">()</span>

            <span class="c1"># Not beginning or end of cycle so burnSteps matter to get consistent time.</span>
            <span class="n">isMOC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;startNode&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">loadDbCs</span><span class="p">[</span><span class="s2">&quot;burnSteps&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">loadDbCs</span><span class="p">[</span><span class="s2">&quot;burnSteps&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;burnSteps&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">isMOC</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Time nodes per cycle are inconsistent between loadDB and &quot;</span>
                    <span class="s2">&quot;current case settings. This will create a mismatch in the &quot;</span>
                    <span class="s2">&quot;total time per cycle for the load cycle. Change current case &quot;</span>
                    <span class="s2">&quot;settings to </span><span class="si">{0}</span><span class="s2"> steps per node, or set `startNode` == 0 or </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;so that it loads the BOC or EOC of the load database.&quot;</span>
                    <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loadDbCs</span><span class="p">[</span><span class="s2">&quot;burnSteps&quot;</span><span class="p">])</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">mergeHistory</span><span class="p">(</span><span class="n">inputDB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;startCycle&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;startNode&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadState</span><span class="p">(</span><span class="n">dbCycle</span><span class="p">,</span> <span class="n">dbNode</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_getLoadDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the database to load from in order of preference.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If filename is present only returns one database since specifically instructed</span>
<span class="sd">        to load from that database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># only yield 1 database if the file name is specified</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fileName</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_fileName</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">Database3</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;reloadDBName&quot;</span><span class="p">]):</span>
                <span class="k">yield</span> <span class="n">Database3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;reloadDBName&quot;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DatabaseInterface.loadState"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.loadState">[docs]</a>    <span class="k">def</span> <span class="nf">loadState</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">timeStepName</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">updateGlobalAssemNum</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a fresh reactor and applies it to the Operator.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Will load preferentially from the `fileName` if passed. Otherwise will load from</span>
<span class="sd">        existing database in memory or `cs[&quot;reloadDBName&quot;]` in that order.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If fileName is specified and that  file does not have the time step.</span>
<span class="sd">            If fileName is not specified and neither the database in memory, nor the</span>
<span class="sd">            `cs[&quot;reloadDBName&quot;]` have the time step specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">potentialDatabase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLoadDB</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">potentialDatabase</span> <span class="k">as</span> <span class="n">loadDB</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loadDB</span><span class="o">.</span><span class="n">hasTimeStep</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="n">timeStepName</span><span class="p">):</span>
                    <span class="n">newR</span> <span class="o">=</span> <span class="n">loadDB</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="n">cycle</span><span class="p">,</span>
                        <span class="n">timeNode</span><span class="p">,</span>
                        <span class="n">statePointName</span><span class="o">=</span><span class="n">timeStepName</span><span class="p">,</span>
                        <span class="n">cs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span>
                        <span class="n">bp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">blueprints</span><span class="p">,</span>
                        <span class="n">allowMissing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># reactor was never set so fail</span>
            <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot load state from specified file </span><span class="si">{}</span><span class="s2"> @ </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">fileName</span><span class="p">,</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">timeStepName</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot load state from &lt;unspecified file&gt; @ </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">timeStepName</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">updateGlobalAssemNum</span><span class="p">:</span>
            <span class="n">updateGlobalAssemblyNum</span><span class="p">(</span><span class="n">newR</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">reattach</span><span class="p">(</span><span class="n">newR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseInterface.getHistory"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.getHistory">[docs]</a>    <span class="k">def</span> <span class="nf">getHistory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comp</span><span class="p">:</span> <span class="n">ArmiObject</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MutableSequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">byLocation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get historical parameter values for a single object.</span>

<span class="sd">        This is mostly a wrapper around the same function on the ``Database3`` class,</span>
<span class="sd">        but knows how to return the current value as well.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Database3.getHistory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make a copy so that we can potentially remove timesteps without affecting the</span>
        <span class="c1"># caller</span>
        <span class="n">timeSteps</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">timeSteps</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span><span class="p">)</span>
        <span class="n">nowRequested</span> <span class="o">=</span> <span class="n">timeSteps</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">timeSteps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">now</span> <span class="ow">in</span> <span class="n">timeSteps</span><span class="p">:</span>
            <span class="n">nowRequested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">timeSteps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">byLocation</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">getHistoryByLocation</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">timeSteps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">getHistory</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">timeSteps</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nowRequested</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">or</span> <span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                    <span class="n">history</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">now</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">spatialLocator</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">history</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">now</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">history</span></div>

<div class="viewcode-block" id="DatabaseInterface.getHistories"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.DatabaseInterface.getHistories">[docs]</a>    <span class="k">def</span> <span class="nf">getHistories</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ArmiObject</span><span class="p">],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MutableSequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">byLocation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Histories</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get historical parameter values for one or more objects.</span>

<span class="sd">        This is mostly a wrapper around the same function on the ``Database3`` class,</span>
<span class="sd">        but knows how to return the current value as well.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Database3.getHistories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span><span class="p">)</span>
        <span class="n">nowRequested</span> <span class="o">=</span> <span class="n">timeSteps</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">timeSteps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># make a copy so that we can potentially remove timesteps without affecting</span>
            <span class="c1"># the caller</span>
            <span class="n">timeSteps</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">timeSteps</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timeSteps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">now</span> <span class="ow">in</span> <span class="n">timeSteps</span><span class="p">:</span>
            <span class="n">nowRequested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">timeSteps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">byLocation</span><span class="p">:</span>
            <span class="n">histories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">getHistoriesByLocation</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">timeSteps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">histories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">getHistories</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">timeSteps</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nowRequested</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">or</span> <span class="n">histories</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                        <span class="n">histories</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">now</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">spatialLocator</span><span class="o">.</span><span class="n">indices</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">histories</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">now</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">histories</span></div></div>


<div class="viewcode-block" id="Database3"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3">[docs]</a><span class="k">class</span> <span class="nc">Database3</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">Database</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Version 3 of the ARMI Database, handling serialization and loading of Reactor states.</span>

<span class="sd">    This implementation of the database pushes all objects in the Composite Reactor</span>
<span class="sd">    Model into the database. This process is aided by the ``Layout`` class, which</span>
<span class="sd">    handles the packing and unpacking of the structure of the objects, their</span>
<span class="sd">    relationships, and their non-parameter attributes.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    `doc/user/outputs/database` for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">timeNodeGroupPattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^c(\d\d)n(\d\d)$&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new Database3 object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileName:</span>
<span class="sd">            name of the file</span>

<span class="sd">        permission:</span>
<span class="sd">            file permissions, write (&quot;w&quot;) or read (&quot;r&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span> <span class="o">=</span> <span class="n">fileName</span>
        <span class="c1"># No full path yet; we will determine this based on FAST_PATH and permissions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="o">=</span> <span class="n">permission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Allows context management on open files.</span>
        <span class="c1"># If context management is used on a file that is already open, it will not reopen</span>
        <span class="c1"># and it will also not close after leaving that context.</span>
        <span class="c1"># This allows the treatment of all databases the same whether they are open or</span>
        <span class="c1"># closed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">permission</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">DB_VERSION</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># will be set upon read</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_versionMajor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_versionMinor</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

    <span class="nd">@version</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versionMinor</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">versionMajor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versionMajor</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">versionMinor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versionMinor</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Database3.open"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;This database is already open; make sure to close it &quot;</span>
                <span class="s2">&quot;before trying to open it again.&quot;</span>
            <span class="p">)</span>
        <span class="n">filePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;databaseVersion&quot;</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
            <span class="c1"># assume fast path!</span>
            <span class="n">filePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">getFastPath</span><span class="p">(),</span> <span class="n">filePath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unrecognized file permissions `</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot open database with permission `</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Opening database file at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filePath</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;successfulCompletion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">armi</span><span class="o">.</span><span class="n">__version__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;databaseVersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">armi</span><span class="o">.</span><span class="n">USER</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;armiLocation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">armi</span><span class="o">.</span><span class="n">ROOT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;startTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">armi</span><span class="o">.</span><span class="n">START_TIME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;machines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">armi</span><span class="o">.</span><span class="n">MPI_NODENAMES</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
        <span class="c1"># store platform data</span>
        <span class="n">platform_data</span> <span class="o">=</span> <span class="n">uname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;platformRelease&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;platformVersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;platformArch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">.</span><span class="n">processor</span>
        <span class="c1"># store app and plugin data</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">armi</span><span class="o">.</span><span class="n">getApp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;appName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">name</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">pluginManager</span><span class="o">.</span><span class="n">list_name_plugin</span><span class="p">()</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plugins</span>
        <span class="p">]</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;pluginPaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps</span>
        <span class="c1"># store the commit hash of the local repo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;localCommitHash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Database3</span><span class="o">.</span><span class="n">grabLocalCommitHash</span><span class="p">()</span></div>

<div class="viewcode-block" id="Database3.grabLocalCommitHash"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.grabLocalCommitHash">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">grabLocalCommitHash</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to determine the local Git commit.</span>

<span class="sd">        We have to be sure to handle the errors where the code is run on a system that</span>
<span class="sd">        doesn&#39;t have Git installed. Or if the code is simply not run from inside a repo.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The commit hash if it exists, otherwise &quot;unknown&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">):</span>
            <span class="c1"># no git available. cannot check git info</span>
            <span class="k">return</span> <span class="n">unknown</span>
        <span class="n">repo_exists</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="s2">&quot;git rev-parse --git-dir&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">returncode</span>
            <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;describe&quot;</span><span class="p">],</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">returncode</span>
            <span class="o">==</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">repo_exists</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">commit_hash</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;describe&quot;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">commit_hash</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">unknown</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unknown</span></div>

<div class="viewcode-block" id="Database3.close"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completedSuccessfully</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the DB and perform cleanups and auto-conversions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;successfulCompletion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">completedSuccessfully</span>
            <span class="c1"># a bit redundant to call flush, but with unreliable IO issues, why not?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
            <span class="c1"># move out of the FAST_PATH and into the working directory</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database3.splitDatabase"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.splitDatabase">[docs]</a>    <span class="k">def</span> <span class="nf">splitDatabase</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">keepTimeSteps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discard all data except for specific time steps, retaining old data in a separate file.</span>

<span class="sd">        This is useful when performing more exotic analyses, where each &quot;time step&quot; may</span>
<span class="sd">        not represent a specific point in time, but something more nuanced. For example,</span>
<span class="sd">        equilibrium cases store a new &quot;cycle&quot; for each iteration as it attempts to</span>
<span class="sd">        converge the equilibrium cycle. At the end of the run, the last &quot;cycle&quot; is the</span>
<span class="sd">        converged equilibrium cycle, whereas the previous cycles constitute the path to</span>
<span class="sd">        convergence, which we typically wish to discard before further analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keepTimeSteps</span>
<span class="sd">            A collection of the time steps to retain</span>

<span class="sd">        label</span>
<span class="sd">            An informative label for the backed-up database. Usually something like</span>
<span class="sd">            &quot;-all-iterations&quot;. Will be interposed between the source name and the &quot;.h5&quot;</span>
<span class="sd">            extension.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The name of the new, backed-up database file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is no open database to split.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">backupDBPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span><span class="p">)))</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retaining full database history in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backupDBPath</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">,</span> <span class="n">backupDBPath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permission</span><span class="p">)</span>
        <span class="n">dbOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">backupDBPath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dbIn</span><span class="p">:</span>
            <span class="n">dbOut</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dbIn</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>

            <span class="c1"># Copy everything except time node data</span>
            <span class="n">timeSteps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">groupName</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dbIn</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeNodeGroupPattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">groupName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">timeSteps</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dbIn</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">groupName</span><span class="p">,</span> <span class="n">dbOut</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">keepTimeSteps</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">timeSteps</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Not all desired time steps (</span><span class="si">{}</span><span class="s2">) are even present in the &quot;</span>
                    <span class="s2">&quot;database&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keepTimeSteps</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">minCycle</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">keepTimeSteps</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">keepTimeSteps</span><span class="p">:</span>
                <span class="n">offsetCycle</span> <span class="o">=</span> <span class="n">cycle</span> <span class="o">-</span> <span class="n">minCycle</span>
                <span class="n">offsetGroupName</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">offsetCycle</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="n">dbIn</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">),</span> <span class="n">dbOut</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">offsetGroupName</span><span class="p">)</span>
                <span class="n">dbOut</span><span class="p">[</span><span class="n">offsetGroupName</span> <span class="o">+</span> <span class="s2">&quot;/Reactor/cycle&quot;</span><span class="p">][()]</span> <span class="o">=</span> <span class="n">offsetCycle</span>

        <span class="k">return</span> <span class="n">backupDBPath</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fileName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span>

    <span class="nd">@fileName</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">fileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fName</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot change Database file name while it&#39;s opened!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span> <span class="o">=</span> <span class="n">fName</span>

<div class="viewcode-block" id="Database3.loadCS"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.loadCS">[docs]</a>    <span class="k">def</span> <span class="nf">loadCS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to load settings from the database file</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        There are no guarantees here. If the database was written from a different version of ARMI than you are using,</span>
<span class="sd">        these results may not be usable. For instance, the database could have been written from a vastly old or future</span>
<span class="sd">        version of ARMI from the code you are using.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">loadFromString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/settings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># not all paths to writing a database require inputs to be written to the</span>
            <span class="c1"># database. Technically, settings do affect some of the behavior of database</span>
            <span class="c1"># reading, so not having the settings that made the reactor that went into</span>
            <span class="c1"># the database is not ideal. However, this isn&#39;t the right place to crash</span>
            <span class="c1"># into it. Ideally, there would be not way to not have the settings in the</span>
            <span class="c1"># database (force writing in writeToDB), or to make reading invariant to</span>
            <span class="c1"># settings.</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">cs</span></div>

<div class="viewcode-block" id="Database3.loadBlueprints"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.loadBlueprints">[docs]</a>    <span class="k">def</span> <span class="nf">loadBlueprints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to load reactor blueprints from the database file</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        There are no guarantees here. If the database was written from a different version of ARMI than you are using,</span>
<span class="sd">        these results may not be usable. For instance, the database could have been written from a vastly old or future</span>
<span class="sd">        version of ARMI from the code you are using.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Blueprints use the yamlize package, which uses class attributes to define much of the class&#39;s behavior</span>
        <span class="c1"># through metaclassing. Therefore, we need to be able to import all plugins *before* importing blueprints.</span>
        <span class="kn">from</span> <span class="nn">armi.reactor.blueprints</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Blueprints</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>

        <span class="n">bpString</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bpString</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/blueprints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># not all reactors need to be created from blueprints, so they may not exist</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bpString</span><span class="p">:</span>
            <span class="c1"># looks like no blueprints contents</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">bpString</span><span class="p">)</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">Blueprints</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

        <span class="n">bp</span> <span class="o">=</span> <span class="n">Blueprints</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bp</span></div>

<div class="viewcode-block" id="Database3.loadGeometry"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.loadGeometry">[docs]</a>    <span class="k">def</span> <span class="nf">loadGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is primarily just used for migrations.</span>
<span class="sd">        The &quot;geometry files&quot; were replaced by ``systems:`` and ``grids:`` sections of ``Blueprints``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">systemLayoutInput</span><span class="o">.</span><span class="n">SystemLayoutInput</span><span class="p">()</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">readGeomFromStream</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/geomFile&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()]))</span>
        <span class="k">return</span> <span class="n">geom</span></div>

<div class="viewcode-block" id="Database3.writeInputsToDB"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.writeInputsToDB">[docs]</a>    <span class="k">def</span> <span class="nf">writeInputsToDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">csString</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">geomString</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bpString</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write inputs into the database based the CaseSettings.</span>

<span class="sd">        This is not DRY on purpose. The goal is that any particular Database</span>
<span class="sd">        implementation should be very stable, so we dont want it to be easy to change</span>
<span class="sd">        one Database implementation&#39;s behavior when trying to change another&#39;s.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is hard-coded to read the entire file contents into memory and write that</span>
<span class="sd">        directly into the database. We could have the cs/blueprints/geom write to a</span>
<span class="sd">        string, however the ARMI log file contains a hash of each files&#39; contents. In</span>
<span class="sd">        the future, we should be able to reproduce a calculation with confidence that</span>
<span class="sd">        the inputs are identical.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caseTitle</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span> <span class="k">if</span> <span class="n">cs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;caseTitle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseTitle</span>
        <span class="k">if</span> <span class="n">csString</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># don&#39;t read file; use what&#39;s in the cs now.</span>
            <span class="c1"># Sometimes settings are modified in tests.</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">writeToYamlStream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">csString</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bpString</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bpPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">)</span> <span class="o">/</span> <span class="n">cs</span><span class="p">[</span><span class="s2">&quot;loadingFile&quot;</span><span class="p">]</span>
            <span class="c1"># only store blueprints if we actually loaded from them</span>
            <span class="k">if</span> <span class="n">bpPath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">bpPath</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="c1"># Ensure that the input as stored in the DB is complete</span>
                <span class="n">bpString</span> <span class="o">=</span> <span class="n">resolveMarkupInclusions</span><span class="p">(</span>
                    <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">)</span> <span class="o">/</span> <span class="n">cs</span><span class="p">[</span><span class="s2">&quot;loadingFile&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bpString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csString</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/geomFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geomString</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/blueprints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpString</span></div>

<div class="viewcode-block" id="Database3.readInputsFromDB"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.readInputsFromDB">[docs]</a>    <span class="k">def</span> <span class="nf">readInputsFromDB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/settings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/geomFile&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="s2">&quot;inputs/blueprints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Database3.mergeHistory"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.mergeHistory">[docs]</a>    <span class="k">def</span> <span class="nf">mergeHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputDB</span><span class="p">,</span> <span class="n">startCycle</span><span class="p">,</span> <span class="n">startNode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy time step data up to, but not including the passed cycle and node.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is used for restart runs with the standard operator for example.</span>
<span class="sd">        The current time step (being loaded from) should not be copied, as that</span>
<span class="sd">        time steps data will be written at the end of the time step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># iterate over the top level H5Groups and copy</span>
        <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">h5ts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inputDB</span><span class="o">.</span><span class="n">genTimeSteps</span><span class="p">(),</span> <span class="n">inputDB</span><span class="o">.</span><span class="n">genTimeStepGroups</span><span class="p">()):</span>
            <span class="n">cyc</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">time</span>
            <span class="k">if</span> <span class="n">cyc</span> <span class="o">==</span> <span class="n">startCycle</span> <span class="ow">and</span> <span class="n">tn</span> <span class="o">==</span> <span class="n">startNode</span><span class="p">:</span>
                <span class="c1"># all data up to current state are merged</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">h5ts</span><span class="p">,</span> <span class="n">h5ts</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inputDB</span><span class="o">.</span><span class="n">versionMinor</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># The source database may have object references in some attributes.</span>
                <span class="c1"># make sure to link those up using our manual path strategy.</span>
                <span class="n">references</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">def</span> <span class="nf">findReferences</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5r</span><span class="o">.</span><span class="n">Reference</span><span class="p">):</span>
                            <span class="n">references</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">inputDB</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

                <span class="n">h5ts</span><span class="o">.</span><span class="n">visititems</span><span class="p">(</span><span class="n">findReferences</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">references</span><span class="p">:</span>
                    <span class="n">destTs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">h5ts</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">destTs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Context management support&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># open also increments _openCount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Typically we don&#39;t care why it broke but we want the DB to close&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="c1"># always close if there is a traceback.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">traceback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
        <span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span> <span class="o">=</span> <span class="n">tn</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<div class="viewcode-block" id="Database3.genTimeStepGroups"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.genTimeStepGroups">[docs]</a>    <span class="k">def</span> <span class="nf">genTimeStepGroups</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">_hl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a generator of HDF5 Groups for all time nodes, or for the passed selection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Must open the database before calling genTimeStepGroups&quot;</span>
        <span class="k">if</span> <span class="n">timeSteps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">groupName</span><span class="p">,</span> <span class="n">h5TimeNodeGroup</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeNodeGroupPattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">groupName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">h5TimeNodeGroup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">timeSteps</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">getH5GroupName</span><span class="p">(</span><span class="o">*</span><span class="n">step</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Database3.getLayout"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.getLayout">[docs]</a>    <span class="k">def</span> <span class="nf">getLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a Layout object representing the requested cycle and time node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versionMinor</span><span class="p">)</span>
        <span class="n">timeGroupName</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Layout</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">timeGroupName</span><span class="p">])</span></div>

<div class="viewcode-block" id="Database3.genTimeSteps"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.genTimeSteps">[docs]</a>    <span class="k">def</span> <span class="nf">genTimeSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a generator of (cycle, node) tuples that are present in the DB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Must open the database before calling genTimeSteps&quot;</span>
        <span class="k">for</span> <span class="n">groupName</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeNodeGroupPattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">groupName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">cycle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">node</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database3.genAuxiliaryData"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.genAuxiliaryData">[docs]</a>    <span class="k">def</span> <span class="nf">genAuxiliaryData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a generator of names of auxiliary data on the requested time point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Must open the database before calling genAuxiliaryData&quot;</span>
        <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="n">groupName</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">timeGroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">groupName</span><span class="p">]</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ArmiObject</span><span class="o">.</span><span class="n">TYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">exclude</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;layout&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">groupName</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">timeGroup</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database3.getAuxiliaryDataPath"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.getAuxiliaryDataPath">[docs]</a>    <span class="k">def</span> <span class="nf">getAuxiliaryDataPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span></div>

<div class="viewcode-block" id="Database3.keys"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genTimeStepGroups</span><span class="p">())</span></div>

<div class="viewcode-block" id="Database3.getH5Group"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.getH5Group">[docs]</a>    <span class="k">def</span> <span class="nf">getH5Group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the H5Group for the current ARMI timestep.</span>

<span class="sd">        This method can be used to allow other interfaces to place data into the database</span>
<span class="sd">        at the correct timestep.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">groupName</span> <span class="o">=</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">groupName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">groupName</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">groupName</span><span class="p">)</span>
            <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cycle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span>
            <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;timeNode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span>
            <span class="k">return</span> <span class="n">group</span></div>

<div class="viewcode-block" id="Database3.hasTimeStep"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.hasTimeStep">[docs]</a>    <span class="k">def</span> <span class="nf">hasTimeStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if (cycle, timeNode, statePointName) is contained in the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span></div>

<div class="viewcode-block" id="Database3.writeToDB"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.writeToDB">[docs]</a>    <span class="k">def</span> <span class="nf">writeToDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Database must be open before writing.&quot;</span>
        <span class="c1"># _createLayout is recursive</span>
        <span class="n">h5group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getH5Group</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing to database for statepoint: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h5group</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span><span class="p">),</span> <span class="n">comp</span><span class="o">=</span><span class="n">reactor</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">writeToDB</span><span class="p">(</span><span class="n">h5group</span><span class="p">)</span>
        <span class="n">groupedComps</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">groupedComps</span>

        <span class="k">for</span> <span class="n">comps</span> <span class="ow">in</span> <span class="n">groupedComps</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_writeParams</span><span class="p">(</span><span class="n">h5group</span><span class="p">,</span> <span class="n">comps</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database3.syncToSharedFolder"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.syncToSharedFolder">[docs]</a>    <span class="k">def</span> <span class="nf">syncToSharedFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy DB to run working directory.</span>

<span class="sd">        Needed when multiple MPI processes need to read the same db, for example</span>
<span class="sd">        when a history is needed from independent runs (e.g. for fuel performance on</span>
<span class="sd">        a variety of assemblies).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        At some future point, we may implement a client-server like DB system which</span>
<span class="sd">        would render this kind of operation unnecessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="s2">&quot;Copying DB to shared working directory.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullPath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database3.load"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">statePointName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowMissing</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a new reactor from (cycle, node).</span>

<span class="sd">        Case settings, blueprints, and geom can be provided by the client, or read from</span>
<span class="sd">        the database itself. Providing these from the client could be useful when</span>
<span class="sd">        performing snapshot runs or the like, where it is expected to use results from a</span>
<span class="sd">        run using different settings, then continue with new settings. Even in this</span>
<span class="sd">        case, the blueprints and geom should probably be the same as the original run.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cycle : int</span>
<span class="sd">            cycle number</span>
<span class="sd">        node : int</span>
<span class="sd">            time node</span>
<span class="sd">        cs : armi.settings.Settings (optional)</span>
<span class="sd">            if not provided one is read from the database</span>
<span class="sd">        bp : armi.reactor.Blueprints (Optional)</span>
<span class="sd">            if not provided one is read from the database</span>
<span class="sd">        statePointName : str</span>
<span class="sd">            Optional arbitrary statepoint name (e.g., &quot;special&quot; for &quot;c00n00-special/&quot;)</span>
<span class="sd">        allowMissing : bool</span>
<span class="sd">            Whether to emit a warning, rather than crash if reading a database</span>
<span class="sd">            with undefined parameters. Default False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        root : ArmiObject</span>
<span class="sd">            The top-level object stored in the database; usually a Reactor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading reactor state for time node (</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadCS</span><span class="p">()</span>
        <span class="c1"># apply to avoid defaults in getMasterCs calls</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">setMasterCs</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="n">bp</span> <span class="o">=</span> <span class="n">bp</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadBlueprints</span><span class="p">()</span>

        <span class="n">h5group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5db</span><span class="p">[</span><span class="n">getH5GroupName</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">statePointName</span><span class="p">)]</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span><span class="p">),</span> <span class="n">h5group</span><span class="o">=</span><span class="n">h5group</span><span class="p">)</span>
        <span class="n">comps</span><span class="p">,</span> <span class="n">groupedComps</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">_initComps</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span><span class="p">,</span> <span class="n">bp</span><span class="p">)</span>

        <span class="c1"># populate data onto initialized components</span>
        <span class="k">for</span> <span class="n">compType</span><span class="p">,</span> <span class="n">compTypeList</span> <span class="ow">in</span> <span class="n">groupedComps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_readParams</span><span class="p">(</span><span class="n">h5group</span><span class="p">,</span> <span class="n">compType</span><span class="p">,</span> <span class="n">compTypeList</span><span class="p">,</span> <span class="n">allowMissing</span><span class="o">=</span><span class="n">allowMissing</span><span class="p">)</span>

        <span class="c1"># assign params from blueprints</span>
        <span class="k">if</span> <span class="n">bp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assignBlueprintsParams</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">groupedComps</span><span class="p">)</span>

        <span class="c1"># stitch together</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compose</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">comps</span><span class="p">),</span> <span class="n">cs</span><span class="p">)</span>

        <span class="c1"># also, make sure to update the global serial number so we don&#39;t re-use a number</span>
        <span class="n">parameterCollections</span><span class="o">.</span><span class="n">GLOBAL_SERIAL_NUM</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">parameterCollections</span><span class="o">.</span><span class="n">GLOBAL_SERIAL_NUM</span><span class="p">,</span> <span class="n">layout</span><span class="o">.</span><span class="n">serialNum</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">root</span>  <span class="c1"># usually reactor object</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_assignBlueprintsParams</span><span class="p">(</span><span class="n">blueprints</span><span class="p">,</span> <span class="n">groupedComps</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">compType</span><span class="p">,</span> <span class="n">designs</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">Block</span><span class="p">,</span> <span class="n">blueprints</span><span class="o">.</span><span class="n">blockDesigns</span><span class="p">),</span>
            <span class="p">(</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">blueprints</span><span class="o">.</span><span class="n">assemDesigns</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">paramsToSet</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">pDef</span><span class="o">.</span><span class="n">name</span>
                <span class="k">for</span> <span class="n">pDef</span> <span class="ow">in</span> <span class="n">compType</span><span class="o">.</span><span class="n">pDefs</span><span class="o">.</span><span class="n">inCategory</span><span class="p">(</span>
                    <span class="n">parameters</span><span class="o">.</span><span class="n">Category</span><span class="o">.</span><span class="n">assignInBlueprints</span>
                <span class="p">)</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">groupedComps</span><span class="p">[</span><span class="n">compType</span><span class="p">]:</span>
                <span class="n">design</span> <span class="o">=</span> <span class="n">designs</span><span class="p">[</span><span class="n">comp</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pName</span> <span class="ow">in</span> <span class="n">paramsToSet</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="n">pName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">comp</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">pName</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_compose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comps</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a flat collection of all of the ArmiObjects in the model, reconstitute the hierarchy.&quot;&quot;&quot;</span>
        <span class="n">comp</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">numChildren</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span>

        <span class="c1"># attach the parent early, if provided; some cases need the parent attached for</span>
        <span class="c1"># the rest of _compose to work properly.</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c1"># The Reactor adds a Core child by default, this is not ideal</span>
        <span class="k">for</span> <span class="n">spontaneousChild</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">comp</span><span class="p">):</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">spontaneousChild</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Core</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Assembly</span><span class="p">):</span>
            <span class="c1"># Assemblies force their name to be something based on assemNum. When the</span>
            <span class="c1"># assembly is created it gets a new assemNum, and throws out the correct</span>
            <span class="c1"># name that we read from the DB</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">makeNameFromAssemNum</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">assemNum</span><span class="p">)</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">lastLocationLabel</span> <span class="o">=</span> <span class="n">Assembly</span><span class="o">.</span><span class="n">DATABASE</span>

        <span class="c1"># set the spatialLocators on each component</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">spatialGrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">spatialLocator</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">spatialGrid</span><span class="p">[</span><span class="n">location</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">spatialLocator</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">CoordinateLocation</span><span class="p">(</span>
                    <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">location</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">None</span>
                <span class="p">)</span>

        <span class="c1"># Need to keep a collection of Component instances for linked dimension</span>
        <span class="c1"># resolution, before they can be add()ed to their parents. Not just filtering</span>
        <span class="c1"># out of `children`, since resolveLinkedDims() needs a dict</span>
        <span class="n">childComponents</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numChildren</span><span class="p">):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compose</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span>
            <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Component</span><span class="p">):</span>
                <span class="n">childComponents</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>

        <span class="k">for</span> <span class="n">_childName</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">childComponents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">child</span><span class="o">.</span><span class="n">resolveLinkedDims</span><span class="p">(</span><span class="n">childComponents</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Core</span><span class="p">):</span>
            <span class="c1"># TODO: This is also an issue related to geoms and which core is &quot;The Core&quot;.</span>
            <span class="c1"># We only have a good geom for the main core, so can&#39;t do process loading on</span>
            <span class="c1"># the SFP, etc.</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">hasFlags</span><span class="p">(</span><span class="n">Flags</span><span class="o">.</span><span class="n">CORE</span><span class="p">):</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">processLoading</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Assembly</span><span class="p">):</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">calculateZCoords</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">comp</span>

    <span class="k">def</span> <span class="nf">_writeParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5group</span><span class="p">,</span> <span class="n">comps</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">groupName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">groupName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5group</span><span class="p">:</span>
            <span class="c1"># Only create the group if it doesnt already exist. This happens when</span>
            <span class="c1"># re-writing params in the same time node (e.g. something changed between</span>
            <span class="c1"># EveryNode and EOC)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">h5group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">groupName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="n">groupName</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">paramDef</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">paramDefs</span><span class="o">.</span><span class="n">toWriteToDB</span><span class="p">():</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;DIMENSION_NAMES&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">DIMENSION_NAMES</span><span class="p">:</span>
                <span class="n">linkedDims</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comps</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">linkedDims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getDimension</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">linkedDims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">linkedDims</span><span class="p">):</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;linkedDims&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">linkedDims</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># XXX: side effect is that after loading previously unset values will be</span>
                <span class="c1"># the default</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">default</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">sAttrs</span> <span class="o">=</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="p">(</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;O&quot;</span>
                    <span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> failed to convert </span><span class="si">{}</span><span class="s2"> to a numpy-supported type.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                    <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sAttrs</span><span class="p">)</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="n">_SERIALIZER_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="n">_SERIALIZER_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">version</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">temp</span>

            <span class="c1"># Convert Unicode to byte-string</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
                <span class="c1"># Something was added to the data array that caused numpy to want to</span>
                <span class="c1"># treat it as a general-purpose Object array. This usually happens</span>
                <span class="c1"># because:</span>
                <span class="c1"># - the data contain NoDefaults</span>
                <span class="c1"># - the data contain one or more Nones,</span>
                <span class="c1"># - the data contain special types like tuples, dicts, etc</span>
                <span class="c1"># - the data are composed of arrays that numpy would otherwise happily</span>
                <span class="c1"># convert to a higher-order array, but the dimensions of the sub-arrays</span>
                <span class="c1"># are inconsistent (&quot;jagged&quot;)</span>
                <span class="c1"># - there is some sort of honest-to-goodness weird object</span>
                <span class="c1"># We want to support the first two cases with minimal intrusion, since</span>
                <span class="c1"># these should be pretty easy to faithfully represent in the db. The</span>
                <span class="c1"># jagged case should be supported as well, but may require a less</span>
                <span class="c1"># faithful representation (e.g. flattened), but the last case isn&#39;t</span>
                <span class="c1"># really worth supporting.</span>

                <span class="c1"># Here is one proposal:</span>
                <span class="c1"># - Check to see if the array is jagged. all(shape == shape[0]). If not,</span>
                <span class="c1"># flatten, store the data offsets and array shapes, and None locations</span>
                <span class="c1"># as attrs</span>
                <span class="c1"># - If not jagged, all top-level ndarrays are the same shape, so it is</span>
                <span class="c1"># probably easier to replace Nones with ndarrays filled with special</span>
                <span class="c1"># values.</span>
                <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">NoDefault</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">specialAttrs</span> <span class="o">=</span> <span class="n">packSpecialData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">specialAttrs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">paramDef</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;`</span><span class="si">{}</span><span class="s2">` was already in `</span><span class="si">{}</span><span class="s2">`. This time node &quot;</span>
                        <span class="s2">&quot;should have been empty&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">dataset</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                    <span class="n">_writeAttrs</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">h5group</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to write </span><span class="si">{}</span><span class="s2"> to database. Data: &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramDef</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Block</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addHomogenizedNumberDensityParams</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_addHomogenizedNumberDensityParams</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="n">h5group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create on-the-fly block homog. number density params for XTVIEW viewing.</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>
<span class="sd">        collectBlockNumberDensities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nDens</span> <span class="o">=</span> <span class="n">collectBlockNumberDensities</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nucName</span><span class="p">,</span> <span class="n">numDens</span> <span class="ow">in</span> <span class="n">nDens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">nucName</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">numDens</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_readParams</span><span class="p">(</span><span class="n">h5group</span><span class="p">,</span> <span class="n">compTypeName</span><span class="p">,</span> <span class="n">comps</span><span class="p">,</span> <span class="n">allowMissing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="n">compTypeName</span><span class="p">]</span>

        <span class="n">renames</span> <span class="o">=</span> <span class="n">armi</span><span class="o">.</span><span class="n">getApp</span><span class="p">()</span><span class="o">.</span><span class="n">getParamRenames</span><span class="p">()</span>

        <span class="n">pDefs</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pDefs</span>

        <span class="c1"># this can also be made faster by specializing the method by type</span>
        <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">dataSet</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Honor historical databases where the parameters may have changed names</span>
            <span class="c1"># since.</span>
            <span class="k">while</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">renames</span><span class="p">:</span>
                <span class="n">paramName</span> <span class="o">=</span> <span class="n">renames</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">pDef</span> <span class="o">=</span> <span class="n">pDefs</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^n[A-Z][a-z]?\d*&quot;</span><span class="p">,</span> <span class="n">paramName</span><span class="p">):</span>
                    <span class="c1"># This is a temporary viz param (number density) made by</span>
                    <span class="c1"># _addHomogenizedNumberDensityParams ignore it safely</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If a parameter exists in the database but not in the application</span>
                    <span class="c1"># reading it, we can technically keep going. Since this may lead to</span>
                    <span class="c1"># potential correctness issues, raise a warning</span>
                    <span class="k">if</span> <span class="n">allowMissing</span><span class="p">:</span>
                        <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Found `</span><span class="si">{}</span><span class="s2">` parameter `</span><span class="si">{}</span><span class="s2">` in the database, which is not defined. &quot;</span>
                            <span class="s2">&quot;Ignoring it.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compTypeName</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">dataSet</span><span class="p">[:]</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">_resolveAttrs</span><span class="p">(</span><span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">h5group</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pDef</span><span class="o">.</span><span class="n">serializer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">_SERIALIZER_NAME</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span>
                <span class="k">assert</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_SERIALIZER_NAME</span><span class="p">]</span> <span class="o">==</span> <span class="n">pDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">assert</span> <span class="n">_SERIALIZER_VERSION</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">pDef</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_SERIALIZER_VERSION</span><span class="p">],</span> <span class="n">attrs</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">numpy</span><span class="o">.</span><span class="n">string_</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">unpackSpecialData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>

            <span class="n">linkedDims</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s2">&quot;linkedDims&quot;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">linkedDims</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;linkedDims&quot;</span><span class="p">])</span>

            <span class="c1"># iterating of numpy is not fast...</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">linkedDim</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span>
                <span class="n">comps</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">linkedDims</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">linkedDim</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span> <span class="o">=</span> <span class="n">linkedDim</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
                    <span class="c1"># happens when a param was deprecated but being loaded from old DB</span>
                    <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ae</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Skipping load of invalid param `</span><span class="si">{</span><span class="n">paramName</span><span class="si">}</span><span class="s2">`&quot;</span>
                        <span class="s2">&quot; (possibly loading from old DB)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="Database3.getHistoryByLocation"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.getHistoryByLocation">[docs]</a>    <span class="k">def</span> <span class="nf">getHistoryByLocation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comp</span><span class="p">:</span> <span class="n">ArmiObject</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the parameter histories at a specific location.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHistoriesByLocation</span><span class="p">([</span><span class="n">comp</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeSteps</span><span class="o">=</span><span class="n">timeSteps</span><span class="p">)[</span>
            <span class="n">comp</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="Database3.getHistoriesByLocation"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.getHistoriesByLocation">[docs]</a>    <span class="k">def</span> <span class="nf">getHistoriesByLocation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ArmiObject</span><span class="p">],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Histories</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the parameter histories at specific locations.</span>

<span class="sd">        This has a number of limitations, which should in practice not be too limiting:</span>
<span class="sd">         - The passed objects must have IndexLocations. This type of operation doesn&#39;t</span>
<span class="sd">           make much sense otherwise.</span>
<span class="sd">         - The passed objects must exist in a hierarchy that leads to a Core</span>
<span class="sd">           object, which serves as an anchor that can fully define all index locations.</span>
<span class="sd">           This could possibly be made more general by extending grids, but that gets a</span>
<span class="sd">           little more complicated.</span>
<span class="sd">         - All requested objects must exist under the **same** anchor object, and at the</span>
<span class="sd">           same depth below it.</span>
<span class="sd">         - All requested objects must have the same type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        comps : list of ArmiObject</span>
<span class="sd">            The components/composites that currently occupy the location that you want</span>
<span class="sd">            histories at. ArmiObjects are passed, rather than locations, because this</span>
<span class="sd">            makes it easier to figure out things related to layout.</span>
<span class="sd">        params : List of str, optional</span>
<span class="sd">            The parameter names for the parameters that we want the history of. If None,</span>
<span class="sd">            all parameter history is given</span>
<span class="sd">        timeSteps : List of (cycle, node) tuples, optional</span>
<span class="sd">            The time nodes that you want history for. If None, all available time nodes</span>
<span class="sd">            will be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Location-based histories are only supported for db &quot;</span>
                <span class="s2">&quot;version 3.4 and greater. This database is version &quot;</span>
                <span class="s2">&quot;</span><span class="si">{self.versionMajor}</span><span class="s2">, </span><span class="si">{self.versionMinor}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">spatialLocator</span><span class="o">.</span><span class="n">getCompleteIndices</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">]</span>

        <span class="n">histData</span><span class="p">:</span> <span class="n">Histories</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">c</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span>
        <span class="p">}</span>

        <span class="c1"># Check our assumptions about the passed locations:</span>
        <span class="c1"># All locations must have the same parent and bear the same relationship to the</span>
        <span class="c1"># anchor object</span>
        <span class="n">anchors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">getAncestorAndDistance</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Core</span><span class="p">))</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">comps</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The passed objects do not have the same anchor or distance to that &quot;</span>
                <span class="s2">&quot;anchor; encountered the following: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">anchorInfo</span> <span class="o">=</span> <span class="n">anchors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">anchorInfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">anchor</span><span class="p">,</span> <span class="n">anchorDistance</span> <span class="o">=</span> <span class="n">anchorInfo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Could not determine an anchor object for the passed components&quot;</span>
            <span class="p">)</span>

        <span class="n">anchorSerialNum</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">serialNum</span>

        <span class="c1"># All objects of the same type</span>
        <span class="n">objectTypes</span> <span class="o">=</span> <span class="p">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objectTypes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;The passed objects must be the same type; got objects of &quot;</span>
                <span class="s2">&quot;types `</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objectTypes</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">compType</span> <span class="o">=</span> <span class="n">objectTypes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">objClassName</span> <span class="o">=</span> <span class="n">compType</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">locToComp</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">spatialLocator</span><span class="o">.</span><span class="n">getCompleteIndices</span><span class="p">():</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">h5TimeNodeGroup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genTimeStepGroups</span><span class="p">(</span><span class="n">timeSteps</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;layout&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5TimeNodeGroup</span><span class="p">:</span>
                <span class="c1"># layout hasnt been written for this time step, so we can&#39;t get anything</span>
                <span class="c1"># useful here. Perhaps the current value is of use, in which case the</span>
                <span class="c1"># DatabaseInterface should be used.</span>
                <span class="k">continue</span>

            <span class="n">cycle</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cycle&quot;</span><span class="p">]</span>
            <span class="n">timeNode</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;timeNode&quot;</span><span class="p">]</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span><span class="p">),</span> <span class="n">h5group</span><span class="o">=</span><span class="n">h5TimeNodeGroup</span>
            <span class="p">)</span>

            <span class="n">ancestors</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">computeAncestors</span><span class="p">(</span>
                <span class="n">layout</span><span class="o">.</span><span class="n">serialNum</span><span class="p">,</span> <span class="n">layout</span><span class="o">.</span><span class="n">numChildren</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">anchorDistance</span>
            <span class="p">)</span>

            <span class="n">lLocation</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">location</span>
            <span class="c1"># filter for objects that live under the desired ancestor and at a desired location</span>
            <span class="n">objectIndicesInLayout</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ancestors</span><span class="p">,</span> <span class="n">lLocation</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">ancestor</span> <span class="o">==</span> <span class="n">anchorSerialNum</span> <span class="ow">and</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locations</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># This could also be way more efficient if lLocation were a numpy array</span>
            <span class="n">objectLocationsInLayout</span> <span class="o">=</span> <span class="p">[</span><span class="n">lLocation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">objectIndicesInLayout</span><span class="p">]</span>

            <span class="n">objectIndicesInData</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">indexInData</span><span class="p">)[</span>
                <span class="n">objectIndicesInLayout</span>
            <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">h5GroupForType</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="p">[</span><span class="n">objClassName</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not found in </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">objClassName</span><span class="p">,</span> <span class="n">h5TimeNodeGroup</span><span class="p">,</span> <span class="bp">self</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ee</span>

            <span class="k">for</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">or</span> <span class="n">h5GroupForType</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">paramName</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                    <span class="c1"># location is special, since it is stored in layout/</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">location</span><span class="p">)[</span><span class="n">objectIndicesInLayout</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">h5GroupForType</span><span class="p">:</span>
                    <span class="n">dataSet</span> <span class="o">=</span> <span class="n">h5GroupForType</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">dataSet</span><span class="p">[</span><span class="n">objectIndicesInData</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Failed to load index </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">objectIndicesInData</span><span class="p">,</span> <span class="n">dataSet</span><span class="p">,</span> <span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">raise</span>

                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">numpy</span><span class="o">.</span><span class="n">string_</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nones&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonsenseWithNones</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;History tracking for non-None, &quot;</span>
                                <span class="s2">&quot;special-formatted parameters is not supported: &quot;</span>
                                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">paramName</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Nothing in the database for this param, so use the default value</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                        <span class="n">parameters</span><span class="o">.</span><span class="n">byNameAndType</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="n">compType</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># store data to the appropriate comps. This is where taking components</span>
                <span class="c1"># as the argument (rather than locations) is a little bit peculiar.</span>
                <span class="c1">#</span>
                <span class="c1"># At this point, `data` are arranged by the order of elements in</span>
                <span class="c1"># `objectIndicesInData`, which corresponds to the order of</span>
                <span class="c1"># `objectIndicesInLayout`</span>
                <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">objectLocationsInLayout</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
                    <span class="n">comp</span> <span class="o">=</span> <span class="n">locToComp</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span>
                    <span class="n">histData</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">paramName</span><span class="p">][</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">histData</span></div>

<div class="viewcode-block" id="Database3.getHistory"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.getHistory">[docs]</a>    <span class="k">def</span> <span class="nf">getHistory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comp</span><span class="p">:</span> <span class="n">ArmiObject</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get parameter history for a single ARMI Object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comps</span>
<span class="sd">            An individual ArmiObject</span>
<span class="sd">        params</span>
<span class="sd">            parameters to gather</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary of str/list pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHistories</span><span class="p">([</span><span class="n">comp</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">timeSteps</span><span class="p">)[</span><span class="n">comp</span><span class="p">]</span></div>

<div class="viewcode-block" id="Database3.getHistories"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Database3.getHistories">[docs]</a>    <span class="k">def</span> <span class="nf">getHistories</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ArmiObject</span><span class="p">],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeSteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Histories</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the parameter histories for a sequence of ARMI Objects.</span>

<span class="sd">        This implementation is unaware of the state of the reactor outside of the</span>
<span class="sd">        database itself, and is therefore not usually what client code should be calling</span>
<span class="sd">        directly during normal ARMI operation. It only knows about historical data that</span>
<span class="sd">        have actually been written to the database. Usually one wants to be able to get</span>
<span class="sd">        historical, plus current data, for which the similar method on the</span>
<span class="sd">        DatabaseInterface may be more useful.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        comps</span>
<span class="sd">            Something that is iterable multiple times</span>
<span class="sd">        params</span>
<span class="sd">            parameters to gather.</span>
<span class="sd">        timeSteps</span>
<span class="sd">            Selection of time nodes to get data for. If omitted, return full history</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary ArmiObject (input): dict of str/list pairs containing ((cycle,</span>
<span class="sd">            node), value).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">histData</span><span class="p">:</span> <span class="n">Histories</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">c</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span>
        <span class="p">}</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="vm">__class__</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">}</span>
        <span class="n">compsByTypeThenSerialNum</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">ArmiObject</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ArmiObject</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">t</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
            <span class="n">compsByTypeThenSerialNum</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="vm">__class__</span><span class="p">][</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">serialNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

        <span class="k">for</span> <span class="n">h5TimeNodeGroup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genTimeStepGroups</span><span class="p">(</span><span class="n">timeSteps</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;layout&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5TimeNodeGroup</span><span class="p">:</span>
                <span class="c1"># Layout hasn&#39;t been written for this time step, so whatever is in there</span>
                <span class="c1"># didn&#39;t come from the DatabaseInterface. Probably because it&#39;s the</span>
                <span class="c1"># current time step and something has created the group to store aux</span>
                <span class="c1"># data</span>
                <span class="k">continue</span>

            <span class="n">cycle</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cycle&quot;</span><span class="p">]</span>
            <span class="n">timeNode</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;timeNode&quot;</span><span class="p">]</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">versionMajor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionMinor</span><span class="p">),</span> <span class="n">h5group</span><span class="o">=</span><span class="n">h5TimeNodeGroup</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">compType</span><span class="p">,</span> <span class="n">compsBySerialNum</span> <span class="ow">in</span> <span class="n">compsByTypeThenSerialNum</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">compTypeName</span> <span class="o">=</span> <span class="n">compType</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">h5GroupForType</span> <span class="o">=</span> <span class="n">h5TimeNodeGroup</span><span class="p">[</span><span class="n">compTypeName</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
                    <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not found in </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">compTypeName</span><span class="p">,</span> <span class="n">h5TimeNodeGroup</span><span class="p">,</span> <span class="bp">self</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ee</span>
                <span class="n">layoutIndicesForType</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">compTypeName</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">serialNumsForType</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">serialNum</span><span class="p">[</span><span class="n">layoutIndicesForType</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">layoutIndexInData</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">indexInData</span><span class="p">[</span><span class="n">layoutIndicesForType</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                <span class="n">indexInData</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">reorderedComps</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">sn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layoutIndexInData</span><span class="p">,</span> <span class="n">serialNumsForType</span><span class="p">):</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">compsBySerialNum</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">indexInData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                        <span class="n">reorderedComps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">indexInData</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># note this is very similar to _readParams, but there are some important</span>
                <span class="c1"># differences.</span>
                <span class="c1"># 1) we are not assigning to p[paramName]</span>
                <span class="c1"># 2) not using linkedDims at all</span>
                <span class="c1"># 3) not performing parameter renaming. This may become necessary</span>
                <span class="k">for</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">or</span> <span class="n">h5GroupForType</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">paramName</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                        <span class="c1"># cast to a numpy array so that we can use list indices</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">location</span><span class="p">)[</span><span class="n">layoutIndicesForType</span><span class="p">][</span>
                            <span class="n">indexInData</span>
                        <span class="p">]</span>
                    <span class="k">elif</span> <span class="n">paramName</span> <span class="ow">in</span> <span class="n">h5GroupForType</span><span class="p">:</span>
                        <span class="n">dataSet</span> <span class="o">=</span> <span class="n">h5GroupForType</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">dataSet</span><span class="p">[</span><span class="n">indexInData</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s2">&quot;Failed to load index </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">indexInData</span><span class="p">,</span> <span class="n">dataSet</span><span class="p">,</span> <span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">raise</span>

                        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">numpy</span><span class="o">.</span><span class="n">string_</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nones&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonsenseWithNones</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="s2">&quot;History tracking for non-none special formatting &quot;</span>
                                    <span class="s2">&quot;not supported: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">paramName</span><span class="p">,</span>
                                        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Nothing in the database, so use the default value</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                            <span class="n">parameters</span><span class="o">.</span><span class="n">byNameAndType</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="n">compType</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">reorderedComps</span><span class="p">),</span>
                        <span class="p">)</span>

                    <span class="c1"># iterating of numpy is not fast..</span>
                    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reorderedComps</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>

                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                        <span class="n">histData</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">paramName</span><span class="p">][</span><span class="n">cycle</span><span class="p">,</span> <span class="n">timeNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getAncestorWithFlags</span><span class="p">(</span><span class="n">Flags</span><span class="o">.</span><span class="n">REACTOR</span><span class="p">)</span>
        <span class="n">cycleNode</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cycle</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">timeNode</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">paramHistories</span> <span class="ow">in</span> <span class="n">histData</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">paramHistories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">cycleNode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hist</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">hist</span><span class="p">[</span><span class="n">cycleNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">paramName</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                            <span class="n">hist</span><span class="p">[</span><span class="n">cycleNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">spatialLocator</span><span class="o">.</span><span class="n">indices</span>

        <span class="k">return</span> <span class="n">histData</span></div></div>


<span class="k">def</span> <span class="nf">_packLocations</span><span class="p">(</span>
    <span class="n">locations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">grids</span><span class="o">.</span><span class="n">LocationBase</span><span class="p">],</span> <span class="n">minorVersion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DB_MINOR</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract information from a location needed to write it to this DB.</span>

<span class="sd">    Each locator has one locationType and up to N location-defining datums,</span>
<span class="sd">    where N is the number of entries in a possible multiindex, or just 1</span>
<span class="sd">    for everything else.</span>

<span class="sd">    Shrink grid locator names for storage efficiency.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Contains some conditionals to still load databases made before</span>
<span class="sd">    db version 3.3 which can be removed once no users care about</span>
<span class="sd">    those DBs anymore.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">minorVersion</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">locationTypes</span><span class="p">,</span> <span class="n">locationData</span> <span class="o">=</span> <span class="n">_packLocationsV1</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">minorVersion</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">locationTypes</span><span class="p">,</span> <span class="n">locationData</span> <span class="o">=</span> <span class="n">_packLocationsV2</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">minorVersion</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">locationTypes</span><span class="p">,</span> <span class="n">locationData</span> <span class="o">=</span> <span class="n">_packLocationsV3</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported minor version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minorVersion</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">locationTypes</span><span class="p">,</span> <span class="n">locationData</span>


<span class="k">def</span> <span class="nf">_packLocationsV1</span><span class="p">(</span>
    <span class="n">locations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">grids</span><span class="o">.</span><span class="n">LocationBase</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;Delete when reading v &lt;=3.2 DB&#39;s no longer wanted.&quot;&quot;&quot;</span>
    <span class="n">locTypes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">locData</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
        <span class="n">locationType</span> <span class="o">=</span> <span class="n">loc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">locationType</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">IndexLocation</span><span class="p">):</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid location type: </span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">locTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locationType</span><span class="p">)</span>
        <span class="n">locData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">locDatum</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">locTypes</span><span class="p">,</span> <span class="n">locData</span>


<span class="k">def</span> <span class="nf">_packLocationsV2</span><span class="p">(</span>
    <span class="n">locations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">grids</span><span class="o">.</span><span class="n">LocationBase</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Location packing implementation for minor version 3. See release notes above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">locTypes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">locData</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
        <span class="n">locationType</span> <span class="o">=</span> <span class="n">LOCATION_TYPE_LABELS</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">loc</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">loc</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">grids</span><span class="o">.</span><span class="n">CoordinateLocation</span><span class="p">:</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">loc</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">grids</span><span class="o">.</span><span class="n">IndexLocation</span><span class="p">:</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">loc</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">grids</span><span class="o">.</span><span class="n">MultiIndexLocation</span><span class="p">:</span>
            <span class="c1"># encode number of sub-locations to allow in-line unpacking.</span>
            <span class="n">locationType</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[</span><span class="n">subloc</span><span class="o">.</span><span class="n">indices</span> <span class="k">for</span> <span class="n">subloc</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid location type: </span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">locTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locationType</span><span class="p">)</span>
        <span class="n">locData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">locDatum</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">locTypes</span><span class="p">,</span> <span class="n">locData</span>


<span class="k">def</span> <span class="nf">_packLocationsV3</span><span class="p">(</span>
    <span class="n">locations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">grids</span><span class="o">.</span><span class="n">LocationBase</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Location packing implementation for minor version 4. See release notes above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">locTypes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">locData</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
        <span class="n">locationType</span> <span class="o">=</span> <span class="n">LOCATION_TYPE_LABELS</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">loc</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="ow">is</span> <span class="n">grids</span><span class="o">.</span><span class="n">IndexLocation</span><span class="p">:</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span><span class="o">.</span><span class="n">getCompleteIndices</span><span class="p">()]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="ow">is</span> <span class="n">grids</span><span class="o">.</span><span class="n">CoordinateLocation</span><span class="p">:</span>
            <span class="c1"># CoordinateLocations do not implement getCompleteIndices properly, and we</span>
            <span class="c1"># do not really have a motivation to store them as we do with index</span>
            <span class="c1"># locations.</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="ow">is</span> <span class="n">grids</span><span class="o">.</span><span class="n">MultiIndexLocation</span><span class="p">:</span>
            <span class="n">locationType</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">locDatum</span> <span class="o">=</span> <span class="p">[</span><span class="n">subloc</span><span class="o">.</span><span class="n">indices</span> <span class="k">for</span> <span class="n">subloc</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid location type: </span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">locTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locationType</span><span class="p">)</span>
        <span class="n">locData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">locDatum</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">locTypes</span><span class="p">,</span> <span class="n">locData</span>


<span class="k">def</span> <span class="nf">_unpackLocations</span><span class="p">(</span><span class="n">locationTypes</span><span class="p">,</span> <span class="n">locData</span><span class="p">,</span> <span class="n">minorVersion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DB_MINOR</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert location data as read from DB back into data structure for building reactor model.</span>

<span class="sd">    location and locationType will only have different lengths when multiindex locations</span>
<span class="sd">    are used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">minorVersion</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_unpackLocationsV1</span><span class="p">(</span><span class="n">locationTypes</span><span class="p">,</span> <span class="n">locData</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_unpackLocationsV2</span><span class="p">(</span><span class="n">locationTypes</span><span class="p">,</span> <span class="n">locData</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_unpackLocationsV1</span><span class="p">(</span><span class="n">locationTypes</span><span class="p">,</span> <span class="n">locData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete when reading v &lt;=3.2 DB&#39;s no longer wanted.&quot;&quot;&quot;</span>
    <span class="n">locsIter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">locData</span><span class="p">)</span>
    <span class="n">unpackedLocs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lt</span> <span class="ow">in</span> <span class="n">locationTypes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lt</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">locsIter</span><span class="p">)</span>
            <span class="n">unpackedLocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lt</span> <span class="o">==</span> <span class="s2">&quot;IndexLocation&quot;</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">locsIter</span><span class="p">)</span>
            <span class="c1"># the data is stored as float, so cast back to int</span>
            <span class="n">unpackedLocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">locsIter</span><span class="p">)</span>
            <span class="n">unpackedLocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">unpackedLocs</span>


<span class="k">def</span> <span class="nf">_unpackLocationsV2</span><span class="p">(</span><span class="n">locationTypes</span><span class="p">,</span> <span class="n">locData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Location unpacking implementation for minor version 3+. See release notes above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">locsIter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">locData</span><span class="p">)</span>
    <span class="n">unpackedLocs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lt</span> <span class="ow">in</span> <span class="n">locationTypes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lt</span> <span class="o">==</span> <span class="n">LOC_NONE</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">locsIter</span><span class="p">)</span>
            <span class="n">unpackedLocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lt</span> <span class="o">==</span> <span class="n">LOC_INDEX</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">locsIter</span><span class="p">)</span>
            <span class="c1"># the data is stored as float, so cast back to int</span>
            <span class="n">unpackedLocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">lt</span> <span class="o">==</span> <span class="n">LOC_COORD</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">locsIter</span><span class="p">)</span>
            <span class="n">unpackedLocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">lt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">LOC_MULTI</span><span class="p">):</span>
            <span class="c1"># extract number of sublocations from e.g. &quot;M:345&quot; string.</span>
            <span class="n">numSubLocs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">multiLocs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numSubLocs</span><span class="p">):</span>
                <span class="n">subLoc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">locsIter</span><span class="p">)</span>
                <span class="c1"># All multiindexes sublocs are index locs</span>
                <span class="n">multiLocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subLoc</span><span class="p">))</span>
            <span class="n">unpackedLocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multiLocs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read unknown location type </span><span class="si">{</span><span class="n">lt</span><span class="si">}</span><span class="s2">. Invalid DB.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">unpackedLocs</span>


<div class="viewcode-block" id="Layout"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Layout">[docs]</a><span class="k">class</span> <span class="nc">Layout</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Layout class describes the hierarchical layout of the composite Reactor model in a flat representation.</span>

<span class="sd">    A Layout is built up by starting at the root of a composite tree and recursively</span>
<span class="sd">    appending each node in the tree to the list of data. So for a typical Reactor model,</span>
<span class="sd">    the data will be ordered by depth-first search: [r, c, a1, a1b1, a1b1c1, a1b1c2, a1b2,</span>
<span class="sd">    a1b2c1, ..., a2, ...].</span>

<span class="sd">    The layout is also responsible for storing Component attributes, like location,</span>
<span class="sd">    material, and temperatures (from blueprints), which aren&#39;t stored as Parameters.</span>
<span class="sd">    Temperatures, specifically, are rather complicated beasts in ARMI, and more</span>
<span class="sd">    fundamental changes to how we deal with them may allow us to remove them from</span>
<span class="sd">    Layout.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    As this format is liable to be consumed by other code, it is important to specify</span>
<span class="sd">    its structure so that code attempting to read/write Layouts can make safe</span>
<span class="sd">    assumptions. Below is a list of things to be aware of. More will be added as issues</span>
<span class="sd">    arise or things become more precise:</span>

<span class="sd">     * Elements in Layout are stored in depth-first order. This permits use of</span>
<span class="sd">       algorithms such as Pre-Order Tree Traversal for efficient traversal of regions of</span>
<span class="sd">       the model.</span>

<span class="sd">     * ``indexInData`` increases monotonically within each object ``type``. This means</span>
<span class="sd">       that, for instance, the data for all ``HexBlock`` children of a given parent</span>
<span class="sd">       are stored contiguously within the ``HexBlock`` group, and will not be</span>
<span class="sd">       interleaved with data from the ``HexBlock`` children of any of the parent&#39;s</span>
<span class="sd">       siblings.</span>

<span class="sd">     * Aside from the hierarchy itself, there is no guarantee what order objects are</span>
<span class="sd">       stored in the layout.  &quot;`The` ``Core``&quot; is not necessarily the first child of the</span>
<span class="sd">       ``Reactor``, and is not guaranteed to use the zeroth grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">h5group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialNum</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># The index into the parameter datasets corresponding to each object&#39;s class.</span>
        <span class="c1"># E.g., the 5th HexBlock object in the tree would get 5; to look up its</span>
        <span class="c1"># &quot;someParameter&quot; value, you would extract cXXnYY/HexBlock/someParameter[5].</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexInData</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># The number of direct children this object has.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numChildren</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># The type of location that specifies the object&#39;s physical location; see the</span>
        <span class="c1"># associated pack/unpackLocation functions for more information about how</span>
        <span class="c1"># locations are handled.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locationType</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># There is a minor asymmetry here in that before writing to the DB, this is</span>
        <span class="c1"># truly a flat list of tuples. However when reading, this may contain lists of</span>
        <span class="c1"># tuples, which represent MI locations. This comes from the fact that we map the</span>
        <span class="c1"># tuples to Location objects in Database3._compose, but map from Locations to</span>
        <span class="c1"># tuples in Layout._createLayout. Ideally we would handle both directions in the</span>
        <span class="c1"># same place so this can be less surprising. Resolving this would require</span>
        <span class="c1"># changing the interface of the various pack/unpack functions, which have</span>
        <span class="c1"># multiple versions, so the update would need to be done with care.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Which grid, as stored in the database, this object uses to arrange its</span>
        <span class="c1"># children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gridIndex</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Used to cache all of the spatial locators so that we can pack them all at</span>
        <span class="c1"># once. The benefit here is that the version checking can happen up front and</span>
        <span class="c1"># less branching down below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spatialLocators</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">grids</span><span class="o">.</span><span class="n">LocationBase</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># set of grid parameters that have been seen in _createLayout. For efficient</span>
        <span class="c1"># checks for uniqueness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seenGridParams</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># actual list of grid parameters, with stable order for safe indexing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gridParams</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">groupedComps</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
            <span class="n">Type</span><span class="p">[</span><span class="n">ArmiObject</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">ArmiObject</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c1"># it should be noted, one of the two inputs must be non-None: comp/h5group</span>
        <span class="k">if</span> <span class="n">comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_createLayout</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locationType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">_packLocations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatialLocators</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_readLayout</span><span class="p">(</span><span class="n">h5group</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_snToLayoutIndex</span> <span class="o">=</span> <span class="p">{</span><span class="n">sn</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialNum</span><span class="p">)}</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sn</span><span class="p">):</span>
        <span class="n">layoutIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snToLayoutIndex</span><span class="p">[</span><span class="n">sn</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="n">layoutIndex</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">layoutIndex</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serialNum</span><span class="p">[</span><span class="n">layoutIndex</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexInData</span><span class="p">[</span><span class="n">layoutIndex</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numChildren</span><span class="p">[</span><span class="n">layoutIndex</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locationType</span><span class="p">[</span><span class="n">layoutIndex</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="n">layoutIndex</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span><span class="p">[</span><span class="n">layoutIndex</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">[</span><span class="n">layoutIndex</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_createLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate a hierarchical representation and group the reactor model items by type.</span>

<span class="sd">        This is used when writing a reactor model to the database.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is recursive.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        _readLayout : does the opposite</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupedComps</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">comp</span><span class="p">)]</span>
        <span class="n">compList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialNum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">serialNum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexInData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compList</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numChildren</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>

        <span class="c1"># determine how many components have been read in, to set the grid index</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">spatialGrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gridType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">spatialGrid</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">gridParams</span> <span class="o">=</span> <span class="p">(</span><span class="n">gridType</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">spatialGrid</span><span class="o">.</span><span class="n">reduce</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">gridParams</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seenGridParams</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_seenGridParams</span><span class="p">[</span><span class="n">gridParams</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gridParams</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gridParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gridParams</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gridIndex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seenGridParams</span><span class="p">[</span><span class="n">gridParams</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gridIndex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_spatialLocators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">spatialLocator</span><span class="p">)</span>

        <span class="c1"># set the materials and temperatures</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">comp</span><span class="o">.</span><span class="n">inputTemperatureInC</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">temperatureInC</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="mi">900</span><span class="p">,</span> <span class="o">-</span><span class="mi">900</span><span class="p">))</span>  <span class="c1"># an impossible temperature</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Failed to sort some collection of ArmiObjects for database output: </span><span class="si">{}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;value </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># depth-first search recursion of all components</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_createLayout</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_readLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate a hierarchical representation and group the reactor model items by type.</span>

<span class="sd">        This is used when reading a reactor model from a database.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        _createLayout : does the opposite</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># location is either an index, or a point</span>
            <span class="c1"># iter over list is faster</span>
            <span class="n">locations</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/location&quot;</span><span class="p">][:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locationType</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/locationType&quot;</span><span class="p">][:]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">_unpackLocations</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">locationType</span><span class="p">,</span> <span class="n">locations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/type&quot;</span><span class="p">][:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/name&quot;</span><span class="p">][:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serialNum</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/serialNum&quot;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexInData</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/indexInData&quot;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numChildren</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/numChildren&quot;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">material</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/material&quot;</span><span class="p">][:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/temperatures&quot;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gridIndex</span> <span class="o">=</span> <span class="n">replaceNonsenseWithNones</span><span class="p">(</span>
                <span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/gridIndex&quot;</span><span class="p">][:],</span> <span class="s2">&quot;layout/gridIndex&quot;</span>
            <span class="p">)</span>

            <span class="n">gridGroup</span> <span class="o">=</span> <span class="n">h5group</span><span class="p">[</span><span class="s2">&quot;layout/grids&quot;</span><span class="p">]</span>
            <span class="n">gridTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">gridGroup</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">][:]]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gridParams</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">iGrid</span><span class="p">,</span> <span class="n">gridType</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gridTypes</span><span class="p">):</span>
                <span class="n">thisGroup</span> <span class="o">=</span> <span class="n">gridGroup</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">iGrid</span><span class="p">)]</span>

                <span class="n">unitSteps</span> <span class="o">=</span> <span class="n">thisGroup</span><span class="p">[</span><span class="s2">&quot;unitSteps&quot;</span><span class="p">][:]</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ibound</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">boundName</span> <span class="o">=</span> <span class="s2">&quot;bounds_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ibound</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">boundName</span> <span class="ow">in</span> <span class="n">thisGroup</span><span class="p">:</span>
                        <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisGroup</span><span class="p">[</span><span class="n">boundName</span><span class="p">][:])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">unitStepLimits</span> <span class="o">=</span> <span class="n">thisGroup</span><span class="p">[</span><span class="s2">&quot;unitStepLimits&quot;</span><span class="p">][:]</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">thisGroup</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">][:]</span> <span class="k">if</span> <span class="n">thisGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">geomType</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">thisGroup</span><span class="p">[</span><span class="s2">&quot;geomType&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()]</span>
                    <span class="k">if</span> <span class="s2">&quot;geomType&quot;</span> <span class="ow">in</span> <span class="n">thisGroup</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="n">symmetry</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">thisGroup</span><span class="p">[</span><span class="s2">&quot;symmetry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()]</span>
                    <span class="k">if</span> <span class="s2">&quot;symmetry&quot;</span> <span class="ow">in</span> <span class="n">thisGroup</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">gridParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">gridType</span><span class="p">,</span>
                        <span class="n">grids</span><span class="o">.</span><span class="n">GridParameters</span><span class="p">(</span>
                            <span class="n">unitSteps</span><span class="p">,</span>
                            <span class="n">bounds</span><span class="p">,</span>
                            <span class="n">unitStepLimits</span><span class="p">,</span>
                            <span class="n">offset</span><span class="p">,</span>
                            <span class="n">geomType</span><span class="p">,</span>
                            <span class="n">symmetry</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Failed to get layout information from group: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h5group</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">_initComps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caseTitle</span><span class="p">,</span> <span class="n">bp</span><span class="p">):</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groupedComps</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span>
            <span class="n">compType</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">serialNum</span><span class="p">,</span>
            <span class="n">numChildren</span><span class="p">,</span>
            <span class="n">location</span><span class="p">,</span>
            <span class="n">material</span><span class="p">,</span>
            <span class="n">temperatures</span><span class="p">,</span>
            <span class="n">gridIndex</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serialNum</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numChildren</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gridIndex</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">Klass</span> <span class="o">=</span> <span class="n">ArmiObject</span><span class="o">.</span><span class="n">TYPES</span><span class="p">[</span><span class="n">compType</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">Klass</span><span class="p">,</span> <span class="n">Reactor</span><span class="p">):</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">Klass</span><span class="p">(</span><span class="n">caseTitle</span><span class="p">,</span> <span class="n">bp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">Klass</span><span class="p">,</span> <span class="n">Core</span><span class="p">):</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">Klass</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">Klass</span><span class="p">,</span> <span class="n">Component</span><span class="p">):</span>
                <span class="c1"># XXX: initialize all dimensions to 0, they will be loaded and assigned</span>
                <span class="c1"># after load</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">Klass</span><span class="o">.</span><span class="n">DIMENSION_NAMES</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Tinput&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperatures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Thot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperatures</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">Klass</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">Klass</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">gridIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gridParams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridParams</span><span class="p">[</span><span class="n">gridIndex</span><span class="p">]</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">spatialGrid</span> <span class="o">=</span> <span class="n">GRID_CLASSES</span><span class="p">[</span><span class="n">gridParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span>
                    <span class="o">*</span><span class="n">gridParams</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">armiObject</span><span class="o">=</span><span class="n">comp</span>
                <span class="p">)</span>

            <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">comp</span><span class="p">,</span> <span class="n">serialNum</span><span class="p">,</span> <span class="n">numChildren</span><span class="p">,</span> <span class="n">location</span><span class="p">))</span>
            <span class="n">groupedComps</span><span class="p">[</span><span class="n">compType</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">comps</span><span class="p">,</span> <span class="n">groupedComps</span>

<div class="viewcode-block" id="Layout.writeToDB"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Layout.writeToDB">[docs]</a>    <span class="k">def</span> <span class="nf">writeToDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5group</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;layout/type&quot;</span> <span class="ow">in</span> <span class="n">h5group</span><span class="p">:</span>
            <span class="c1"># It looks like we have already written the layout to DB, skip for now</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/type&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">),</span>
                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/name&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">),</span>
                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/serialNum&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">serialNum</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
            <span class="p">)</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/indexInData&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">indexInData</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
            <span class="p">)</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/numChildren&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numChildren</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
            <span class="p">)</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/location&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
            <span class="p">)</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/locationType&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locationType</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">),</span>
                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/material&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">),</span>
                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/temperatures&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
            <span class="p">)</span>

            <span class="n">h5group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;layout/gridIndex&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">replaceNonesWithNonsense</span><span class="p">(</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gridIndex</span><span class="p">),</span> <span class="s2">&quot;layout/gridIndex&quot;</span>
                <span class="p">),</span>
                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">gridsGroup</span> <span class="o">=</span> <span class="n">h5group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;layout/grids&quot;</span><span class="p">)</span>
            <span class="n">gridsGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;nGrids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gridParams</span><span class="p">)</span>
            <span class="n">gridsGroup</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">gp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridParams</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">igrid</span><span class="p">,</span> <span class="n">gridParams</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">gp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridParams</span><span class="p">):</span>
                <span class="n">thisGroup</span> <span class="o">=</span> <span class="n">gridsGroup</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">igrid</span><span class="p">))</span>
                <span class="n">thisGroup</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;unitSteps&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gridParams</span><span class="o">.</span><span class="n">unitSteps</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ibound</span><span class="p">,</span> <span class="n">bound</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gridParams</span><span class="o">.</span><span class="n">bounds</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">bound</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>
                        <span class="n">thisGroup</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;bounds_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ibound</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">bound</span><span class="p">)</span>

                <span class="n">thisGroup</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                    <span class="s2">&quot;unitStepLimits&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gridParams</span><span class="o">.</span><span class="n">unitStepLimits</span>
                <span class="p">)</span>

                <span class="n">offset</span> <span class="o">=</span> <span class="n">gridParams</span><span class="o">.</span><span class="n">offset</span>
                <span class="n">thisGroup</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">thisGroup</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
                <span class="n">thisGroup</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;geomType&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gridParams</span><span class="o">.</span><span class="n">geomType</span><span class="p">)</span>
                <span class="n">thisGroup</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;symmetry&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gridParams</span><span class="o">.</span><span class="n">symmetry</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to create datasets in: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h5group</span><span class="p">))</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="Layout.computeAncestors"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.Layout.computeAncestors">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">computeAncestors</span><span class="p">(</span><span class="n">serialNum</span><span class="p">,</span> <span class="n">numChildren</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list containing the serial number of the parent corresponding to each</span>
<span class="sd">        object at the given depth.</span>

<span class="sd">        Depth in this case means how many layers to reach up to find the desired</span>
<span class="sd">        ancestor. A depth of 1 will yield the direct parent of each element, depth of 2</span>
<span class="sd">        would yield the elemen&#39;s parent&#39;s parent, and so on.</span>

<span class="sd">        The zero-th element will always be None, as the first object is the root element</span>
<span class="sd">        and so has no parent. Subsequent depths will result in more Nones.</span>

<span class="sd">        This function is useful for forming a lightweight sense of how the database</span>
<span class="sd">        contents stitch together, without having to go to the trouble of fully unpacking</span>
<span class="sd">        the Reactor model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        serialNum : List of int</span>
<span class="sd">            List of serial numbers for each object/element, as laid out in Layout</span>
<span class="sd">        numChildren : List of int</span>
<span class="sd">            List of numbers of children for each object/element, as laid out in Layout</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This is not using a recursive approach for a couple of reasons. First, the</span>
<span class="sd">        iterative form isn&#39;t so bad; we just need two stacks. Second, the interface of</span>
<span class="sd">        the recursive function would be pretty unwieldy. We are progressively</span>
<span class="sd">        consuming two lists, of which we would need to keep passing down with an</span>
<span class="sd">        index/cursor, or progressively slice them as we go, which would be pretty</span>
<span class="sd">        inefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ancestors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="n">snStack</span> <span class="o">=</span> <span class="p">[</span><span class="n">serialNum</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">ncStack</span> <span class="o">=</span> <span class="p">[</span><span class="n">numChildren</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">sn</span><span class="p">,</span> <span class="n">nc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">serialNum</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">numChildren</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">ncStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">nc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">snStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span>
                <span class="n">ncStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">while</span> <span class="n">ncStack</span> <span class="ow">and</span> <span class="n">ncStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">snStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">ncStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># handle deeper scenarios. This is a bit tricky. Store the original</span>
            <span class="c1"># ancestors for the first generation, since that ultimately contains all of</span>
            <span class="c1"># the information that we need. Then in a loop, keep hopping one more layer</span>
            <span class="c1"># of indirection, and indexing into the corresponding locaition in the</span>
            <span class="c1"># original ancestor array</span>
            <span class="n">indexMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">sn</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">serialNum</span><span class="p">)}</span>
            <span class="n">origAncestors</span> <span class="o">=</span> <span class="n">ancestors</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">ancestors</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">origAncestors</span><span class="p">[</span><span class="n">indexMap</span><span class="p">[</span><span class="n">ia</span><span class="p">]]</span> <span class="k">if</span> <span class="n">ia</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">ia</span> <span class="ow">in</span> <span class="n">ancestors</span>
                <span class="p">]</span>

        <span class="k">return</span> <span class="n">ancestors</span></div></div>


<div class="viewcode-block" id="allSubclasses"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.allSubclasses">[docs]</a><span class="k">def</span> <span class="nf">allSubclasses</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This currently include Materials... and it should not.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
        <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">allSubclasses</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
    <span class="p">)</span></div>


<span class="c1"># TODO: This will likely become an issue with extensibility via plugins. There are a</span>
<span class="c1"># couple of options to resolve this:</span>
<span class="c1"># - Perform this operation each time we make a Layout. Wasteful, but robust</span>
<span class="c1"># - Scrape all of these names off of a set of Composites that register with a base</span>
<span class="c1">#   metaclass. Less wasteful, but probably equally robust. Downside is it&#39;s metaclassy</span>
<span class="c1">#   and Madjickal.</span>
<span class="n">GRID_CLASSES</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">allSubclasses</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">Grid</span><span class="p">)}</span>
<span class="n">GRID_CLASSES</span><span class="p">[</span><span class="s2">&quot;Grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">Grid</span>


<span class="n">NONE_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="nb">float</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">:</span> <span class="s2">&quot;&lt;!None!&gt;&quot;</span><span class="p">}</span>

<span class="c1"># XXX: we&#39;re going to assume no one assigns min(int)+2 as a meaningful value</span>
<span class="n">NONE_MAP</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">intType</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">intType</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">intType</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">NONE_MAP</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">intType</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">intType</span><span class="p">)</span><span class="o">.</span><span class="n">max</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">intType</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">NONE_MAP</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">floatType</span><span class="p">:</span> <span class="n">floatType</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">floatType</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)})</span>


<div class="viewcode-block" id="packSpecialData"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.packSpecialData">[docs]</a><span class="k">def</span> <span class="nf">packSpecialData</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">paramName</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduce data that wouldn&#39;t otherwise play nicely with HDF5/numpy arrays to a format</span>
<span class="sd">    that will.</span>

<span class="sd">    This is the main entry point for conforming &quot;strange&quot; data into something that will</span>
<span class="sd">    both fit into a numpy array/HDF5 dataset, and be recoverable to its original-ish</span>
<span class="sd">    state when reading it back in. This is accomplished by detecting a handful of known</span>
<span class="sd">    offenders and using various HDF5 attributes to store necessary auxiliary data. It is</span>
<span class="sd">    important to keep in mind that the data that is passed in has already been converted</span>
<span class="sd">    to a numpy array, so the top dimension is always representing the collection of</span>
<span class="sd">    composites that are storing the parameters. For instance, if we are dealing with a</span>
<span class="sd">    Block parameter, the first index in the numpy array of data is the block index; so</span>
<span class="sd">    if each block has a parameter that is a dictionary, ``data`` would be a ndarray,</span>
<span class="sd">    where each element is a dictionary. This routine supports a number of different</span>
<span class="sd">    &quot;strange&quot; things:</span>

<span class="sd">    * Dict[str, float]: These are stored by finding the set of all keys for all</span>
<span class="sd">      instances, and storing those keys as a list in an attribute. The data themselves</span>
<span class="sd">      are stored as arrays indexed by object, then key index. Dictionaries lacking data</span>
<span class="sd">      for a key store a nan in it&#39;s place. This will work well in instances where most</span>
<span class="sd">      objects have data for most keys.</span>
<span class="sd">    * Jagged arrays: These are stored by concatenating all of the data into a single,</span>
<span class="sd">      one-dimensional array, and storing attributes to describe the shapes of each</span>
<span class="sd">      object&#39;s data, and an offset into the beginning of each object&#39;s data.</span>
<span class="sd">    * Arrays with ``None`` in them: These are stored by replacing each instance of</span>
<span class="sd">      ``None`` with a magical value that shouldn&#39;t be encountered in realistic</span>
<span class="sd">      scenarios.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        An ndarray storing the data that we want to stuff into the database. These are</span>
<span class="sd">        usually dtype=Object, which is how we usually end up here in the first place.</span>

<span class="sd">    paramName</span>
<span class="sd">        The parameter name that we are trying to store data for. This is mostly used for</span>
<span class="sd">        diagnostics.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    unpackSpecialData</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check to make sure that we even need to do this. If the numpy data type is</span>
    <span class="c1"># not &quot;O&quot;, chances are we have nice, clean data.</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="p">{}</span>

    <span class="n">attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="c1"># make a copy of the data, so that the original is unchanged</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># find locations of Nones. The below works for ndarrays, whereas `data == None`</span>
    <span class="c1"># gives a single True/False value</span>
    <span class="n">nones</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nones</span><span class="p">)</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># Everything is None, so why bother?</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attrs</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;nones&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># XXX: this whole if/then/elif/else can be optimized by looping once and then</span>
    <span class="c1">#      determining the correct action</span>
    <span class="c1"># A robust solution would need</span>
    <span class="c1"># to do this on a case-by-case basis, and re-do it any time we want to</span>
    <span class="c1"># write, since circumstances may change. Not only that, but we may need</span>
    <span class="c1"># to do perform more that one of these operations to get to an array</span>
    <span class="c1"># that we want to put in the database.</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># we&#39;re assuming that a dict is {str: float}. We store the union of</span>
        <span class="c1"># all of the keys for all of the objects as a special &quot;keys&quot;</span>
        <span class="c1"># attribute, and store a value for all of those keys for all</span>
        <span class="c1"># objects, whether or not there is actually data associated with</span>
        <span class="c1"># that key (storing a nan when no data). This makes for a simple</span>
        <span class="c1"># approach that is somewhat digestible just looking at the db, and</span>
        <span class="c1"># should be quite efficient in the case where most objects have data</span>
        <span class="c1"># for most keys.</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">k</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">})</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
            <span class="c1"># The data themselves are nasty. We could support this, but best to wait for</span>
            <span class="c1"># a credible use case.</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to coerce dictionary data into usable numpy array for &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">attrs</span>

    <span class="c1"># conform non-numpy arrays to numpy</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># looks like 1-D plain-old-data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonesWithNonsense</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">nones</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">attrs</span>

    <span class="c1"># check if data is jagged</span>
    <span class="n">candidate</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">isJagged</span> <span class="o">=</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shape</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">candidate</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">isJagged</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">val</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">ndim</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Inconsistent dimensions in jagged array for: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Dimensions: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">paramName</span><span class="p">,</span> <span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">ndim</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;jagged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># offsets[i] is the index of the zero-th element of sub-array i</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
            <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># shapes[i] is the shape of the i-th sub-array. Nones are represented by all</span>
        <span class="c1"># zeros</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ndim</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nones</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;offsets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsets</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;shapes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapes</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;noneLocations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nones</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">attrs</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonesWithNonsense</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">nones</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">attrs</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nones</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot write </span><span class="si">{}</span><span class="s2"> to the database, it did not resolve to a numpy/HDF5 &quot;</span>
            <span class="s2">&quot;type.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Data unable to find special none value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Failed to process special data for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramName</span><span class="p">))</span></div>


<div class="viewcode-block" id="unpackSpecialData"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.unpackSpecialData">[docs]</a><span class="k">def</span> <span class="nf">unpackSpecialData</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">paramName</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract data from a specially-formatted HDF5 dataset into a numpy array.</span>

<span class="sd">    This should invert the operations performed by :py:func:`packSpecialData`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        Specially-formatted data array straight from the database.</span>

<span class="sd">    attrs</span>
<span class="sd">        The attributes associated with the dataset that contained the data.</span>

<span class="sd">    paramName</span>
<span class="sd">        The name of the parameter that is being unpacked. Only used for diagnostics.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        An ndarray containing the closest possible representation of the data that was</span>
<span class="sd">        originally written to the database.</span>


<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    packSpecialData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;specialFormatting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># The data were not subjected to any special formatting; short circuit.</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;O&quot;</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="n">unpackedData</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nones&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jagged&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">replaceNonsenseWithNones</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jagged&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;offsets&quot;</span><span class="p">]</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;shapes&quot;</span><span class="p">]</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">emptyArray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">ndim</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">unpackedJaggedData</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="n">ndim</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,):</span>
                <span class="c1"># Start with an empty array. This may be replaced with a None later</span>
                <span class="n">unpackedJaggedData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">emptyArray</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unpackedJaggedData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">:])</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;noneLocations&quot;</span><span class="p">]:</span>
            <span class="n">unpackedJaggedData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unpackedJaggedData</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">])</span>
        <span class="n">unpackedData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">unpackedData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unpackedData</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;Do not recognize the type of special formatting that was applied &quot;</span>
        <span class="s2">&quot;to </span><span class="si">{}</span><span class="s2">. Attrs: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="replaceNonsenseWithNones"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.replaceNonsenseWithNones">[docs]</a><span class="k">def</span> <span class="nf">replaceNonsenseWithNones</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">paramName</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace special nonsense values with ``None``.</span>

<span class="sd">    This essentially reverses the operations performed by</span>
<span class="sd">    :py:func:`replaceNonesWithNonsense`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        The array from the database that contains special ``None`` nonsense values.</span>

<span class="sd">    paramName</span>
<span class="sd">        The param name who&#39;s data we are dealing with. Only used for diagnostics.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    replaceNonesWithNonsense</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: This is super closely-related to the NONE_MAP collection, and should</span>
    <span class="c1"># probably use it somehow.</span>
    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
        <span class="n">isNone</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
        <span class="n">isNone</span> <span class="o">=</span> <span class="n">data</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">str_</span><span class="p">):</span>
        <span class="n">isNone</span> <span class="o">=</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;&lt;!None!&gt;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Unable to resolve values that should be None for `</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">isNone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">isNone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="c1"># TODO: This is not symmetric with the replaceNonesWithNonsense impl.</span>
                <span class="c1"># That one assumes that Nones apply only at the highest dimension, and</span>
                <span class="c1"># that the lower dimensions will be filled with the magic None value.</span>
                <span class="c1"># Non-none entries below the top level fail to coerce to a serializable</span>
                <span class="c1"># numpy array and would raise an exception when trying to write. TL;DR:</span>
                <span class="c1"># this is a dead branch until the replaceNonesWithNonsense impl is more</span>
                <span class="c1"># sophisticated.</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">))</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">isNone</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">))</span>
        <span class="n">result</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">result</span><span class="p">[</span><span class="n">isNone</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="replaceNonesWithNonsense"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.replaceNonesWithNonsense">[docs]</a><span class="k">def</span> <span class="nf">replaceNonesWithNonsense</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">paramName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nones</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace instances of ``None`` with nonsense values that can be detected/recovered</span>
<span class="sd">    when reading.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        The numpy array containing ``None`` values that need to be replaced.</span>

<span class="sd">    paramName</span>
<span class="sd">        The name of the parameter who&#39;s data we are treating. Only used for diagnostics.</span>

<span class="sd">    nones</span>
<span class="sd">        An array containing the index locations on the ``None`` elements. It is a little</span>
<span class="sd">        strange to pass these, in but we find these indices to determine whether we need</span>
<span class="sd">        to call this function in the first place, so might as well pass it in, so that</span>
<span class="sd">        we don&#39;t need to perform the operation again.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This only supports situations where the data is a straight-up ``None``, or a valid,</span>
<span class="sd">    database-storable numpy array (or easily convertable to one (e.g. tuples/lists with</span>
<span class="sd">    numerical values)). This does not support, for instance, a numpy ndarray with some</span>
<span class="sd">    Nones in it.</span>

<span class="sd">    For example, the following is supported::</span>

<span class="sd">        [[1, 2, 3], None, [7, 8, 9]]</span>

<span class="sd">    However, the following is not::</span>

<span class="sd">        [[1, 2, 3], [4, None, 6], [7, 8, 9]]</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    replaceNonsenseWithNones</span>
<span class="sd">        Reverses this operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nones</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nones</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># loop to find what the default value should be. This is the first non-None</span>
        <span class="c1"># value that we can find.</span>
        <span class="n">defaultValue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">realType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="c1"># if multi-dimensional, val[0] could still be an array, val.flat is</span>
                <span class="c1"># a flattened iterator, so next(val.flat) gives the first value in</span>
                <span class="c1"># an n-dimensional array</span>
                <span class="n">realType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">flat</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">realType</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">defaultValue</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">NONE_MAP</span><span class="p">[</span><span class="n">realType</span><span class="p">],</span> <span class="n">val</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span>
                <span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">realType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">realType</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">defaultValue</span> <span class="o">=</span> <span class="n">NONE_MAP</span><span class="p">[</span><span class="n">realType</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Couldn&#39;t find any non-None entries, so it really doesn&#39;t matter what type we</span>
            <span class="c1"># use. Using float, because NaN is nice.</span>
            <span class="n">realType</span> <span class="o">=</span> <span class="nb">float</span>
            <span class="n">defaultValue</span> <span class="o">=</span> <span class="n">NONE_MAP</span><span class="p">[</span><span class="n">realType</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">defaultValue</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nones</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultValue</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Error while attempting to determine default for </span><span class="si">{}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">value: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">paramName</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ee</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Could not determine None replacement for </span><span class="si">{}</span><span class="s2"> with type </span><span class="si">{}</span><span class="s2">, val </span><span class="si">{}</span><span class="s2">, default </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">paramName</span><span class="p">,</span> <span class="n">realType</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">defaultValue</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">realType</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Could not coerce data for </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">, data:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">paramName</span><span class="p">,</span> <span class="n">realType</span><span class="p">,</span> <span class="n">data</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Failed to convert data to valid HDF5 type </span><span class="si">{}</span><span class="s2">, data:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">paramName</span><span class="p">,</span> <span class="n">data</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<span class="k">def</span> <span class="nf">_writeAttrs</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle safely writing attributes to a dataset, handling large data if necessary.</span>

<span class="sd">    This will attempt to store attributes directly onto an HDF5 object if possible,</span>
<span class="sd">    falling back to proper datasets and reference attributes if necessary. This is</span>
<span class="sd">    needed because HDF5 tries to fit attributes into the object header, which has</span>
<span class="sd">    limited space. If an attribute is too large, h5py raises a RuntimeError.</span>
<span class="sd">    In such cases, this will store the attribute data in a proper dataset and</span>
<span class="sd">    place a reference to that dataset in the attribute instead.</span>

<span class="sd">    In practice, this takes ``linkedDims`` attrs from a particular component type (like</span>
<span class="sd">    ``c00n00/Circle/id``) and stores them in new datasets (like</span>
<span class="sd">    ``c00n00/attrs/1_linkedDims``, ``c00n00/attrs/2_linkedDims``) and then sets the</span>
<span class="sd">    object&#39;s attrs to links to those datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;object header message is too large&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span>

            <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Storing attribute `</span><span class="si">{}</span><span class="s2">` for `</span><span class="si">{}</span><span class="s2">` into it&#39;s own dataset within &quot;</span>
                <span class="s2">&quot;`</span><span class="si">{}</span><span class="s2">/attrs`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;attrs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">attrGroup</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attrGroup</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span>
            <span class="n">dataName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">attrGroup</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">key</span>
            <span class="n">attrGroup</span><span class="p">[</span><span class="n">dataName</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># using a soft link here allows us to cheaply copy time nodes without</span>
            <span class="c1"># needing to crawl through and update object references.</span>
            <span class="n">linkName</span> <span class="o">=</span> <span class="n">attrGroup</span><span class="p">[</span><span class="n">dataName</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">linkName</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_resolveAttrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reverse the action of _writeAttrs.</span>

<span class="sd">    This reads actual attrs and looks for the real data</span>
<span class="sd">    in the datasets that the attrs were pointing to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolved</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5r</span><span class="o">.</span><span class="n">Reference</span><span class="p">):</span>
                <span class="c1"># Old style object reference. If this cannot be dereferenced, it is</span>
                <span class="c1"># likely because mergeHistory was used to get the current database,</span>
                <span class="c1"># which does not preserve references.</span>
                <span class="n">resolved</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">ATTR_LINK</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="c1"># dereference the path to get the data out of the dataset.</span>
                    <span class="n">resolved</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)][()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resolved</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolved</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HDF error loading </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="se">\n</span><span class="s2">Group: </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="k">return</span> <span class="n">resolved</span>


<div class="viewcode-block" id="collectBlockNumberDensities"><a class="viewcode-back" href="../../../../.apidocs/armi.bookkeeping.db.database3.html#armi.bookkeeping.db.collectBlockNumberDensities">[docs]</a><span class="k">def</span> <span class="nf">collectBlockNumberDensities</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect block-by-block homogenized number densities for each nuclide.</span>

<span class="sd">    Long ago, composition was stored on block params. No longer; they are on the</span>
<span class="sd">    component numberDensity params. These block-level params, are still useful to see</span>
<span class="sd">    compositions in some visualization tools. Rather than keep them on the reactor</span>
<span class="sd">    model, we dynamically compute them here and slap them in the database. These are</span>
<span class="sd">    ignored upon reading and will not affect the results.</span>

<span class="sd">    Remove this once a better viz tool can view composition distributions. Also remove</span>
<span class="sd">    the try/except in ``_readParams``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nucNames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nucName</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span> <span class="k">for</span> <span class="n">nucName</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">getNuclides</span><span class="p">())))</span>
    <span class="n">nucBases</span> <span class="o">=</span> <span class="p">[</span><span class="n">nuclideBases</span><span class="o">.</span><span class="n">byName</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span> <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">nucNames</span><span class="p">]</span>
    <span class="c1"># it&#39;s faster to loop over blocks first and get all number densities from each</span>
    <span class="c1"># than it is to get one nuclide at a time from each block because of area fraction</span>
    <span class="c1"># calculations. So we use some RAM here instead.</span>
    <span class="n">nucDensityMatrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
        <span class="n">nucDensityMatrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">getNuclideNumberDensities</span><span class="p">(</span><span class="n">nucNames</span><span class="p">))</span>
    <span class="n">nucDensityMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nucDensityMatrix</span><span class="p">)</span>

    <span class="n">dataDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ni</span><span class="p">,</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nucBases</span><span class="p">):</span>
        <span class="c1"># the nth column is a vector of nuclide densities for this nuclide across all blocks</span>
        <span class="n">dataDict</span><span class="p">[</span><span class="n">nb</span><span class="o">.</span><span class="n">getDatabaseName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">nucDensityMatrix</span><span class="p">[:,</span> <span class="n">ni</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dataDict</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2009-2022, TerraPower, LLC.
      <span class="lastupdated">
        Last updated on 2022-04-04.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>