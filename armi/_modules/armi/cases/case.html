

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>armi.cases.case &mdash; ARMI 0.2.7 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_fixes.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/armiicon_16x16.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="../../../_static/assets/jsonview.bundle.js"></script>
        <script src="../../../_static/assets/jsonview_loader.js"></script>
        <script src="../../../_static/sphinx-needs/libs/html/datatables.min.js"></script>
        <script src="../../../_static/sphinx-needs/libs/html/datatables_loader.js"></script>
        <script src="../../../_static/sphinx-needs/libs/html/sphinx_needs_collapse.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #233C5B" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ARMI
          

          
            
            <img src="../../../_static/armiicon_24x24.ico" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.2.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index.html">User Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../requirements/index.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../.apidocs/modules.html">API Docs</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ARMI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../armi.html">armi</a> &raquo;</li>
        
      <li>armi.cases.case</li>
    
    
  <li class="wy-breadcrumbs-aside">
    
  </li>

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for armi.cases.case</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2019 TerraPower, LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The ``Case`` object is responsible for running, and executing a set of user inputs.  Many</span>
<span class="sd">entry points redirect into ``Case`` methods, such as ``clone``, ``compare``, and ``run``.</span>

<span class="sd">The ``Case`` object provides an abstraction around ARMI inputs to allow for manipulation and</span>
<span class="sd">collection of cases.</span>

<span class="sd">See Also</span>
<span class="sd">--------</span>
<span class="sd">armi.cases.suite : A collection of Cases</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">pstats</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">trace</span>

<span class="kn">import</span> <span class="nn">coverage</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">tabulate</span>

<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">getPluginManager</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">interfaces</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">operators</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">runLog</span>
<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">armi.bookkeeping.db</span> <span class="kn">import</span> <span class="n">compareDatabases</span>
<span class="kn">from</span> <span class="nn">armi.cli</span> <span class="kn">import</span> <span class="n">reportsEntryPoint</span>
<span class="kn">from</span> <span class="nn">armi.nucDirectory</span> <span class="kn">import</span> <span class="n">nuclideBases</span>
<span class="kn">from</span> <span class="nn">armi.physics.neutronics.settings</span> <span class="kn">import</span> <span class="n">CONF_LOADING_FILE</span>
<span class="kn">from</span> <span class="nn">armi.reactor</span> <span class="kn">import</span> <span class="n">blueprints</span>
<span class="kn">from</span> <span class="nn">armi.reactor</span> <span class="kn">import</span> <span class="n">reactors</span>
<span class="kn">from</span> <span class="nn">armi.reactor</span> <span class="kn">import</span> <span class="n">systemLayoutInput</span>
<span class="kn">from</span> <span class="nn">armi.utils</span> <span class="kn">import</span> <span class="n">pathTools</span>
<span class="kn">from</span> <span class="nn">armi.utils</span> <span class="kn">import</span> <span class="n">textProcessors</span>
<span class="kn">from</span> <span class="nn">armi.utils.customExceptions</span> <span class="kn">import</span> <span class="n">NonexistentSetting</span>
<span class="kn">from</span> <span class="nn">armi.utils.directoryChangers</span> <span class="kn">import</span> <span class="n">DirectoryChanger</span>
<span class="kn">from</span> <span class="nn">armi.utils.directoryChangers</span> <span class="kn">import</span> <span class="n">ForcedCreationDirectoryChanger</span>

<span class="c1"># change from default .coverage to help with Windows dotfile issues.</span>
<span class="c1"># Must correspond with data_file entry in `coveragerc`!</span>
<span class="n">COVERAGE_RESULTS_FILE</span> <span class="o">=</span> <span class="s2">&quot;coverage_results.cov&quot;</span>


<div class="viewcode-block" id="Case"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case">[docs]</a><span class="k">class</span> <span class="nc">Case</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ARMI Case that can be used for suite set up and post-analysis.</span>

<span class="sd">    A Case is capable of loading inputs, checking that they are valid, and</span>
<span class="sd">    initializing a reactor model. Cases can also compare against other</span>
<span class="sd">    cases and be collected into multiple :py:class:`armi.cases.suite.CaseSuite`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">caseSuite</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a Case from user input.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cs : CaseSettings</span>
<span class="sd">            CaseSettings for this Case</span>

<span class="sd">        caseSuite : CaseSuite, optional</span>
<span class="sd">            CaseSuite this particular case belongs. Passing this in allows dependency</span>
<span class="sd">            tracking across the other cases (e.g. if one case uses the output of</span>
<span class="sd">            another as input, as happens in in-use testing for reactivity coefficient</span>
<span class="sd">            snapshot testing or more complex analysis sequences).</span>

<span class="sd">        bp : Blueprints, optional</span>
<span class="sd">            :py:class:`armi.reactor.blueprints.Blueprints` object containing the assembly</span>
<span class="sd">            definitions and other information. If not supplied, it will be loaded from the</span>
<span class="sd">            ``cs`` as needed.</span>

<span class="sd">        geom : SystemLayoutInput, optional</span>
<span class="sd">            SystemLayoutInput for this case. If not supplied, it will be loaded from the ``cs`` as</span>
<span class="sd">            needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caseSuite</span> <span class="o">=</span> <span class="n">caseSuite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Case</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># set the signal if the user passes in a blueprint object, instead of a file</span>
        <span class="k">if</span> <span class="n">bp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">filelessBP</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># NOTE: in order to prevent slow submission times for loading massively large</span>
        <span class="c1"># blueprints (e.g. certain computer-generated input files),</span>
        <span class="c1"># self.bp and self.geom can be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">bp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span> <span class="o">=</span> <span class="n">geom</span>

        <span class="c1"># this is used in parameter sweeps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_independentVariables</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">independentVariables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get dictionary of independent variables and their values.</span>

<span class="sd">        This unpacks independent variables from the cs object&#39;s independentVariables</span>
<span class="sd">        setting the first time it is run. This is used in parameter sweeps.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        writeInputs : writes the ``independentVariabls`` setting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_independentVariables</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">indepStr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;independentVariables&quot;</span><span class="p">]:</span>
                <span class="n">indepName</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">indepStr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_independentVariables</span><span class="p">[</span><span class="n">indepName</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_independentVariables</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Case cs: </span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Blueprint object for this case.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This property allows lazy loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">blueprints</span><span class="o">.</span><span class="n">loadFromCs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="n">roundTrip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bp</span>

    <span class="nd">@bp</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">bp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">bp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Geometry object for this Case.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This property allows lazy loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span> <span class="o">=</span> <span class="n">systemLayoutInput</span><span class="o">.</span><span class="n">SystemLayoutInput</span><span class="o">.</span><span class="n">loadFromCs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span>

    <span class="nd">@geom</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">geom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span> <span class="o">=</span> <span class="n">geom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of parent Case objects.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is performed on demand so that if someone changes the underlying Settings, the case</span>
<span class="sd">        will reflect the correct dependencies. As a result, if this is being done iteratively,</span>
<span class="sd">        you may want to cache it somehow (in a dict?).</span>

<span class="sd">        Ideally, this should not be the responsibility of the Case, but rather the suite!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caseSuite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="n">getPluginManager</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pluginDependencies</span> <span class="ow">in</span> <span class="n">pm</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">defineCaseDependencies</span><span class="p">(</span>
                    <span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">suite</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseSuite</span>
                <span class="p">):</span>
                    <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pluginDependencies</span><span class="p">)</span>

            <span class="c1"># the ([^\/]) capture basically gets the file name portion and excludes any</span>
            <span class="c1"># directory separator</span>
            <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getPotentialParentFromSettingValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;explicitRepeatShuffles&quot;</span><span class="p">],</span>
                    <span class="sa">r</span><span class="s2">&quot;^(?P&lt;dirName&gt;.*[\/</span><span class="se">\\</span><span class="s2">])?(?P&lt;title&gt;[^\/</span><span class="se">\\</span><span class="s2">]+)-SHUFFLES\.txt$&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># ensure that a case doesn&#39;t appear to be its own dependency</span>
        <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">)</span>
        <span class="n">dependencies</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dependencies</span>

<div class="viewcode-block" id="Case.addExplicitDependency"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.addExplicitDependency">[docs]</a>    <span class="k">def</span> <span class="nf">addExplicitDependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register an explicit dependency.</span>

<span class="sd">        When evaluating the ``dependency`` property, dynamic dependencies are probed</span>
<span class="sd">        using the current case settings and plugin hooks. Sometimes, it is necessary to</span>
<span class="sd">        impose dependencies that are not expressed through settings and hooks. This</span>
<span class="sd">        method stores another case as an explicit dependency, which will be included</span>
<span class="sd">        with the other, implicitly discovered, dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The case </span><span class="si">{}</span><span class="s2"> is already explicity specified as a dependency of &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">case</span><span class="p">)</span></div>

<div class="viewcode-block" id="Case.getPotentialParentFromSettingValue"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.getPotentialParentFromSettingValue">[docs]</a>    <span class="k">def</span> <span class="nf">getPotentialParentFromSettingValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settingValue</span><span class="p">,</span> <span class="n">filePattern</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a parent case based on a setting value and a pattern.</span>

<span class="sd">        This is a convenient way for a plugin to express a dependency. It uses the</span>
<span class="sd">        ``match.groupdict`` functionality to pull the directory and case name out of a</span>
<span class="sd">        specific setting value an regular expression.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        settingValue : str</span>
<span class="sd">            A particular setting value that might contain a reference to an input that</span>
<span class="sd">            is produced by a dependency.</span>
<span class="sd">        filePattern : str</span>
<span class="sd">            A regular expression for extracting the location and name of the dependency.</span>
<span class="sd">            If the ``settingValue`` matches the passed pattern, this function will</span>
<span class="sd">            attempt to extract the ``dirName`` and ``title`` groups to find the</span>
<span class="sd">            dependency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filePattern</span><span class="p">,</span> <span class="n">settingValue</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPotentialDependencies</span><span class="p">(</span><span class="o">**</span><span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">())</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Found more than one case matching </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settingValue</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">deps</span></div>

    <span class="k">def</span> <span class="nf">_getPotentialDependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirName</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a parent case based on a directory and case title.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">dirName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dirName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">dirName</span><span class="p">):</span>
            <span class="n">dirName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">dirName</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">caseMatches</span><span class="p">(</span><span class="n">case</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">title</span><span class="p">)</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">directory</span><span class="p">))</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">case</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caseSuite</span> <span class="k">if</span> <span class="n">caseMatches</span><span class="p">(</span><span class="n">case</span><span class="p">)}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The case title.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span>

    <span class="nd">@title</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dbName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The case output database name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.h5&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The working directory of the case.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">that</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compares two cases to determine if they are equivalent by looking at the ``title`` and</span>
<span class="sd">        ``directory``.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        No other attributes except those stated above are used for the comparison; the above stated</span>
<span class="sd">        attributes can be considered the &quot;primary key&quot; for a Case object and identify it as being</span>
<span class="sd">        unique. Both of these comparisons are simple string comparisons, so a reference and an</span>
<span class="sd">        absolute path to the same case would be considered different.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="n">that</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">==</span> <span class="n">that</span><span class="o">.</span><span class="n">directory</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># computes the hash of a Case object. This is required in Python3 when __eq__ has been</span>
        <span class="c1"># defined.  take the hash of the tuple of the &quot;primary key&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">))</span>

<div class="viewcode-block" id="Case.setUpTaskDependence"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.setUpTaskDependence">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTaskDependence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the task dependence based on the :code:`dependencies`.</span>

<span class="sd">        This accounts for whether or not the dependency is enabled.</span>

<span class="sd">        TODO</span>
<span class="sd">        ----</span>
<span class="sd">        This is a leftover from before the release of the ARMI framework. The API of the</span>
<span class="sd">        proprietary cluster communication library is being used here. This should either</span>
<span class="sd">        be moved out into the cluster plugin, or the library should be made available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dependency</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_parent</span><span class="p">(</span><span class="n">dependency</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Case.run"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run an ARMI case.</span>

<span class="sd">        This initializes an ``Operator``, a ``Reactor`` and invokes</span>
<span class="sd">        :py:meth:`Operator.operate`!</span>

<span class="sd">        It also activates supervisory things like code coverage checking, profiling,</span>
<span class="sd">        or tracing, if requested by users during debugging.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Room for improvement: The coverage, profiling, etc. stuff can probably be moved</span>
<span class="sd">        out of here to a more elegant place (like a context manager?).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start the log here so that the verbosities for the head and workers</span>
        <span class="c1"># can be configured based on the user settings for the rest of the run</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">startLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_RANK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">setVerbosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;verbosity&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">setVerbosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;branchVerbosity&quot;</span><span class="p">])</span>

        <span class="c1"># if in the settings, start the coverage and profiling</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startCoverage</span><span class="p">()</span>
        <span class="n">profiler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startProfiling</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkInputs</span><span class="p">()</span>
        <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initializeOperator</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">o</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;trace&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_RANK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># only trace primary node.</span>
                <span class="n">tracer</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">ignoredirs</span><span class="o">=</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exec_prefix</span><span class="p">],</span> <span class="n">trace</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tracer</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s2">&quot;o.operate()&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">operate</span><span class="p">()</span>

        <span class="c1"># if in the settings, report the coverage and profiling</span>
        <span class="n">Case</span><span class="o">.</span><span class="n">_endCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;coverageConfigFile&quot;</span><span class="p">],</span> <span class="n">cov</span><span class="p">)</span>
        <span class="n">Case</span><span class="o">.</span><span class="n">_endProfiling</span><span class="p">(</span><span class="n">profiler</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_startCoverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to the Case.run(): spin up the code coverage tooling,</span>
<span class="sd">        if the CaseSettings file says to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        coverage.Coverage</span>
<span class="sd">            Coverage object for pytest or unittest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;coverage&quot;</span><span class="p">]:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">coverage</span><span class="o">.</span><span class="n">Coverage</span><span class="p">(</span>
                <span class="n">config_file</span><span class="o">=</span><span class="n">Case</span><span class="o">.</span><span class="n">_getCoverageRcFile</span><span class="p">(</span>
                    <span class="n">userCovFile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;coverageConfigFile&quot;</span><span class="p">],</span> <span class="n">makeCopy</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">),</span>
                <span class="n">debug</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dataio&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_SIZE</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># interestingly, you cannot set the parallel flag in the constructor</span>
                <span class="c1"># without auto-specifying the data suffix. This should enable</span>
                <span class="c1"># parallel coverage with auto-generated data file suffixes and</span>
                <span class="c1"># combinations.</span>
                <span class="n">cov</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cov</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_endCoverage</span><span class="p">(</span><span class="n">userCovFile</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to the Case.run(): stop and report code coverage,</span>
<span class="sd">        if the CaseSettings file says to.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        userCovFile : str</span>
<span class="sd">            File path to user-supplied coverage configuration file (default setting is</span>
<span class="sd">            empty string)</span>
<span class="sd">        cov: coverage.Coverage (optional)</span>
<span class="sd">            Hopefully, a valid and non-empty set of coverage data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">cov</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">cov</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_SIZE</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">MPI_COMM</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>  <span class="c1"># force waiting for everyone to finish</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_RANK</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_SIZE</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># combine all the parallel coverage data files into one and make</span>
            <span class="c1"># the XML and HTML reports for the whole run.</span>
            <span class="n">combinedCoverage</span> <span class="o">=</span> <span class="n">coverage</span><span class="o">.</span><span class="n">Coverage</span><span class="p">(</span>
                <span class="n">config_file</span><span class="o">=</span><span class="n">Case</span><span class="o">.</span><span class="n">_getCoverageRcFile</span><span class="p">(</span><span class="n">userCovFile</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dataio&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">combinedCoverage</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># combine does delete the files it merges</span>
            <span class="n">combinedCoverage</span><span class="o">.</span><span class="n">combine</span><span class="p">()</span>
            <span class="n">combinedCoverage</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">combinedCoverage</span><span class="o">.</span><span class="n">html_report</span><span class="p">()</span>
            <span class="n">combinedCoverage</span><span class="o">.</span><span class="n">xml_report</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_getCoverageRcFile</span><span class="p">(</span><span class="n">userCovFile</span><span class="p">,</span> <span class="n">makeCopy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to provide the coverage configuration file according to the OS. A</span>
<span class="sd">        user-supplied file will take precedence, and is not checked for a dot-filename.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        userCovFile : str</span>
<span class="sd">            File path to user-supplied coverage configuration file (default setting is</span>
<span class="sd">            empty string)</span>
<span class="sd">        makeCopy : bool (optional)</span>
<span class="sd">            Whether or not to copy the coverage config file to an alternate file path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        covFile : str</span>
<span class="sd">            path of coveragerc file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># User-defined file takes precedence.</span>
        <span class="k">if</span> <span class="n">userCovFile</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">userCovFile</span><span class="p">)</span>

        <span class="n">covRcDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">PROJECT_ROOT</span><span class="p">)</span>
        <span class="n">covFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">covRcDir</span><span class="p">,</span> <span class="s2">&quot;.coveragerc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
            <span class="n">covFileWin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">covRcDir</span><span class="p">,</span> <span class="s2">&quot;coveragerc&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">makeCopy</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Make a copy of the file without the dot in the name</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">covFile</span><span class="p">,</span> <span class="n">covFileWin</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">covFileWin</span>
        <span class="k">return</span> <span class="n">covFile</span>

    <span class="k">def</span> <span class="nf">_startProfiling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to the Case.run(): start the Python profiling,</span>
<span class="sd">        if the CaseSettings file says to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cProfile.Profile</span>
<span class="sd">            Standard Python profiling object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profiler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">]:</span>
            <span class="n">profiler</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
            <span class="n">profiler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">subcalls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">builtins</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">profiler</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_endProfiling</span><span class="p">(</span><span class="n">profiler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to the Case.run(): stop and report python profiling,</span>
<span class="sd">        if the CaseSettings file says to.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profiler: cProfile.Profile (optional)</span>
<span class="sd">            Hopefully, a valid and non-empty set of profiling data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">profiler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">profiler</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
        <span class="n">profiler</span><span class="o">.</span><span class="n">dump_stats</span><span class="p">(</span><span class="s2">&quot;profiler.</span><span class="si">{:0&gt;3}</span><span class="s2">.stats&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">MPI_RANK</span><span class="p">))</span>
        <span class="n">statsStream</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">profiler</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">statsStream</span><span class="p">)</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s2">&quot;cumulative&quot;</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_SIZE</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_COMM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">allStats</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_COMM</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">statsStream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_RANK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">statsString</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allStats</span><span class="p">):</span>
                    <span class="c1"># using print statements because the logger has been turned off</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:^100}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="s2">&quot; Profiler statistics for RANK=</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">statsString</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">statsStream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

<div class="viewcode-block" id="Case.initializeOperator"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.initializeOperator">[docs]</a>    <span class="k">def</span> <span class="nf">initializeOperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates and returns an Operator.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">DirectoryChanger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="n">dumpOnException</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initBurnChain</span><span class="p">()</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">operators</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">reactors</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="p">)</span>
            <span class="n">o</span><span class="o">.</span><span class="n">initializeInterfaces</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="c1"># Set this here to make sure the full duration of initialization is properly captured.</span>
            <span class="c1"># Cannot be done in reactors since the above self.bp call implicitly initializes blueprints.</span>
            <span class="n">r</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">timeOfStart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startTime</span>
            <span class="k">return</span> <span class="n">o</span></div>

    <span class="k">def</span> <span class="nf">_initBurnChain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the burn chain setting to the nucDir.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is admittedly an odd place for this but the burn chain info must be</span>
<span class="sd">        applied sometime after user-input has been loaded (for custom burn chains)</span>
<span class="sd">        but not long after (because nucDir is framework-level and expected to be</span>
<span class="sd">        up-to-date by lots of modules).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;initializeBurnChain&quot;</span><span class="p">]:</span>
            <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Skipping burn-chain initialization since `initializeBurnChain` setting is disabled.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;burnChainFileName&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The burn-chain file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;burnChainFileName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> does not exist. The &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;data cannot be loaded. Fix this path or disable burn-chain initialization using &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the `initializeBurnChain` setting.&quot;</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;burnChainFileName&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">burnChainStream</span><span class="p">:</span>
            <span class="n">nuclideBases</span><span class="o">.</span><span class="n">imposeBurnChain</span><span class="p">(</span><span class="n">burnChainStream</span><span class="p">)</span>

<div class="viewcode-block" id="Case.checkInputs"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.checkInputs">[docs]</a>    <span class="k">def</span> <span class="nf">checkInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks ARMI inputs for consistency.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the inputs are all good, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;=========== Settings Validation Checks ===========&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">DirectoryChanger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="n">dumpOnException</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">operatorClass</span> <span class="o">=</span> <span class="n">operators</span><span class="o">.</span><span class="n">getOperatorClassFromSettings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
            <span class="n">inspector</span> <span class="o">=</span> <span class="n">operatorClass</span><span class="o">.</span><span class="n">inspector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span>
            <span class="n">inspectorIssues</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span> <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">inspector</span><span class="o">.</span><span class="n">queries</span> <span class="k">if</span> <span class="n">query</span><span class="p">]</span>

            <span class="c1"># Write out the settings validation issues that will be prompted for</span>
            <span class="c1"># resolution if in an interactive session or forced to be resolved</span>
            <span class="c1"># otherwise.</span>
            <span class="n">queryData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inspectorIssues</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">queryData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span>
                        <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span>
                            <span class="n">query</span><span class="o">.</span><span class="n">statement</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">break_long_words</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">),</span>
                        <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">question</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">break_long_words</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">queryData</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">MPI_RANK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span>
                        <span class="n">queryData</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Statement&quot;</span><span class="p">,</span> <span class="s2">&quot;Question&quot;</span><span class="p">],</span>
                        <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;armi&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">CURRENT_MODE</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">INTERACTIVE</span><span class="p">:</span>
                <span class="c1"># if interactive, ask user to deal with settings issues</span>
                <span class="n">inspector</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

            <span class="k">return</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">inspectorIssues</span><span class="p">)</span></div>

<div class="viewcode-block" id="Case.summarizeDesign"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.summarizeDesign">[docs]</a>    <span class="k">def</span> <span class="nf">summarizeDesign</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Uses the ReportInterface to create a fancy HTML page describing the design inputs.&quot;&quot;&quot;</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">reportsEntryPoint</span><span class="o">.</span><span class="n">createReportFromSettings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Case.buildCommand"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.buildCommand">[docs]</a>    <span class="k">def</span> <span class="nf">buildCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">python</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an execution command for running or submitting a job.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        python : str, optional</span>
<span class="sd">            The path to the python executable to use for executing the case. By default</span>
<span class="sd">            this will be whatever &quot;python&quot; resolves to in the target environment.</span>
<span class="sd">            However when running in more exotic environments (e.g. HPC cluster), it is</span>
<span class="sd">            usually desireable to provide a specific python executable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;numProcessors&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot;mpiexec -n </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;numProcessors&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;mpiTasksPerNode&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot;-c </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;mpiTasksPerNode&quot;</span><span class="p">])</span>

        <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> -u &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">python</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot; -O &quot;</span>

        <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39; -m </span><span class="si">{}</span><span class="s1"> run &quot;</span><span class="si">{}</span><span class="s1">.yaml&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">caseTitle</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="Case.clone"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">additionalFiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">modifiedSettings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">writeStyle</span><span class="o">=</span><span class="s2">&quot;short&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clone existing ARMI inputs to current directory with optional settings modifications.</span>

<span class="sd">        Since each case depends on multiple inputs, this is a safer way to move cases</span>
<span class="sd">        around without having to wonder if you copied all the files appropriately.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        additionalFiles : list (optional)</span>
<span class="sd">            additional file paths to copy to cloned case</span>
<span class="sd">        title : str (optional)</span>
<span class="sd">            title of new case</span>
<span class="sd">        modifiedSettings : dict (optional)</span>
<span class="sd">            settings to set/modify before creating the cloned case</span>
<span class="sd">        writeStyle : str (optional)</span>
<span class="sd">            Writing style for which settings get written back to the settings files</span>
<span class="sd">            (short, medium, or full).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the source and destination are the same</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cloneCS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">modifiedSettings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cloneCS</span> <span class="o">=</span> <span class="n">cloneCS</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">newSettings</span><span class="o">=</span><span class="n">modifiedSettings</span><span class="p">)</span>

        <span class="n">clone</span> <span class="o">=</span> <span class="n">Case</span><span class="p">(</span><span class="n">cloneCS</span><span class="p">)</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">pathTools</span><span class="o">.</span><span class="n">armiAbsPath</span><span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span>

        <span class="k">if</span> <span class="n">pathTools</span><span class="o">.</span><span class="n">armiAbsPath</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="n">pathTools</span><span class="o">.</span><span class="n">armiAbsPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;The source file and destination file are the same: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Cannot use armi-clone to modify armi settings file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pathTools</span><span class="o">.</span><span class="n">armiAbsPath</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">newSettings</span> <span class="o">=</span> <span class="n">copyInterfaceInputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">)</span>
        <span class="n">newCs</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">newSettings</span><span class="o">=</span><span class="n">newSettings</span><span class="p">)</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">newCs</span>

        <span class="n">runLog</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="s2">&quot;writing settings file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">writeToYamlFile</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">writeStyle</span><span class="p">,</span> <span class="n">fromFile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="s2">&quot;finished writing </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="p">))</span>

        <span class="n">fromPath</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">pathTools</span><span class="o">.</span><span class="n">armiAbsPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">inputFileSetting</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CONF_LOADING_FILE</span><span class="p">,</span> <span class="s2">&quot;geomFile&quot;</span><span class="p">]:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">inputFileSetting</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span>
                    <span class="n">inputFileSetting</span><span class="p">,</span>
                    <span class="n">fromPath</span><span class="p">(</span><span class="n">fileName</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="n">fileName</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">runLog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;skipping </span><span class="si">{}</span><span class="s2">, there is no file specified&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inputFileSetting</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_LOADING_FILE</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># The root for handling YAML includes is relative to the YAML file, not the</span>
            <span class="c1"># settings file</span>
            <span class="n">root</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_LOADING_FILE</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span>
            <span class="p">)</span>
            <span class="n">cloneRoot</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">CONF_LOADING_FILE</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">includePath</span><span class="p">,</span> <span class="n">mark</span> <span class="ow">in</span> <span class="n">textProcessors</span><span class="o">.</span><span class="n">findYamlInclusions</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">includePath</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                    <span class="n">includeSrc</span> <span class="o">=</span> <span class="n">root</span> <span class="o">/</span> <span class="n">includePath</span>
                    <span class="n">includeDest</span> <span class="o">=</span> <span class="n">cloneRoot</span> <span class="o">/</span> <span class="n">includePath</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># don&#39;t bother copying absolute files</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">includeSrc</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                        <span class="s2">&quot;The input file file `</span><span class="si">{}</span><span class="s2">` referenced at </span><span class="si">{}</span><span class="s2"> does not exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">includeSrc</span><span class="p">,</span> <span class="n">mark</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span>
                    <span class="s2">&quot;auxiliary input file `</span><span class="si">{}</span><span class="s2">` referenced at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">includeSrc</span><span class="p">,</span> <span class="n">mark</span>
                    <span class="p">),</span>
                    <span class="n">includeSrc</span><span class="p">,</span>
                    <span class="n">includeDest</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">additionalFiles</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span>
                <span class="s2">&quot;additional file&quot;</span><span class="p">,</span> <span class="n">fromPath</span><span class="p">(</span><span class="n">fileName</span><span class="p">),</span> <span class="n">clone</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">clone</span></div>

<div class="viewcode-block" id="Case.compare"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">that</span><span class="p">,</span>
        <span class="n">exclusion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">timestepCompare</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the output databases from two run cases. Return number of differences.</span>

<span class="sd">        This is useful both for in-use testing and engineering analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Comparing the following databases:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;REF: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;SRC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbName</span><span class="p">,</span> <span class="n">that</span><span class="o">.</span><span class="n">dbName</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">diffResults</span> <span class="o">=</span> <span class="n">compareDatabases</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbName</span><span class="p">,</span>
            <span class="n">that</span><span class="o">.</span><span class="n">dbName</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
            <span class="n">exclusions</span><span class="o">=</span><span class="n">exclusion</span><span class="p">,</span>
            <span class="n">timestepCompare</span><span class="o">=</span><span class="n">timestepCompare</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">diffResults</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">diffResults</span><span class="o">.</span><span class="n">nDiffs</span><span class="p">()</span>

        <span class="n">sameOrDifferent</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;different&quot;</span>
            <span class="k">if</span> <span class="n">diffResults</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">diffResults</span><span class="o">.</span><span class="n">nDiffs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="s2">&quot;the same&quot;</span>
        <span class="p">)</span>
        <span class="n">runLog</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="s2">&quot;Cases are </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sameOrDifferent</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span></div>

<div class="viewcode-block" id="Case.writeInputs"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.Case.writeInputs">[docs]</a>    <span class="k">def</span> <span class="nf">writeInputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sourceDir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">writeStyle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;short&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the inputs to disk.</span>

<span class="sd">        This allows input objects that have been modified in memory (e.g.</span>
<span class="sd">        for a parameter sweep or migration) to be written out as input</span>
<span class="sd">        for a forthcoming case.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sourceDir : str (optional)</span>
<span class="sd">            The path to copy inputs from (if different from the cs.path). Needed</span>
<span class="sd">            in SuiteBuilder cases to find the baseline inputs from plugins (e.g. shuffleLogic)</span>
<span class="sd">        writeStyle : str (optional)</span>
<span class="sd">            Writing style for which settings get written back to the settings files</span>
<span class="sd">            (short, medium, or full).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This will rename the ``loadingFile`` and ``geomFile`` to be ``title-blueprints + &#39;.yaml&#39;`` and</span>
<span class="sd">        ``title + &#39;-geom.yaml&#39;`` respectively.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        independentVariables</span>
<span class="sd">            parses/reads the independentVariables setting</span>

<span class="sd">        clone</span>
<span class="sd">            Similar to this but doesn&#39;t let you write out new/modified</span>
<span class="sd">            geometry or blueprints objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ForcedCreationDirectoryChanger</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="n">dumpOnException</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>
            <span class="c1"># trick: these seemingly no-ops load the bp and geom via properties if</span>
            <span class="c1"># they are not yet initialized.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geom</span>

            <span class="n">newSettings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">newSettings</span><span class="p">[</span><span class="n">CONF_LOADING_FILE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;-blueprints.yaml&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">:</span>
                <span class="n">newSettings</span><span class="p">[</span><span class="s2">&quot;geomFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;-geom.yaml&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">writeGeom</span><span class="p">(</span><span class="n">newSettings</span><span class="p">[</span><span class="s2">&quot;geomFile&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">independentVariables</span><span class="p">:</span>
                <span class="n">newSettings</span><span class="p">[</span><span class="s2">&quot;independentVariables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">varName</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">varName</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">independentVariables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">]</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newSettings</span><span class="p">[</span><span class="n">CONF_LOADING_FILE</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">loadingFile</span><span class="p">:</span>
                <span class="n">blueprints</span><span class="o">.</span><span class="n">Blueprints</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="p">,</span> <span class="n">loadingFile</span><span class="p">)</span>

            <span class="c1"># copy input files from other modules/plugins</span>
            <span class="n">interfaceSettings</span> <span class="o">=</span> <span class="n">copyInterfaceInputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">sourceDir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">settingName</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">interfaceSettings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">newSettings</span><span class="p">[</span><span class="n">settingName</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">newSettings</span><span class="o">=</span><span class="n">newSettings</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sourceDir</span><span class="p">:</span>
                <span class="n">fromPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fromPath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">writeToYamlFile</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">writeStyle</span><span class="p">,</span> <span class="n">fromFile</span><span class="o">=</span><span class="n">fromPath</span>
            <span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_copyInputsHelper</span><span class="p">(</span>
    <span class="n">fileDescription</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sourcePath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">destPath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">origFile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for copyInterfaceInputs: Creates an absolute file path, and</span>
<span class="sd">    copies the file to that location. If that file path does not exist, returns</span>
<span class="sd">    the file path from the original settings file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileDescription : str</span>
<span class="sd">        A file description for the copyOrWarn method</span>
<span class="sd">    sourcePath : str</span>
<span class="sd">        The absolute file path of the file to copy</span>
<span class="sd">    destPath : str</span>
<span class="sd">        The target directory to copy input files to</span>
<span class="sd">    origFile : str</span>
<span class="sd">        File path as defined in the original settings file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    destFilePath (or origFile) : str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sourceName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sourcePath</span><span class="p">)</span>
    <span class="n">destFilePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destPath</span><span class="p">,</span> <span class="n">sourceName</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pathTools</span><span class="o">.</span><span class="n">copyOrWarn</span><span class="p">(</span><span class="n">fileDescription</span><span class="p">,</span> <span class="n">sourcePath</span><span class="p">,</span> <span class="n">destFilePath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">destFilePath</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">destFilePath</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">origFile</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">origFile</span>


<div class="viewcode-block" id="copyInterfaceInputs"><a class="viewcode-back" href="../../../.apidocs/armi.cases.case.html#armi.cases.case.copyInterfaceInputs">[docs]</a><span class="k">def</span> <span class="nf">copyInterfaceInputs</span><span class="p">(</span>
    <span class="n">cs</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sourceDir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ping active interfaces to determine which files are considered &quot;input&quot;. This</span>
<span class="sd">    enables developers to add new inputs in a plugin-dependent/ modular way.</span>

<span class="sd">    This function should now be able to handle the updating of:</span>
<span class="sd">      - a single file (relative or absolute)</span>
<span class="sd">      - a list of files (relative or absolute), and</span>
<span class="sd">      - a file entry that has a wildcard processing into multiple files.</span>
<span class="sd">        Glob is used to offer support for wildcards.</span>

<span class="sd">    If the file paths are absolute, do nothing. The case will be able to find the file.</span>

<span class="sd">    In case suites or parameter sweeps, these files often have a sourceDir associated</span>
<span class="sd">    with them that is different from the cs.inputDirectory. So, if relative or wildcard,</span>
<span class="sd">    update the file paths to be absolute in the case settings and copy the file to the</span>
<span class="sd">    destination directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cs : CaseSettings</span>
<span class="sd">        The source case settings to find input files</span>
<span class="sd">    destination : str</span>
<span class="sd">        The target directory to copy input files to</span>
<span class="sd">    sourceDir : str (optional)</span>
<span class="sd">        The directory from which to copy files. Defaults to cs.inputDirectory</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    newSettings : dict</span>
<span class="sd">        A new settings object that contains settings for the keys and values that are</span>
<span class="sd">        either an absolute file path, a list of absolute file paths, or the original</span>
<span class="sd">        file path if absolute paths could not be resolved</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Regarding the handling of relative file paths: In the future this could be</span>
<span class="sd">    simplified by adding a concept for a suite root directory, below which it is safe</span>
<span class="sd">    to copy files without needing to update settings that point with a relative path</span>
<span class="sd">    to files that are below it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">activeInterfaces</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">getActiveInterfaceInfo</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
    <span class="n">sourceDir</span> <span class="o">=</span> <span class="n">sourceDir</span> <span class="ow">or</span> <span class="n">cs</span><span class="o">.</span><span class="n">inputDirectory</span>
    <span class="n">sourceDirPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>

    <span class="n">newSettings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">klass</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">activeInterfaces</span><span class="p">:</span>
        <span class="n">interfaceFileNames</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">specifyInputs</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">interfaceFileNames</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">Setting</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">getSetting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">NonexistentSetting</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is not a valid setting. Ensure the relevant specifyInputs &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;method uses a correct setting name.&quot;</span>
                    <span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">name</span>

            <span class="n">newFiles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">WILDCARD</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">RELATIVE</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">WILDCARD</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s2">&quot;..&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">RELATIVE</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">WILDCARD</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">RELATIVE</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">()</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                            <span class="c1"># Path is absolute, no settings modification or filecopy needed</span>
                            <span class="n">newFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="c1"># Attempt to construct an absolute file path</span>
                <span class="n">sourceFullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sourceDirPath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">WILDCARD</span><span class="p">:</span>
                    <span class="n">globFilePaths</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sourceDirPath</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sourceFullPath</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">globFilePaths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">destFilePath</span> <span class="o">=</span> <span class="n">f</span>
                        <span class="n">newFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">destFilePath</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">gFile</span> <span class="ow">in</span> <span class="n">globFilePaths</span><span class="p">:</span>
                            <span class="n">destFilePath</span> <span class="o">=</span> <span class="n">_copyInputsHelper</span><span class="p">(</span>
                                <span class="n">label</span><span class="p">,</span> <span class="n">gFile</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">f</span>
                            <span class="p">)</span>
                            <span class="n">newFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">destFilePath</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">destFilePath</span> <span class="o">=</span> <span class="n">_copyInputsHelper</span><span class="p">(</span>
                        <span class="n">label</span><span class="p">,</span> <span class="n">sourceFullPath</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">f</span>
                    <span class="p">)</span>
                    <span class="n">newFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">destFilePath</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">destFilePath</span> <span class="o">==</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">runLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No input files for `</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">` setting could be resolved with &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;the following path: `</span><span class="si">{</span><span class="n">sourceFullPath</span><span class="si">}</span><span class="s2">`. Will not update &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">`.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Some settings are a single filename. Others are lists of files. Make</span>
            <span class="c1"># sure we are returning what the setting expects</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">WILDCARD</span><span class="p">:</span>
                <span class="n">newSettings</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">newFiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newSettings</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">newFiles</span>
    <span class="k">return</span> <span class="n">newSettings</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2009-2023, TerraPower, LLC.
      <span class="lastupdated">
        Last updated on 2023-06-20.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>