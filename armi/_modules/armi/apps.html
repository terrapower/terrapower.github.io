<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>armi.apps &mdash; ARMI 0.4.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme_fixes.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/armiicon_16x16.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #233C5B" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ARMI
              <img src="../../_static/armiicon_24x24.ico" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">User Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../.apidocs/modules.html">API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #233C5B" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ARMI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../armi.html">armi</a></li>
      <li class="breadcrumb-item active">armi.apps</li>
  <li class="wy-breadcrumbs-aside">
    
  </li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for armi.apps</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2019 TerraPower, LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The base ARMI App class.</span>

<span class="sd">This module defines the :py:class:`App` class, which is used to configure the ARMI</span>
<span class="sd">Framework for a specific application. An ``App`` implements a simple interface for</span>
<span class="sd">customizing much of the Framework&#39;s behavior.</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">Historical Fun Fact</span>

<span class="sd">This pattern is used by many frameworks as a way of encapsulating what would otherwise be global</span>
<span class="sd">state. The ARMI Framework has historically made heavy use of global state (e.g.,</span>
<span class="sd">:py:mod:`armi.nucDirectory.nuclideBases`), and it will take quite a bit of effort to refactor the</span>
<span class="sd">code to access such things through an App object.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># ruff: noqa: E402</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">context</span><span class="p">,</span> <span class="n">plugins</span><span class="p">,</span> <span class="n">pluginManager</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">armi.reactor</span> <span class="kn">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">armi.reactor.flags</span> <span class="kn">import</span> <span class="n">Flags</span>
<span class="kn">from</span> <span class="nn">armi.settings</span> <span class="kn">import</span> <span class="n">fwSettings</span>
<span class="kn">from</span> <span class="nn">armi.settings</span> <span class="kn">import</span> <span class="n">Setting</span>


<div class="viewcode-block" id="App"><a class="viewcode-back" href="../../.apidocs/armi.apps.html#armi.apps.App">[docs]</a><span class="k">class</span> <span class="nc">App</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The highest-level of abstraction for defining what happens during an ARMI run.</span>

<span class="sd">    .. impl:: An App has a plugin manager.</span>
<span class="sd">        :id: I_ARMI_APP_PLUGINS</span>
<span class="sd">        :implements: R_ARMI_APP_PLUGINS</span>

<span class="sd">        The App class is intended to be subclassed in order to customize the functionality</span>
<span class="sd">        and look-and-feel of the ARMI Framework for a specific use case. An App contains a</span>
<span class="sd">        plugin manager, which should be populated in ``__init__()`` with a collection of</span>
<span class="sd">        plugins that are deemed suitable for a given application, as well as other methods</span>
<span class="sd">        which provide further customization.</span>

<span class="sd">        The base App class is also a good place to expose some more convenient ways to get</span>
<span class="sd">        data out of the Plugin API; calling the ``pluggy`` hooks directly can sometimes be a</span>
<span class="sd">        pain, as the results returned by the individual plugins may need to be merged and/or</span>
<span class="sd">        checked for errors. Adding that logic here reduces boilerplate throughout the rest</span>
<span class="sd">        of the code.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;armi&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The program name of the app. This should be the actual name of the python entry</span>
<span class="sd">    point that loads the app, or the name of the module that contains the appropriate</span>
<span class="sd">    __main__ function. For example, if the app is expected to be invoked with ``python</span>
<span class="sd">    -m myapp``, ``name`` should be ``&quot;myapp&quot;``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This mostly initializes the default plugin manager. Subclasses are free to adopt</span>
<span class="sd">        this plugin manager and register more plugins of their own, or to throw it away</span>
<span class="sd">        and start from scratch if they do not wish to use the default Framework plugins.</span>

<span class="sd">        For a description of the things that an ARMI plugin can do, see the</span>
<span class="sd">        :py:mod:`armi.plugins` module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pluginFlagsRegistered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pluginManager</span><span class="o">.</span><span class="n">ArmiPluginManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramRenames</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initNewPlugins</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__initNewPlugins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">cli</span>
        <span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">bookkeeping</span>
        <span class="kn">from</span> <span class="nn">armi.physics</span> <span class="kn">import</span> <span class="n">fuelCycle</span>
        <span class="kn">from</span> <span class="nn">armi.physics</span> <span class="kn">import</span> <span class="n">fuelPerformance</span>
        <span class="kn">from</span> <span class="nn">armi.physics</span> <span class="kn">import</span> <span class="n">neutronics</span>
        <span class="kn">from</span> <span class="nn">armi.physics</span> <span class="kn">import</span> <span class="n">safety</span>
        <span class="kn">from</span> <span class="nn">armi.physics</span> <span class="kn">import</span> <span class="n">thermalHydraulics</span>
        <span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">reactor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span> <span class="o">=</span> <span class="n">plugins</span><span class="o">.</span><span class="n">getNewPluginManager</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">cli</span><span class="o">.</span><span class="n">EntryPointsPlugin</span><span class="p">,</span>
            <span class="n">bookkeeping</span><span class="o">.</span><span class="n">BookkeepingPlugin</span><span class="p">,</span>
            <span class="n">fuelCycle</span><span class="o">.</span><span class="n">FuelHandlerPlugin</span><span class="p">,</span>
            <span class="n">fuelPerformance</span><span class="o">.</span><span class="n">FuelPerformancePlugin</span><span class="p">,</span>
            <span class="n">neutronics</span><span class="o">.</span><span class="n">NeutronicsPlugin</span><span class="p">,</span>
            <span class="n">safety</span><span class="o">.</span><span class="n">SafetyPlugin</span><span class="p">,</span>
            <span class="n">thermalHydraulics</span><span class="o">.</span><span class="n">ThermalHydraulicsPlugin</span><span class="p">,</span>
            <span class="n">reactor</span><span class="o">.</span><span class="n">ReactorPlugin</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_paramRenames</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grab the version of this app (defaults to ARMI version).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is designed to be over-ridable by Application developers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">meta</span><span class="o">.</span><span class="n">__version__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pluginManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pluginManager</span><span class="o">.</span><span class="n">ArmiPluginManager</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the App&#39;s PluginManager.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span>

<div class="viewcode-block" id="App.getSettings"><a class="viewcode-back" href="../../.apidocs/armi.apps.html#armi.apps.App.getSettings">[docs]</a>    <span class="k">def</span> <span class="nf">getSettings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Setting</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary containing all Settings defined by the framework and all plugins.</span>

<span class="sd">        .. impl:: Applications will not allow duplicate settings.</span>
<span class="sd">            :id: I_ARMI_SETTINGS_UNIQUE</span>
<span class="sd">            :implements: R_ARMI_SETTINGS_UNIQUE</span>

<span class="sd">            Each ARMI application includes a collection of Plugins. Among other</span>
<span class="sd">            things, these plugins can register new settings in addition to</span>
<span class="sd">            the default settings that come with ARMI. This feature provides a</span>
<span class="sd">            lot of utility, so application developers can easily configure</span>
<span class="sd">            their ARMI appliction in customizable ways.</span>

<span class="sd">            However, it would get confusing if two different plugins registered</span>
<span class="sd">            a setting with the same name string. Or if a plugin registered a</span>
<span class="sd">            setting with the same name as an ARMI default setting. So this</span>
<span class="sd">            method throws an error if such a situation arises.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start with framework settings</span>
        <span class="n">settingDefs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">setting</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">setting</span> <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">fwSettings</span><span class="o">.</span><span class="n">getFrameworkSettings</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># The optionsCache stores options that may have come from a plugin before the</span>
        <span class="c1"># setting to which they apply. Whenever a new setting is added, we check to see</span>
        <span class="c1"># if there are any options in the cache, popping them out and adding them to the</span>
        <span class="c1"># setting.  If all plugins&#39; settings have been processed and the cache is not</span>
        <span class="c1"># empty, that&#39;s an error, because a plugin must have provided options to a</span>
        <span class="c1"># setting that doesn&#39;t exist.</span>
        <span class="n">optionsCache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">Option</span><span class="p">]]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">defaultsCache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">Default</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">pluginSettings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">defineSettings</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">pluginSetting</span> <span class="ow">in</span> <span class="n">pluginSettings</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pluginSetting</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">Setting</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">pluginSetting</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">settingDefs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The setting </span><span class="si">{</span><span class="n">pluginSetting</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;already exists and cannot be redefined.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">settingDefs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pluginSetting</span>
                    <span class="c1"># handle when new setting has modifier in the cache (modifier loaded first)</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">optionsCache</span><span class="p">:</span>
                        <span class="n">settingDefs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">addOptions</span><span class="p">(</span><span class="n">optionsCache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">defaultsCache</span><span class="p">:</span>
                        <span class="n">settingDefs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">changeDefault</span><span class="p">(</span><span class="n">defaultsCache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pluginSetting</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">Option</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pluginSetting</span><span class="o">.</span><span class="n">settingName</span> <span class="ow">in</span> <span class="n">settingDefs</span><span class="p">:</span>
                        <span class="c1"># modifier loaded after setting, so just apply it (no cache needed)</span>
                        <span class="n">settingDefs</span><span class="p">[</span><span class="n">pluginSetting</span><span class="o">.</span><span class="n">settingName</span><span class="p">]</span><span class="o">.</span><span class="n">addOption</span><span class="p">(</span><span class="n">pluginSetting</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># no setting yet, cache it and apply when it arrives</span>
                        <span class="n">optionsCache</span><span class="p">[</span><span class="n">pluginSetting</span><span class="o">.</span><span class="n">settingName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pluginSetting</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pluginSetting</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">Default</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pluginSetting</span><span class="o">.</span><span class="n">settingName</span> <span class="ow">in</span> <span class="n">settingDefs</span><span class="p">:</span>
                        <span class="c1"># modifier loaded after setting, so just apply it (no cache needed)</span>
                        <span class="n">settingDefs</span><span class="p">[</span><span class="n">pluginSetting</span><span class="o">.</span><span class="n">settingName</span><span class="p">]</span><span class="o">.</span><span class="n">changeDefault</span><span class="p">(</span>
                            <span class="n">pluginSetting</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># no setting yet, cache it and apply when it arrives</span>
                        <span class="n">defaultsCache</span><span class="p">[</span><span class="n">pluginSetting</span><span class="o">.</span><span class="n">settingName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pluginSetting</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;Invalid setting definition found: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">pluginSetting</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">pluginSetting</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">optionsCache</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The following options were provided for settings that do &quot;</span>
                <span class="s2">&quot;not exist. Make sure that the set of active plugins is &quot;</span>
                <span class="s2">&quot;consistent.</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">optionsCache</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">defaultsCache</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The following defaults were provided for settings that do &quot;</span>
                <span class="s2">&quot;not exist. Make sure that the set of active plugins is &quot;</span>
                <span class="s2">&quot;consistent.</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">defaultsCache</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">settingDefs</span></div>

<div class="viewcode-block" id="App.getParamRenames"><a class="viewcode-back" href="../../.apidocs/armi.apps.html#armi.apps.App.getParamRenames">[docs]</a>    <span class="k">def</span> <span class="nf">getParamRenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the parameter renames from all registered plugins.</span>

<span class="sd">        This renders a merged dictionary containing all parameter renames from all of</span>
<span class="sd">        the registered plugins. It also performs simple error checking. The result of</span>
<span class="sd">        this operation is cached, since it is somewhat expensive to perform. If the App</span>
<span class="sd">        detects that its plugin manager&#39;s set of registered plugins has changed, the</span>
<span class="sd">        cache will be invalidated and recomputed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cacheInvalid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramRenames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">renames</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramRenames</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="o">.</span><span class="n">counter</span><span class="p">:</span>
                <span class="n">cacheInvalid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cacheInvalid</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">cacheInvalid</span><span class="p">:</span>
            <span class="n">currentNames</span> <span class="o">=</span> <span class="p">{</span><span class="n">pd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pd</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">ALL_DEFINITIONS</span><span class="p">}</span>

            <span class="n">renames</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pluginRenames</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">defineParameterRenames</span><span class="p">():</span>
                <span class="n">collisions</span> <span class="o">=</span> <span class="n">currentNames</span> <span class="o">&amp;</span> <span class="n">pluginRenames</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">collisions</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">plugins</span><span class="o">.</span><span class="n">PluginError</span><span class="p">(</span>
                        <span class="s2">&quot;The following parameter renames from a plugin collide with &quot;</span>
                        <span class="s2">&quot;currently-defined parameters:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">collisions</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">pluginCollisions</span> <span class="o">=</span> <span class="n">renames</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">pluginRenames</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pluginCollisions</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">plugins</span><span class="o">.</span><span class="n">PluginError</span><span class="p">(</span>
                        <span class="s2">&quot;The following parameter renames are already defined by another &quot;</span>
                        <span class="s2">&quot;plugin:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pluginCollisions</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">renames</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pluginRenames</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_paramRenames</span> <span class="o">=</span> <span class="n">renames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="o">.</span><span class="n">counter</span>
        <span class="k">return</span> <span class="n">renames</span></div>

<div class="viewcode-block" id="App.registerPluginFlags"><a class="viewcode-back" href="../../.apidocs/armi.apps.html#armi.apps.App.registerPluginFlags">[docs]</a>    <span class="k">def</span> <span class="nf">registerPluginFlags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply flags specified in the passed ``PluginManager`` to the ``Flags`` class.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        armi.plugins.ArmiPlugin.defineFlags</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pluginFlagsRegistered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Plugin flags have already been registered. Cannot do it twice!&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">pluginFlags</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">defineFlags</span><span class="p">():</span>
            <span class="n">Flags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pluginFlags</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pluginFlagsRegistered</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="App.registerUserPlugins"><a class="viewcode-back" href="../../.apidocs/armi.apps.html#armi.apps.App.registerUserPlugins">[docs]</a>    <span class="k">def</span> <span class="nf">registerUserPlugins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pluginPaths</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register additional plugins passed in by importable paths.</span>
<span class="sd">        These plugins may be provided e.g. by an application during startup</span>
<span class="sd">        based on user input.</span>

<span class="sd">        Format expected to be a list of full namespaces to plugin classes.</span>
<span class="sd">        There should be a comma between individual plugins and dots representing</span>
<span class="sd">        the file path or importable python namespace.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        importable namespace:</span>
<span class="sd">        ``armi.stuff.plugindir.pluginMod.pluginCls,armi.whatever.plugMod2.plugCls2``</span>

<span class="sd">        or on Linux/Unix:</span>
<span class="sd">        ``/path/to/pluginMod.py:pluginCls,/path/to/plugMod2.py:plugCls2``</span>

<span class="sd">        or on Windows:</span>
<span class="sd">        ``C:\\path\\to\\pluginMod.py:pluginCls,C:\\\\path\\to\\plugMod2.py:plugCls2``</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        These paths are meant to be taken from a settings file, though this method</span>
<span class="sd">        is public. The idea is that these &quot;user plugins&quot; differ from regular plugins</span>
<span class="sd">        because they are defined during run time, not import time. As such, we</span>
<span class="sd">        restrict their flexibility and power as compared to the usual ArmiPlugins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pluginPath</span> <span class="ow">in</span> <span class="n">pluginPaths</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isPluginRegistered</span><span class="p">(</span><span class="n">pluginPath</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;.py:&quot;</span> <span class="ow">in</span> <span class="n">pluginPath</span><span class="p">:</span>
                <span class="c1"># The path is of the form: /path/to/why.py:MyPlugin</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__registerUserPluginsAbsPath</span><span class="p">(</span><span class="n">pluginPath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The path is of the form: armi.thing.what.MyPlugin</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__registerUserPluginsInternalImport</span><span class="p">(</span><span class="n">pluginPath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_isPluginRegistered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pluginPath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the plugin at the provided path is already registered.</span>

<span class="sd">        The expected path formats are:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        importable namespace:</span>
<span class="sd">        ``armi.stuff.plugindir.pluginMod.pluginCls``</span>

<span class="sd">        or on Linux/Unix:</span>
<span class="sd">        ``/path/to/pluginMod.py:pluginCls``</span>

<span class="sd">        or on Windows:</span>
<span class="sd">        ``C:\\path\\to\\pluginMod.py:pluginCls``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pluginPath : str</span>
<span class="sd">            String path to a userPlugin.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether or not the plugin name is already registered with the manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">pluginPath</span><span class="p">:</span>
            <span class="n">pluginName</span> <span class="o">=</span> <span class="n">pluginPath</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pluginName</span> <span class="o">=</span> <span class="n">pluginPath</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="o">.</span><span class="n">has_plugin</span><span class="p">(</span><span class="n">pluginName</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__registerUserPluginsAbsPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pluginPath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to register a single UserPlugin via absolute path.</span>

<span class="sd">        Here the given path is of the form: /path/to/why.py:MyPlugin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">pluginPath</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;.py:&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid plugin path: </span><span class="si">{</span><span class="n">pluginPath</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># split the settings string into file path and class name</span>
        <span class="n">filePath</span><span class="p">,</span> <span class="n">className</span> <span class="o">=</span> <span class="n">pluginPath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.py:&quot;</span><span class="p">)</span>
        <span class="n">filePath</span> <span class="o">+=</span> <span class="s2">&quot;.py&quot;</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">filePath</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="n">plugin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">className</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">plugins</span><span class="o">.</span><span class="n">UserPlugin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>

        <span class="c1"># ensure UserPlugin flags are loaded</span>
        <span class="n">newFlags</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">defineFlags</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">newFlags</span><span class="p">:</span>
            <span class="n">Flags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">newFlags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__registerUserPluginsInternalImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pluginPath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to register a single UserPlugin via internal import.</span>

<span class="sd">        Here the given path is of the form: armi.thing.what.MyPlugin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">pluginPath</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">modPath</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">clsName</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modPath</span><span class="p">)</span>
        <span class="n">plugin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">clsName</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">plugins</span><span class="o">.</span><span class="n">UserPlugin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pm</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>

        <span class="c1"># ensure UserPlugin flags are loaded</span>
        <span class="n">newFlags</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">defineFlags</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">newFlags</span><span class="p">:</span>
            <span class="n">Flags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">newFlags</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">splashText</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a textual splash screen.</span>

<span class="sd">        Specific applications will want to customize this, but by default the ARMI one</span>
<span class="sd">        is produced, with extra data on the App name and version, if available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># typical ARMI splash text</span>
        <span class="n">splash</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">+===================================================+</span>
<span class="s2">|            _      ____     __  __    ___          |</span>
<span class="s2">|           / \    |  _ \   |  \/  |  |_ _|         |</span>
<span class="s2">|          / _ \   | |_) |  | |\/| |   | |          |</span>
<span class="s2">|         / ___ \  |  _ &lt;   | |  | |   | |          |</span>
<span class="s2">|        /_/   \_\ |_| \_\  |_|  |_|  |___|         |</span>
<span class="s2">|        Advanced  Reactor  Modeling Interface      |</span>
<span class="s2">|                                                   |</span>
<span class="s2">|                    version </span><span class="si">{0:10s}</span><span class="s2">             |</span>
<span class="s2">|                                                   |&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">__version__</span>
        <span class="p">)</span>

        <span class="c1"># add the name/version of the current App, if it&#39;s not the default</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">APP_NAME</span> <span class="o">!=</span> <span class="s2">&quot;armi&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">armi</span> <span class="kn">import</span> <span class="n">getApp</span>

            <span class="n">splash</span> <span class="o">+=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">|---------------------------------------------------|</span>
<span class="s2">|   </span><span class="si">{0:&gt;17s}</span><span class="s2"> app version </span><span class="si">{1:10s}</span><span class="s2">        |&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">context</span><span class="o">.</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="n">getApp</span><span class="p">()</span><span class="o">.</span><span class="n">version</span>
            <span class="p">)</span>

        <span class="c1"># bottom border of the splash</span>
        <span class="n">splash</span> <span class="o">+=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">+===================================================+</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">splash</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2009-2024, TerraPower, LLC.
      <span class="lastupdated">Last updated on 2024-08-29.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>